<!doctypehtml><html lang=zh-CN><meta charset=UTF-8><meta content=width=device-width name=viewport><meta content=#222 name=theme-color><meta content="Hexo 6.3.0" name=generator><link href=/images/apple-touch-icon-next.png rel=apple-touch-icon sizes=180x180><link href=/images/favicon-32x32-next.png rel=icon sizes=32x32 type=image/png><link href=/images/favicon-16x16-next.png rel=icon sizes=16x16 type=image/png><link color=#222 href=/images/logo.svg rel=mask-icon><style>:root{--body-bg-color:#f5f7f9;--content-bg-color:#fff;--card-bg-color:#f5f5f5;--text-color:#555;--blockquote-color:#666;--link-color:#555;--link-hover-color:#222;--brand-color:#fff;--brand-hover-color:#fff;--table-row-odd-bg-color:#f9f9f9;--table-row-hover-bg-color:#f5f5f5;--menu-item-bg-color:#f5f5f5;--theme-color:#222;--btn-default-bg:#fff;--btn-default-color:#555;--btn-default-border-color:#555;--btn-default-hover-bg:#222;--btn-default-hover-color:#fff;--btn-default-hover-border-color:#222;--highlight-background:#f3f3f3;--highlight-foreground:#444;--highlight-gutter-background:#e1e1e1;--highlight-gutter-foreground:#555;color-scheme:light}html{line-height:1.15;-webkit-text-size-adjust:100%}details,main{display:block}pre{font-size:1em;overflow:auto;padding:10px;position:relative}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,samp{font-family:monospace,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,input{overflow:visible}button,select{text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:ButtonText dotted 1px}fieldset{padding:.35em .75em .625em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}progress{vertical-align:baseline}.table-container,textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}summary{display:list-item}[hidden],template{display:none}::selection{background:#262a30;color:#eee}body,html{height:100%}body{margin:0;background:var(--body-bg-color);box-sizing:border-box;color:var(--text-color);font-family:EB Garamond,'Noto Serif SC','PingFang SC','Microsoft YaHei',sans-serif;font-size:1em;line-height:2;min-height:100%;position:relative;transition:padding .2s ease-in-out}h1,h2,h3,h4,h5,h6{font-family:EB Garamond,'Noto Serif SC','PingFang SC','Microsoft YaHei',sans-serif;font-weight:700;line-height:1.5;margin:30px 0 15px}h1{font-size:1.5em}h2{font-size:1.375em}h3{font-size:1.25em}h4{font-size:1.125em}h5{font-size:1em}h6{font-size:.875em}p{margin:0 0 20px}a{background:0 0;border-bottom:1px solid #999;color:var(--link-color);cursor:pointer;outline:0;text-decoration:none;overflow-wrap:break-word}a:hover{border-bottom-color:var(--link-hover-color);color:var(--link-hover-color)}embed,iframe,img,video{display:block;margin-left:auto;margin-right:auto;max-width:100%}hr{box-sizing:content-box;overflow:visible;background-image:repeating-linear-gradient(-45deg,#ddd,#ddd 4px,transparent 4px,transparent 8px);border:0;height:3px;margin:40px 0}blockquote{border-left:4px solid #ddd;color:var(--blockquote-color);margin:0;padding:0 15px}blockquote cite::before{content:'-';padding:0 5px}dt{font-weight:700}dd{margin:0;padding:0}table{border-collapse:collapse;border-spacing:0;font-size:.875em;margin:0 0 20px;width:100%}tbody tr:nth-of-type(odd){background:var(--table-row-odd-bg-color)}tbody tr:hover{background:var(--table-row-hover-bg-color)}caption,td,th{padding:8px}td,th{border:1px solid #ddd;border-bottom:3px solid #ddd}th{font-weight:700;padding-bottom:10px}td{border-bottom-width:1px}.btn{background:var(--btn-default-bg);border:2px solid var(--btn-default-border-color);border-radius:2px;color:var(--btn-default-color);display:inline-block;font-size:.875em;line-height:2;padding:0 20px;transition:background-color .2s ease-in-out}.btn:hover{background:var(--btn-default-hover-bg);border-color:var(--btn-default-hover-border-color);color:var(--btn-default-hover-color)}.btn+.btn{margin:0 0 8px 8px}.btn .fa-fw{text-align:left;width:1.285714285714286em}.toggle{line-height:0}.toggle .toggle-line{background:#fff;display:block;height:2px;left:0;position:relative;top:0;transition:.4s;width:100%}.toggle .toggle-line:first-child{margin-top:1px}.toggle .toggle-line:not(:first-child){margin-top:4px}.toggle.toggle-arrow :first-child{left:50%;top:2px;transform:rotate(45deg);width:50%}.toggle.toggle-arrow :last-child{left:50%;top:-2px;transform:rotate(-45deg);width:50%}.toggle.toggle-close :nth-child(2){opacity:0}.toggle.toggle-close :first-child{top:6px;transform:rotate(45deg)}.toggle.toggle-close :last-child{top:-6px;transform:rotate(-45deg)}code[class*=language-],pre[class*=language-]{color:#000;background:0 0;text-shadow:0 1px #fff;font-family:Consolas,Monaco,'Andale Mono','Ubuntu Mono',monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-] ::-moz-selection,code[class*=language-]::-moz-selection,pre[class*=language-] ::-moz-selection,pre[class*=language-]::-moz-selection{text-shadow:none;background:#b3d4fc}code[class*=language-] ::selection,code[class*=language-]::selection,pre[class*=language-] ::selection,pre[class*=language-]::selection{text-shadow:none;background:#b3d4fc}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#f5f2f0}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#999}.token.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#905}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#690}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{color:#9a6e3a;background:hsla(0,0%,100%,.5)}.token.atrule,.token.attr-value,.token.keyword{color:#07a}.token.class-name,.token.function{color:#dd4a68}.token.important,.token.regex,.token.variable{color:#e90}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}pre[class*=language-].line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}pre[class*=language-].line-numbers>code{position:relative;white-space:inherit}.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:0;font-size:100%;left:-3.8em;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.line-numbers-rows>span{display:block;counter-increment:linenumber}.line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.highlight:hover .copy-btn,pre:hover .copy-btn{opacity:1}figure.highlight .table-container{position:relative}.copy-btn{color:#333;cursor:pointer;line-height:1.6;opacity:0;padding:2px 6px;position:absolute;transition:opacity .2s ease-in-out;background-color:#eee;background-image:linear-gradient(#fcfcfc,#eee);border:1px solid #d5d5d5;border-radius:3px;font-size:.8125em;right:4px;top:8px}code,figure.highlight,kbd,pre{background:var(--highlight-background);color:var(--highlight-foreground)}figure.highlight,pre{line-height:1.6;margin:0 auto 20px}figure.highlight figcaption,pre .caption,pre figcaption{background:var(--highlight-gutter-background);color:var(--highlight-foreground);display:flow-root;font-size:.875em;line-height:1.2;padding:.5em}figure.highlight figcaption a,pre .caption a,pre figcaption a{color:var(--highlight-foreground);float:right}figure.highlight figcaption a:hover,pre .caption a:hover,pre figcaption a:hover{border-bottom-color:var(--highlight-foreground)}code,pre{font-family:JetBrains Mono,consolas,Menlo,monospace,'PingFang SC','Microsoft YaHei'}code{border-radius:3px;font-size:.875em;padding:2px 4px;overflow-wrap:break-word}kbd{border:2px solid #ccc;border-radius:.2em;box-shadow:.1em .1em .2em rgba(0,0,0,.1);font-family:inherit;padding:.1em .3em;white-space:nowrap}figure.highlight{overflow:auto;position:relative}figure.highlight pre{border:0;margin:0;padding:10px 0}figure.highlight table{border:0;margin:0;width:auto}figure.highlight td{border:0;padding:0}figure.highlight .gutter{-moz-user-select:none;-ms-user-select:none;-webkit-user-select:none;user-select:none}figure.highlight .gutter pre{background:var(--highlight-gutter-background);color:var(--highlight-gutter-foreground);padding-left:10px;padding-right:10px;text-align:right}figure.highlight .code pre{padding-left:10px;width:100%}figure.highlight .marked{background:rgba(0,0,0,.3)}pre .caption,pre figcaption{margin-bottom:10px}.gist table{width:auto}.gist table td{border:0}pre code{background:0 0;padding:0;text-shadow:none}.blockquote-center{border-left:0;margin:40px 0;padding:0;position:relative;text-align:center}.blockquote-center::after,.blockquote-center::before{left:0;line-height:1;opacity:.6;position:absolute;width:100%}.blockquote-center::before{border-top:1px solid #ccc;text-align:left;top:-20px;content:'\f10d';font-family:'Font Awesome 6 Free';font-weight:900}.blockquote-center::after{border-bottom:1px solid #ccc;bottom:-20px;text-align:right;content:'\f10e';font-family:'Font Awesome 6 Free';font-weight:900}.blockquote-center div,.blockquote-center p{text-align:center}.group-picture{margin-bottom:20px}.group-picture .group-picture-row{display:flex;gap:3px;margin-bottom:3px}.group-picture .group-picture-column{flex:1}.group-picture .group-picture-column img{height:100%;margin:0;object-fit:cover;width:100%}.post-body .label{color:#555;padding:0 2px}.post-body .label.default{background:#f0f0f0}.post-body .label.primary{background:#efe6f7}.post-body .label.info{background:#e5f2f8}.post-body .label.success{background:#e7f4e9}.post-body .label.warning{background:#fcf6e1}.post-body .label.danger{background:#fae8eb}.post-body .link-grid{display:grid;grid-gap:1.5rem;gap:1.5rem;grid-template-columns:1fr 1fr;margin-bottom:20px;padding:1rem}.post-body .link-grid .link-grid-container{border:solid #ddd;box-shadow:1rem 1rem .5rem rgba(0,0,0,.5);min-height:5rem;min-width:0;padding:.5rem;position:relative;transition:background .3s}.post-body .link-grid .link-grid-container:hover{animation:.5s next-shake;background:var(--card-bg-color)}.post-body .link-grid .link-grid-container:active{box-shadow:.5rem .5rem .25rem rgba(0,0,0,.5);transform:translate(.2rem,.2rem)}.post-body .link-grid .link-grid-container .link-grid-image{border:1px solid #ddd;border-radius:50%;box-sizing:border-box;height:5rem;padding:3px;position:absolute;width:5rem}.post-body .link-grid .link-grid-container p{margin:0 1rem 0 6rem}.post-body .link-grid .link-grid-container p:first-of-type{font-size:1.2em}.post-body .link-grid .link-grid-container p:last-of-type{font-size:.8em;line-height:1.3rem;opacity:.7}.post-body .link-grid .link-grid-container a{border:0;height:100%;left:0;position:absolute;top:0;width:100%}@keyframes next-shake{0%{transform:translate(1pt,1pt) rotate(0)}10%{transform:translate(-1pt,-2pt) rotate(-1deg)}20%{transform:translate(-3pt,0) rotate(1deg)}30%{transform:translate(3pt,2pt) rotate(0)}40%{transform:translate(1pt,-1pt) rotate(1deg)}50%{transform:translate(-1pt,2pt) rotate(-1deg)}60%{transform:translate(-3pt,1pt) rotate(0)}70%{transform:translate(3pt,1pt) rotate(-1deg)}80%{transform:translate(-1pt,-1pt) rotate(1deg)}90%{transform:translate(1pt,2pt) rotate(0)}100%{transform:translate(1pt,-2pt) rotate(-1deg)}}.post-body .note{border-radius:3px;margin-bottom:20px;padding:1em;position:relative;border:1px solid #eee;border-left-width:5px}.post-body .note summary{cursor:pointer;outline:0}.post-body .note summary p{display:inline}.post-body .note h2,.post-body .note h3,.post-body .note h4,.post-body .note h5,.post-body .note h6{border-bottom:initial;margin:0;padding-top:0}.post-body .note :first-child{margin-top:0}.post-body .note :last-child{margin-bottom:0}.post-body .note.default{border-left-color:#777}.post-body .note.default h2,.post-body .note.default h3,.post-body .note.default h4,.post-body .note.default h5,.post-body .note.default h6{color:#777}.post-body .note.primary{border-left-color:#6f42c1}.post-body .note.primary h2,.post-body .note.primary h3,.post-body .note.primary h4,.post-body .note.primary h5,.post-body .note.primary h6{color:#6f42c1}.post-body .note.info{border-left-color:#428bca}.post-body .note.info h2,.post-body .note.info h3,.post-body .note.info h4,.post-body .note.info h5,.post-body .note.info h6{color:#428bca}.post-body .note.success{border-left-color:#5cb85c}.post-body .note.success h2,.post-body .note.success h3,.post-body .note.success h4,.post-body .note.success h5,.post-body .note.success h6{color:#5cb85c}.post-body .note.warning{border-left-color:#f0ad4e}.post-body .note.warning h2,.post-body .note.warning h3,.post-body .note.warning h4,.post-body .note.warning h5,.post-body .note.warning h6{color:#f0ad4e}.post-body .note.danger{border-left-color:#d9534f}.post-body .note.danger h2,.post-body .note.danger h3,.post-body .note.danger h4,.post-body .note.danger h5,.post-body .note.danger h6{color:#d9534f}.post-body .tabs{margin-bottom:20px}.post-body .tabs,.tabs-comment{padding-top:10px}.post-body .tabs ul.nav-tabs,.tabs-comment ul.nav-tabs{background:var(--content-bg-color);display:flex;display:flex;flex-wrap:wrap;justify-content:center;margin:0;padding:0;position:-webkit-sticky;position:sticky;top:0;z-index:5}.post-body .tabs ul.nav-tabs li.tab,.tabs-comment ul.nav-tabs li.tab{border-bottom:1px solid #ddd;border-left:1px solid transparent;border-right:1px solid transparent;border-radius:0;border-top:3px solid transparent;flex-grow:1;list-style-type:none}@media (max-width:413px){.post-body .tabs ul.nav-tabs,.tabs-comment ul.nav-tabs{display:block;margin-bottom:5px}.post-body .tabs ul.nav-tabs li.tab,.tabs-comment ul.nav-tabs li.tab{border-bottom:1px solid transparent;border-left:3px solid transparent;border-right:1px solid transparent;border-top:1px solid transparent;border-radius:0}}.post-body .tabs ul.nav-tabs li.tab a,.tabs-comment ul.nav-tabs li.tab a{border-bottom:initial;display:block;line-height:1.8;padding:.25em .75em;text-align:center;transition:.2s ease-out}.post-body .tabs ul.nav-tabs li.tab a i,.tabs-comment ul.nav-tabs li.tab a i{width:1.285714285714286em}.post-body .tabs ul.nav-tabs li.tab.active,.tabs-comment ul.nav-tabs li.tab.active{border-color:#fc6423 #ddd transparent}@media (max-width:413px){.post-body .tabs ul.nav-tabs li.tab.active,.tabs-comment ul.nav-tabs li.tab.active{border-color:#ddd #ddd #ddd #fc6423}}.post-body .tabs ul.nav-tabs li.tab.active a,.tabs-comment ul.nav-tabs li.tab.active a{cursor:default}.post-body .tabs .tab-content,.tabs-comment .tab-content{border:1px solid #ddd;border-radius:0;border-top-color:transparent}@media (max-width:413px){.post-body .tabs .tab-content,.tabs-comment .tab-content{border-radius:0;border-top-color:#ddd}}.post-body .tabs .tab-content .tab-pane,.tabs-comment .tab-content .tab-pane{padding:20px 20px 0}.post-body .tabs .tab-content .tab-pane:not(.active),.tabs-comment .tab-content .tab-pane:not(.active){display:none}.pagination .next,.pagination .page-number,.pagination .prev,.pagination .space{display:inline-block;margin:-1px 10px 0;padding:0 10px}.pagination .page-number.current{background:#ccc;border-color:#ccc;color:var(--content-bg-color)}.pagination{border-top:1px solid #eee;margin:120px 0 0;text-align:center}.pagination .next,.pagination .page-number,.pagination .prev{border-bottom:0;border-top:1px solid #eee;transition:border-color .2s ease-in-out}.pagination .next:hover,.pagination .page-number:hover,.pagination .prev:hover{border-top-color:var(--link-hover-color)}@media (max-width:767px){.post-body .link-grid{grid-template-columns:1fr}.pagination .next,.pagination .page-number,.pagination .prev,.pagination .space{margin:0 5px}.pagination{border-top:0}.pagination .next,.pagination .page-number,.pagination .prev{border-bottom:1px solid #eee;border-top:0}.pagination .next:hover,.pagination .page-number:hover,.pagination .prev:hover{border-bottom-color:var(--link-hover-color)}.site-meta{text-align:center}}.pagination .space{margin:0;padding:0}.comments{margin-top:60px;overflow:hidden}.comment-button-group{display:flex;display:flex;flex-wrap:wrap;justify-content:center;justify-content:center;margin:1em 0}.comment-button-group .comment-button{margin:.1em .2em}.comment-button-group .comment-button.active{background:var(--btn-default-hover-bg);border-color:var(--btn-default-hover-border-color);color:var(--btn-default-hover-color)}.comment-position{display:none}.comment-position.active{display:block}.tabs-comment{margin-top:4em;padding-top:0}.tabs-comment .comments{margin-top:0;padding-top:0}.headband{background:var(--theme-color);height:3px}@media (max-width:991px){.headband{display:none}}.site-brand-container{display:flex;flex-shrink:0;padding:0 10px}.use-motion .column,.use-motion .site-brand-container .toggle{opacity:0}.site-meta{flex-grow:1;text-align:center}.custom-logo-image{margin-top:20px}@media (max-width:991px){.custom-logo-image{display:none}}.brand{border-bottom:0;color:var(--brand-color);display:inline-block;padding:0}.brand:hover{color:var(--brand-hover-color)}.site-title{font-family:Cinzel Decorative,EB Garamond,'Noto Serif SC','PingFang SC','Microsoft YaHei',sans-serif;font-size:1.375em;font-weight:400;line-height:1.5;margin:0}.site-subtitle{color:#ddd;font-size:.8125em;margin:10px 10px 0}.use-motion .custom-logo-image,.use-motion .site-subtitle,.use-motion .site-title{opacity:0;position:relative;top:-10px}.site-nav-right,.site-nav-toggle{display:none}.site-nav-right .toggle,.site-nav-toggle .toggle{color:var(--text-color);padding:10px;width:22px}.site-nav-right .toggle .toggle-line,.site-nav-toggle .toggle .toggle-line{background:var(--text-color);border-radius:1px}@media (max-width:767px){.site-nav-right,.site-nav-toggle{display:flex;flex-direction:column;justify-content:center}.site-nav{--scroll-height:0;height:0;overflow:hidden;transition:height .2s ease-in-out}body:not(.site-nav-on) .site-nav .animated{animation:none}body.site-nav-on .site-nav{height:var(--scroll-height)}}.menu{margin:0;padding:1em 0;text-align:center}.menu-item{display:inline-block;list-style:none;margin:0 10px}@media (max-width:767px){.menu-item{display:block;margin-top:10px}.menu-item.menu-item-search{display:none}}.menu-item a{border-bottom:0;display:block;font-size:.8125em;transition:border-color .2s ease-in-out}.menu-item a.menu-item-active,.menu-item a:hover{background:var(--menu-item-bg-color)}.menu-item .fa,.menu-item .fab,.menu-item .far,.menu-item .fas{margin-right:8px}.menu-item .badge{display:inline-block;font-weight:700;line-height:1;margin-left:.35em;margin-top:.35em;text-align:center;white-space:nowrap}.use-motion .menu-item{visibility:hidden}.sidebar-inner{color:#999;padding:18px 10px;text-align:center;display:flex;flex-direction:column;justify-content:center}.cc-license .cc-opacity{border-bottom:0;opacity:.7}.cc-license .cc-opacity:hover{opacity:.9}.cc-license img{display:inline-block}.site-author-image{border:1px solid #eee;max-width:120px;padding:2px}.site-author-name{color:var(--text-color);font-weight:600;margin:0}.site-description{color:#999;font-size:.8125em;margin-top:0}.links-of-author a{font-size:.8125em}.links-of-author .fa,.links-of-author .fab,.links-of-author .far,.links-of-author .fas{margin-right:2px}.sidebar .sidebar-button:not(:first-child){margin-top:15px}.sidebar .sidebar-button button{background:0 0;cursor:pointer;line-height:2;padding:0 15px;border-radius:4px}.sidebar .sidebar-button button .fa,.sidebar .sidebar-button button .fab,.sidebar .sidebar-button button .far,.sidebar .sidebar-button button .fas{margin-right:5px}.links-of-blogroll{font-size:.8125em}.links-of-blogroll-title{font-size:.875em;font-weight:600}.links-of-blogroll-list{list-style:none;margin:0;padding:0}.sidebar-nav{display:none;margin:0;padding-bottom:20px;padding-left:0}.sidebar-nav-active .sidebar-nav{display:block}.sidebar-nav li{border-bottom:1px solid transparent;color:var(--text-color);cursor:pointer;display:inline-block;font-size:.875em}.sidebar-nav li.sidebar-nav-overview{margin-left:10px}.sidebar-nav li:hover{color:#fc6423}.sidebar-overview-active .sidebar-nav-overview,.sidebar-toc-active .sidebar-nav-toc{border-bottom-color:#fc6423;color:#fc6423}.sidebar-overview-active .sidebar-nav-overview:hover,.sidebar-toc-active .sidebar-nav-toc:hover{color:#fc6423}.sidebar-panel-container{flex:1;overflow-x:hidden;overflow-y:auto}.sidebar-panel{display:none}.sidebar-overview-active .site-overview-wrap{display:flex;flex-direction:column;justify-content:center;gap:10px}.sidebar-toc-active .post-toc-wrap{display:block}.sidebar-toggle{bottom:61px;height:16px;padding:5px;width:16px;background:#222;cursor:pointer;opacity:.6;position:fixed;z-index:30;right:30px}.sidebar-toggle:hover{opacity:.8}@media (max-width:991px){.sidebar-toggle{right:20px;opacity:.8}}.sidebar-toggle:hover .toggle-line{background:#fc6423}@media (any-hover:hover){body:not(.sidebar-active) .sidebar-toggle:hover :first-child{left:50%;top:2px;transform:rotate(45deg);width:50%}body:not(.sidebar-active) .sidebar-toggle:hover :last-child{left:50%;top:-2px;transform:rotate(-45deg);width:50%}}.sidebar-active .sidebar-toggle :nth-child(2){opacity:0}.sidebar-active .sidebar-toggle :first-child{top:6px;transform:rotate(45deg)}.sidebar-active .sidebar-toggle :last-child{top:-6px;transform:rotate(-45deg)}.post-toc{font-size:.875em}.post-toc ol{list-style:none;margin:0;padding:0 2px 5px 10px;text-align:left}.post-toc ol>ol{padding-left:0}.post-toc ol a{transition:.2s ease-in-out}.post-toc .nav-item{line-height:1.8;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.post-toc .nav .nav-child{display:none}.post-toc .nav .active-current>.nav-child,.post-toc .nav .active-current>.nav-child>.nav-item,.post-toc .nav .active>.nav-child{display:block}.post-toc .nav .active>a{border-bottom-color:#fc6423;color:#fc6423}.post-toc .nav .active-current>a,.post-toc .nav .active-current>a:hover{color:#fc6423}.site-state{display:flex;flex-wrap:wrap;justify-content:center;line-height:1.4}.site-state-item a{border-bottom:0;display:block}.site-state-item-count{display:block;font-size:1em;font-weight:600}.site-state-item-name{color:#999;font-size:.8125em}.footer{color:#999;font-size:.875em;padding:20px 0}.footer.footer-fixed{bottom:0;left:0;position:absolute;right:0}.footer-inner{box-sizing:border-box;text-align:center;display:flex;flex-direction:column;justify-content:center;margin:0 auto;width:calc(100% - 20px)}@media (max-width:767px){.menu-item .badge{float:right;margin-left:0}.footer-inner{width:auto}}@media (min-width:1200px){.footer-inner{width:1160px}}@media (min-width:1600px){.footer-inner{width:73%}}.use-motion .footer{opacity:0}.languages{display:inline-block;font-size:1.125em;position:relative}.languages .lang-select-label span{margin:0 .5em}.languages .lang-select{height:100%;left:0;opacity:0;position:absolute;top:0;width:100%}.with-love{color:red;display:inline-block;margin:0 5px}@keyframes icon-animate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,50%,60%,70%,80%{transform:scale(1.1)}}.back-to-top{font-size:12px;align-items:center;bottom:-100px;color:#fff;display:flex;height:26px;transition:bottom .2s ease-in-out;background:#222;cursor:pointer;opacity:.6;position:fixed;z-index:30;right:30px}.back-to-top span{margin-right:8px;display:none}.back-to-top .fa{text-align:center;width:26px}.back-to-top:hover{opacity:.8;color:#fc6423}.back-to-top.back-to-top-on{bottom:30px}.rtl.post-body a,.rtl.post-body h1,.rtl.post-body h2,.rtl.post-body h3,.rtl.post-body h4,.rtl.post-body h5,.rtl.post-body h6,.rtl.post-body li,.rtl.post-body ol,.rtl.post-body p,.rtl.post-body ul{direction:rtl;font-family:UKIJ Ekran}.rtl.post-title{font-family:UKIJ Ekran}.post-button{margin-top:40px;text-align:center}.use-motion .collection-header,.use-motion .comments,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{visibility:hidden}.posts-collapse .post-content{margin-bottom:35px;margin-left:35px;position:relative}@media (max-width:767px){.posts-collapse .post-content{margin-left:0;margin-right:0}}.posts-collapse .post-content .collection-title{font-size:1.125em;position:relative}.posts-collapse .post-content .collection-title::before{background:#999;border:1px solid #fff;margin-left:-6px;margin-top:-4px;position:absolute;top:50%;border-radius:50%;content:' ';height:10px;width:10px}.posts-collapse .post-content .collection-year{font-size:1.5em;font-weight:700;margin:60px 0;position:relative}.posts-collapse .post-content .collection-year::before{background:#bbb;margin-left:-4px;margin-top:-4px;position:absolute;top:50%;border-radius:50%;content:' ';height:8px;width:8px}.posts-collapse .post-content .collection-header{display:block;margin-left:20px}.posts-collapse .post-content .collection-header small{color:#bbb;margin-left:5px}.posts-collapse .post-content .post-header{border-bottom:1px dashed #ccc;margin:30px 2px 0;padding-left:15px;position:relative;transition:border .2s ease-in-out}.posts-collapse .post-content .post-header::before{background:#bbb;border:1px solid #fff;left:-6px;position:absolute;top:.75em;transition:background .2s ease-in-out;border-radius:50%;content:' ';height:6px;width:6px}.posts-collapse .post-content .post-header:hover{border-bottom-color:#666}.posts-collapse .post-content .post-header:hover::before{background:#222}.posts-collapse .post-content .post-meta-container{display:inline;font-size:.75em;margin-right:10px}.posts-collapse .post-content .post-title{display:inline}.posts-collapse .post-content .post-title a{border-bottom:0;color:var(--link-color)}.posts-collapse .post-content .post-title .fa-external-link-alt{font-size:.875em;margin-left:5px}.posts-collapse .post-content::before{background:#f5f5f5;content:' ';height:100%;margin-left:-2px;position:absolute;top:1.25em;width:4px}.post-body{font-family:EB Garamond,'Noto Serif SC','PingFang SC','Microsoft YaHei',sans-serif;overflow-wrap:break-word}@media (min-width:1200px){.post-body{font-size:1.125em}}@media (min-width:992px){.post-body{text-align:justify}}.post-body h1 .header-anchor,.post-body h1 .headerlink,.post-body h2 .header-anchor,.post-body h2 .headerlink,.post-body h3 .header-anchor,.post-body h3 .headerlink,.post-body h4 .header-anchor,.post-body h4 .headerlink,.post-body h5 .header-anchor,.post-body h5 .headerlink,.post-body h6 .header-anchor,.post-body h6 .headerlink{border-bottom-style:none;color:inherit;float:right;font-size:.875em;margin-left:10px;opacity:0}.post-body h1 .header-anchor::before,.post-body h1 .headerlink::before,.post-body h2 .header-anchor::before,.post-body h2 .headerlink::before,.post-body h3 .header-anchor::before,.post-body h3 .headerlink::before,.post-body h4 .header-anchor::before,.post-body h4 .headerlink::before,.post-body h5 .header-anchor::before,.post-body h5 .headerlink::before,.post-body h6 .header-anchor::before,.post-body h6 .headerlink::before{content:'\f0c1';font-family:'Font Awesome 6 Free';font-weight:900}.post-body h1:hover .header-anchor,.post-body h1:hover .headerlink,.post-body h2:hover .header-anchor,.post-body h2:hover .headerlink,.post-body h3:hover .header-anchor,.post-body h3:hover .headerlink,.post-body h4:hover .header-anchor,.post-body h4:hover .headerlink,.post-body h5:hover .header-anchor,.post-body h5:hover .headerlink,.post-body h6:hover .header-anchor,.post-body h6:hover .headerlink{opacity:.5}.post-body h1:hover .header-anchor:hover,.post-body h1:hover .headerlink:hover,.post-body h2:hover .header-anchor:hover,.post-body h2:hover .headerlink:hover,.post-body h3:hover .header-anchor:hover,.post-body h3:hover .headerlink:hover,.post-body h4:hover .header-anchor:hover,.post-body h4:hover .headerlink:hover,.post-body h5:hover .header-anchor:hover,.post-body h5:hover .headerlink:hover,.post-body h6:hover .header-anchor:hover,.post-body h6:hover .headerlink:hover{opacity:1}.post-body .exturl .fa{font-size:.875em;margin-left:4px}.post-body .fancybox+figcaption,.post-body .image-caption,.post-body img+figcaption{color:#999;font-size:.875em;font-weight:700;line-height:1;margin:-15px auto 15px;text-align:center}.post-body embed,.post-body iframe,.post-body img,.post-body video{margin-bottom:20px}.post-body .video-container{height:0;margin-bottom:20px;overflow:hidden;padding-top:75%;position:relative;width:100%}.post-body .video-container embed,.post-body .video-container iframe,.post-body .video-container object{height:100%;left:0;margin:0;position:absolute;top:0;width:100%}.post-gallery{display:flex;min-height:200px}.post-gallery .post-gallery-image{flex:1}.post-gallery .post-gallery-image:not(:first-child){clip-path:polygon(40px 0,100% 0,100% 100%,0 100%);margin-left:-20px}.post-gallery .post-gallery-image:not(:last-child){margin-right:-20px}.post-gallery .post-gallery-image img{height:100%;object-fit:cover;opacity:1;width:100%}.posts-expand .post-gallery{margin-bottom:60px}.posts-collapse .post-gallery{margin:15px 0}.posts-expand .post-header{font-size:1.125em;margin-bottom:60px;text-align:center}.posts-expand .post-title{font-size:1.5em;font-weight:400;margin:initial;overflow-wrap:break-word}.posts-expand .post-title-link{border-bottom:0;color:var(--link-color);display:inline-block;position:relative}.posts-expand .post-title-link::before{background:var(--link-color);bottom:0;content:'';height:2px;left:0;position:absolute;transform:scaleX(0);transition:transform .2s ease-in-out;width:100%}.posts-expand .post-title-link:hover::before{transform:scaleX(1)}.posts-expand .post-title-link .fa-external-link-alt{font-size:.875em;margin-left:5px}.post-sticky-flag{display:inline-block;margin-right:8px;transform:rotate(30deg)}.posts-expand .post-meta-container{color:#999;font-family:EB Garamond,'Noto Serif SC','PingFang SC','Microsoft YaHei',sans-serif;font-size:.75em;margin-top:3px}.posts-expand .post-meta-container .post-description{font-size:.875em;margin-top:2px}.posts-expand .post-meta-container time{border-bottom:1px dashed #999}.post-meta{display:flex;flex-wrap:wrap;justify-content:center}:not(.post-meta-break)+.post-meta-item::before{content:'|';margin:0 .5em}.post-meta-item-icon{margin-right:3px}@media (max-width:991px){.back-to-top{right:20px;opacity:.8}.post-body{text-align:justify}.post-meta-item-text{display:none}}.post-meta-break{flex-basis:100%;height:0}.post-nav{border-top:1px solid #eee;display:flex;gap:30px;justify-content:space-between;margin-top:1em;padding:10px 5px 0}.post-nav-item{flex:1}.post-nav-item a{border-bottom:0;display:block;font-size:.875em;line-height:1.6}.post-nav-item a:active{top:2px}.post-nav-item .fa{font-size:.75em}.post-nav-item:first-child .fa{margin-right:5px}.post-nav-item:last-child{text-align:right}.post-nav-item:last-child .fa{margin-left:5px}.post-footer{display:flex;flex-direction:column;justify-content:center}.post-eof{background:#ccc;height:1px;margin:80px auto 60px;width:8%}.post-block:last-of-type .post-eof{display:none}.post-tags{margin-top:40px;text-align:center}.post-tags a{display:inline-block;font-size:.8125em}.post-tags a:not(:last-child){margin-right:10px}.social-like{border-top:1px solid #eee;font-size:.875em;margin-top:1em;padding-top:1em;text-align:center}.reward-container{margin:1em 0 0;padding:1em 0;text-align:center}.reward-container button{background:0 0;color:#fc6423;cursor:pointer;line-height:2;padding:0 15px;border:2px solid #fc6423;border-radius:2px;outline:0;transition:.2s ease-in-out;vertical-align:text-top}.reward-container button:hover{background:#fc6423;color:#fff}.post-reward{display:none;padding-top:20px}.post-reward.active{display:block}.post-reward div{display:inline-block}.post-reward div span{display:block}.post-reward img{display:inline-block;margin:.8em 2em 0;max-width:100%;width:180px}@keyframes next-roll{from{transform:rotateZ(30deg)}to{transform:rotateZ(-30deg)}}.category-all-page .category-all-title{text-align:center}.category-all-page .category-all{margin-top:20px}.category-all-page .category-list{list-style:none;margin:0;padding:0}.category-all-page .category-list-item{margin:5px 10px}.category-all-page .category-list-count{color:#bbb}.category-all-page .category-list-count::before{content:' ('}.category-all-page .category-list-count::after{content:') '}.category-all-page .category-list-child{padding-left:10px}.event-list hr{background:#222;margin:20px 0 45px}.event-list hr::after{background:#222;color:#fff;content:'NOW';display:inline-block;font-weight:700;padding:0 5px}.event-list .event{--event-background:#222;--event-foreground:#bbb;--event-title:#fff;background:var(--event-background);padding:15px}.event-list .event .event-summary{border-bottom:0;color:var(--event-title);margin:0;padding:0 0 0 35px;position:relative}.event-list .event .event-summary::before{animation:1s ease-in-out infinite alternate dot-flash;background:var(--event-title);left:0;margin-top:-6px;position:absolute;top:50%;border-radius:50%;content:' ';height:12px;width:12px}.event-list .event:nth-of-type(odd) .event-summary::before{animation-delay:.5s}.event-list .event:not(:last-child){margin-bottom:20px}.event-list .event .event-relative-time{color:var(--event-foreground);display:inline-block;font-size:12px;font-weight:400;padding-left:12px}.event-list .event .event-details{color:var(--event-foreground);display:block;line-height:18px;padding:6px 0 6px 35px}.event-list .event .event-details::before{color:var(--event-foreground);display:inline-block;margin-right:9px;width:14px;font-family:'Font Awesome 6 Free';font-weight:900}.event-list .event .event-details.event-location::before{content:'\f041'}.event-list .event .event-details.event-duration::before{content:'\f017'}.event-list .event .event-details.event-description::before{content:'\f024'}.event-list .event-past{--event-background:#f5f5f5;--event-foreground:#999;--event-title:#222}@keyframes dot-flash{from{opacity:1;transform:scale(1)}to{opacity:0;transform:scale(.8)}}ul.breadcrumb{font-size:.75em;list-style:none;margin:1em 0;padding:0 2em;text-align:center}ul.breadcrumb li{display:inline}ul.breadcrumb li:not(:first-child)::before{content:'/\00a0';font-weight:400;padding:.5em}ul.breadcrumb li:last-child{font-weight:700}.tag-cloud{text-align:center}.tag-cloud a{display:inline-block;margin:10px}.tag-cloud-0{border-bottom-color:#aaa;color:#aaa}.tag-cloud-1{border-bottom-color:#9a9a9a;color:#9a9a9a}.tag-cloud-2{border-bottom-color:#8b8b8b;color:#8b8b8b}.tag-cloud-3{border-bottom-color:#7c7c7c;color:#7c7c7c}.tag-cloud-4{border-bottom-color:#6c6c6c;color:#6c6c6c}.tag-cloud-5{border-bottom-color:#5d5d5d;color:#5d5d5d}.tag-cloud-6{border-bottom-color:#4e4e4e;color:#4e4e4e}.tag-cloud-7{border-bottom-color:#3e3e3e;color:#3e3e3e}.tag-cloud-8{border-bottom-color:#2f2f2f;color:#2f2f2f}.tag-cloud-9{border-bottom-color:#202020;color:#202020}.tag-cloud-10{border-bottom-color:#111;color:#111}.search-active{overflow:hidden}.search-pop-overlay{background:rgba(0,0,0,0);display:flex;height:100%;left:0;position:fixed;top:0;transition:visibility .4s,background .4s;visibility:hidden;width:100%;z-index:40}.search-active .search-pop-overlay{background:rgba(0,0,0,.3);visibility:visible}.search-popup{background:var(--card-bg-color);border-radius:5px;height:80%;margin:auto;transform:scale(0);transition:transform .4s;width:700px}.search-active .search-popup{transform:scale(1)}@media (max-width:767px){.search-popup{border-radius:0;height:100%;width:100%}}.search-popup .popup-btn-close,.search-popup .search-icon{color:#999;font-size:18px;padding:0 10px}.search-popup .popup-btn-close{cursor:pointer}.search-popup .popup-btn-close:hover .fa{color:#222}.search-popup .search-header{background:#eee;border-top-left-radius:5px;border-top-right-radius:5px;display:flex;padding:5px}.search-popup input.search-input{background:0 0;border:0;outline:0;width:100%}.search-popup input.search-input::-webkit-search-cancel-button{display:none}.search-popup .search-result-container{height:calc(100% - 55px);overflow:auto;padding:5px 25px}.search-popup .search-result-container hr{margin:5px 0 10px}.search-popup .search-result-container hr:first-child{display:none}.search-popup .search-result-list{margin:0 5px;padding:0;width:100%}.search-popup a.search-result-title{font-weight:700}.search-popup p.search-result{border-bottom:1px dashed #ccc;padding:5px 0}.search-popup .search-input-container{flex-grow:1;padding:2px}.search-popup .no-result{display:flex}.search-popup .search-result-icon{color:#ccc;margin:auto}mark.search-keyword{background:0 0;border-bottom:1px dashed #ff2a2a;color:#ff2a2a;font-weight:700}.use-motion .animated{animation-fill-mode:none;visibility:inherit}.use-motion .sidebar .animated{animation-fill-mode:both}.header{background:var(--content-bg-color);border-radius:initial;box-shadow:initial}.main{align-items:stretch;display:flex;justify-content:space-between;margin:0 auto;width:calc(100% - 20px)}@media (max-width:767px){.main{width:auto}}@media (min-width:1200px){.main{width:1160px}}@media (min-width:1600px){.main{width:73%}}@media (max-width:991px){.header{border-radius:initial}.main{display:block;width:auto}}.main-inner{border-radius:initial;box-sizing:border-box;width:calc(100% - 252px)}.footer-inner{padding-left:252px}@media (max-width:991px){.main-inner{border-radius:initial;width:100%}.footer-inner{padding-left:0;padding-right:0;width:auto}}.column{width:240px}.site-brand-container{background:var(--theme-color)}.site-meta{padding:20px 0}.site-nav-right .toggle,.site-nav-toggle .toggle{color:#fff}.site-nav-right .toggle .toggle-line,.site-nav-toggle .toggle .toggle-line{background:#fff}@media (min-width:768px) and (max-width:991px){.site-nav-right,.site-nav-toggle{display:flex;flex-direction:column;justify-content:center}.site-nav{--scroll-height:0;height:0;overflow:hidden;transition:height .2s ease-in-out}body:not(.site-nav-on) .site-nav .animated{animation:none}body.site-nav-on .site-nav{height:var(--scroll-height)}}.menu .menu-item{display:block;margin:0}.menu .menu-item a{padding:5px 20px;position:relative;text-align:left;transition-property:background-color}.menu .menu-item .badge{background:#ccc;border-radius:10px;color:var(--content-bg-color);float:right;padding:2px 5px;text-shadow:1px 1px 0 rgba(0,0,0,.1)}.main-menu .menu-item-active::after{background:#bbb;border-radius:50%;content:' ';height:6px;margin-top:-3px;position:absolute;right:15px;top:50%;width:6px}.sub-menu{margin:0;padding:6px 0}.sub-menu .menu-item{display:inline-block}.sub-menu .menu-item a{background:0 0;margin:5px 10px;padding:initial}.sub-menu .menu-item a:hover{background:0 0;color:#fc6423}.sub-menu .menu-item-active{border-bottom-color:#fc6423;color:#fc6423}.sub-menu .menu-item-active:hover{border-bottom-color:#fc6423}.sidebar{position:-webkit-sticky;position:sticky;top:12px}@media (max-width:991px){.column{width:auto}.site-nav-on .site-brand-container{box-shadow:0 0 16px rgba(0,0,0,.5)}.menu .menu-item.menu-item-search,.sidebar{display:none}}.sidebar-inner{background:var(--content-bg-color);border-radius:initial;box-shadow:initial;box-sizing:border-box;color:var(--text-color);margin-top:12px;max-height:calc(100vh - 24px);visibility:hidden}.site-state-item{padding:0 10px}.sidebar .sidebar-button{border-bottom:1px dotted #ccc;border-top:1px dotted #ccc}.sidebar .sidebar-button button{border:0;color:#fc6423;display:block;width:100%}.sidebar .sidebar-button button:hover{background:0 0;border:0;color:#e34603}.links-of-author{display:flex;flex-wrap:wrap;justify-content:center}.links-of-author-item{margin:5px 0 0;width:50%}.links-of-author-item a{box-sizing:border-box;max-width:100%;overflow:hidden;padding:0 5px;text-overflow:ellipsis;white-space:nowrap;border-bottom:0;border-radius:4px;display:block}.links-of-author-item a:hover{background:var(--body-bg-color)}.main-inner{background:var(--content-bg-color);box-shadow:initial;padding:40px}@media (max-width:991px){.main-inner{padding:20px}}.sub-menu{border-bottom:1px solid #ddd}.post-block:first-of-type{padding-top:40px}@media (max-width:767px){.pagination{margin-bottom:10px}}</style><link crossorigin=anonymous href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css integrity=sha256-Z1K5uhUaJXA7Ll0XrZ/0JhX4lAtZFpT6jkKrEDT0drU= rel=stylesheet><link crossorigin=anonymous href=https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css integrity=sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE= rel=stylesheet><script class=next-config data-name=main type=application/json>{"hostname":"gzwilly.blog","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.14.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src=/js/config.js></script><meta content="摘自《企业级 Go 项目开发实战》图书 这一讲我们来聊聊构建应用时常用的 Go 包。 因为 IAM 项目使用了 Pflag、Viper 和 Cobra 包来构建 IAM 的应用框架，为了让你后面学习更加容易，这里简单介绍下这 3 个包的核心功能和使用方式。其实如果单独讲每个包的话，还是有很多功能可讲的，但我们这一讲的目的是减小你后面学习 IAM 源码的难度，所以我会主要介绍跟 IAM 相关的功能。" name=description><meta content=article property=og:type><meta content="15 | 应用构建：Pflag、Viper、Cobra 核心功能" property=og:title><meta content=http://gzwilly.blog/post/2023-golang-practice-%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-15-pflag-viper-cobra.html property=og:url><meta content=gzwilly'blog property=og:site_name><meta content="摘自《企业级 Go 项目开发实战》图书 这一讲我们来聊聊构建应用时常用的 Go 包。 因为 IAM 项目使用了 Pflag、Viper 和 Cobra 包来构建 IAM 的应用框架，为了让你后面学习更加容易，这里简单介绍下这 3 个包的核心功能和使用方式。其实如果单独讲每个包的话，还是有很多功能可讲的，但我们这一讲的目的是减小你后面学习 IAM 源码的难度，所以我会主要介绍跟 IAM 相关的功能。" property=og:description><meta content=zh_CN property=og:locale><meta content=2023-06-27T11:52:00.000Z property=article:published_time><meta content=2023-06-27T11:52:00.000Z property=article:modified_time><meta content=gzwillyy property=article:author><meta content=Golang property=article:tag><meta content=IAM property=article:tag><meta content=Pflag property=article:tag><meta content=Viper property=article:tag><meta content=Cobra property=article:tag><meta content=summary name=twitter:card><link href=http://gzwilly.blog/post/2023-golang-practice-%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-15-pflag-viper-cobra.html rel=canonical><script class=next-config data-name=page type=application/json>{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://gzwilly.blog/post/2023-golang-practice-%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-15-pflag-viper-cobra.html","path":"/post/2023-golang-practice-开发实战-15-pflag-viper-cobra.html","title":"15 | 应用构建：Pflag、Viper、Cobra 核心功能"}</script><script class=next-config data-name=calendar type=application/json>""</script><title>15 | 应用构建：Pflag、Viper、Cobra 核心功能 | gzwilly'blog</title><noscript><link href=/css/noscript.css rel=stylesheet></noscript><body class=use-motion itemscope itemtype=http://schema.org/WebPage><div class=headband></div><main class=main><div class=column><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=site-brand-container><div class=site-nav-toggle><div aria-label=切换导航栏 class=toggle role=button><span class=toggle-line></span><span class=toggle-line></span><span class=toggle-line></span></div></div><div class=site-meta><a class=brand href=/ rel=start> <i class=logo-line></i> <p class=site-title>gzwilly'blog</p> <i class=logo-line></i> </a></div><div class=site-nav-right><div class="toggle popup-trigger" aria-label=搜索 role=button><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ rel=section><i class="fa fa-home fa-fw"></i>首页</a><li class="menu-item menu-item-tags"><a href=/tags/ rel=section><i class="fa fa-tags fa-fw"></i>标签</a><li class="menu-item menu-item-categories"><a href=/categories/ rel=section><i class="fa fa-th fa-fw"></i>分类</a><li class="menu-item menu-item-archives"><a href=/archives/ rel=section><i class="fa fa-archive fa-fw"></i>归档</a><li class="menu-item menu-item-sitemap"><a href=/sitemap.xml rel=section><i class="fa fa-sitemap fa-fw"></i>站点地图</a><li class="menu-item menu-item-search"><a class=popup-trigger role=button><i class="fa fa-search fa-fw"></i>搜索 </a></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon> <i class="fa fa-search"></i> </span><div class=search-input-container><input autocapitalize=off autocomplete=off class=search-input maxlength=80 placeholder=搜索... spellcheck=false type=search></div><span class=popup-btn-close role=button> <i class="fa fa-times-circle"></i> </span></div><div class="search-result-container no-result"><div class=search-result-icon><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></header><aside class=sidebar><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>文章目录<li class=sidebar-nav-overview>站点概览</ul><div class=sidebar-panel-container><!--noindex--><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class=nav><li class="nav-item nav-level-2"><a class=nav-link href=#%E5%A6%82%E4%BD%95%E6%9E%84%E5%BB%BA%E5%BA%94%E7%94%A8%E6%A1%86%E6%9E%B6><span class=nav-number>1.</span> <span class=nav-text>如何构建应用框架</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%8F%82%E6%95%B0%E8%A7%A3%E6%9E%90%E5%B7%A5%E5%85%B7%EF%BC%9APflag-%E4%BD%BF%E7%94%A8%E4%BB%8B%E7%BB%8D><span class=nav-number>2.</span> <span class=nav-text>命令行参数解析工具：Pflag 使用介绍</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#Pflag-%E5%8C%85-Flag-%E5%AE%9A%E4%B9%89><span class=nav-number>2.1.</span> <span class=nav-text>Pflag 包 Flag 定义</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#Pflag-%E5%8C%85-FlagSet-%E5%AE%9A%E4%B9%89><span class=nav-number>2.2.</span> <span class=nav-text>Pflag 包 FlagSet 定义</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#Pflag-%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95><span class=nav-number>2.3.</span> <span class=nav-text>Pflag 使用方法</span></a></ol><li class="nav-item nav-level-2"><a class=nav-link href=#%E9%85%8D%E7%BD%AE%E8%A7%A3%E6%9E%90%E7%A5%9E%E5%99%A8%EF%BC%9AViper-%E4%BD%BF%E7%94%A8%E4%BB%8B%E7%BB%8D><span class=nav-number>3.</span> <span class=nav-text>配置解析神器：Viper 使用介绍</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#%E8%AF%BB%E5%85%A5%E9%85%8D%E7%BD%AE><span class=nav-number>3.1.</span> <span class=nav-text>读入配置</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#%E8%AF%BB%E5%8F%96%E9%85%8D%E7%BD%AE><span class=nav-number>3.2.</span> <span class=nav-text>读取配置</span></a></ol><li class="nav-item nav-level-2"><a class=nav-link href=#%E7%8E%B0%E4%BB%A3%E5%8C%96%E7%9A%84%E5%91%BD%E4%BB%A4%E8%A1%8C%E6%A1%86%E6%9E%B6%EF%BC%9ACobra-%E5%85%A8%E8%A7%A3><span class=nav-number>4.</span> <span class=nav-text>现代化的命令行框架：Cobra 全解</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#%E4%BD%BF%E7%94%A8-Cobra-%E5%BA%93%E5%88%9B%E5%BB%BA%E5%91%BD%E4%BB%A4><span class=nav-number>4.1.</span> <span class=nav-text>使用 Cobra 库创建命令</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#%E4%BD%BF%E7%94%A8%E6%A0%87%E5%BF%97><span class=nav-number>4.2.</span> <span class=nav-text>使用标志</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#%E9%9D%9E%E9%80%89%E9%A1%B9%E5%8F%82%E6%95%B0%E9%AA%8C%E8%AF%81><span class=nav-number>4.3.</span> <span class=nav-text>非选项参数验证</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#PreRun-and-PostRun-Hooks><span class=nav-number>4.4.</span> <span class=nav-text>PreRun and PostRun Hooks</span></a></ol><li class="nav-item nav-level-2"><a class=nav-link href=#%E6%80%BB%E7%BB%93><span class=nav-number>5.</span> <span class=nav-text>总结</span></a></ol></div></div><!--/noindex--><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop=author itemscope itemtype=http://schema.org/Person><p class=site-author-name itemprop=name>gzwillyy<div class=site-description itemprop=description></div></div><div class="site-state-wrap animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/> <span class=site-state-item-count>68</span> <span class=site-state-item-name>日志</span> </a></div><div class="site-state-item site-state-categories"><a href=/categories/> <span class=site-state-item-count>7</span> <span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/> <span class=site-state-item-count>90</span> <span class=site-state-item-name>标签</span></a></div></nav></div><div class="links-of-author animated"><span class=links-of-author-item> <a rel="noopener me" title="GitHub → https://github.com/gzwillyy" href=https://github.com/gzwillyy target=_blank><i class="fab fa-github fa-fw"></i>GitHub</a> </span></div></div></div></div></aside></div><div class="main-inner post posts-expand"><div class=post-block><article class=post-content itemscope itemtype=http://schema.org/Article lang=zh-CN><link href=http://gzwilly.blog/post/2023-golang-practice-%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-15-pflag-viper-cobra.html itemprop=mainEntityOfPage><span hidden itemprop=author itemscope itemtype=http://schema.org/Person> <meta content=/images/avatar.gif itemprop=image> <meta content=gzwillyy itemprop=name> </span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization> <meta content=gzwilly'blog itemprop=name> <meta itemprop=description> </span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork> <meta content="15 | 应用构建：Pflag、Viper、Cobra 核心功能 | gzwilly'blog" itemprop=name> <meta itemprop=description> </span><header class=post-header><h1 itemprop="name headline" class=post-title>15 | 应用构建：Pflag、Viper、Cobra 核心功能</h1><div class=post-meta-container><div class=post-meta><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar"></i> </span> <span class=post-meta-item-text>发表于</span> <time itemprop="dateCreated datePublished" title="创建时间：2023-06-27 19:52:00" datetime=2023-06-27T19:52:00+08:00>2023-06-27</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-folder"></i> </span> <span class=post-meta-item-text>分类于</span> <span itemprop=about itemscope itemtype=http://schema.org/Thing> <a href=/categories/Golang-%E5%AE%9E%E6%88%98/ itemprop=url rel=index><span itemprop=name>Golang 实战</span></a> </span> </span></div></div></header><div class=post-body itemprop=articleBody><p><strong>摘自《企业级 Go 项目开发实战》图书</strong><p>这一讲我们来聊聊构建应用时常用的 <code>Go</code> 包。<p>因为 <code>IAM</code> 项目使用了 <code>Pflag</code>、<code>Viper</code> 和 <code>Cobra</code> 包来构建 <code>IAM</code> 的应用框架，为了让你后面学习更加容易，这里简单介绍下这 <code>3</code> 个包的核心功能和使用方式。其实如果单独讲每个包的话，还是有很多功能可讲的，但我们这一讲的目的是减小你后面学习 <code>IAM</code> 源码的难度，所以我会主要介绍跟 <code>IAM</code> 相关的功能。<p>在正式介绍这三个包之前，我们先来看下如何构建应用的框架。</p><span id=more></span><h2 id=如何构建应用框架><a class=headerlink href=#如何构建应用框架 title=如何构建应用框架></a>如何构建应用框架</h2><p>想知道如何构建应用框架，首先你要明白，一个应用框架包含哪些部分。在我看来，一个应用框架需要包含以下 <code>3</code> 个部分：<p><code>命令行参数解析</code>：主要用来解析命令行参数，这些命令行参数可以影响命令的运行效果。<p><code>配置文件解析</code>：一个大型应用，通常具有很多参数，为了便于管理和配置这些参数，通常会将这些参数放在一个配置文件中，供程序读取并解析。<p><code>应用的命令行框架</code>：应用最终是通过命令来启动的。这里有 <code>3</code> 个需求点，<code>一</code>是命令需要具备 <code>Help</code> 功能，这样才能告诉使用者如何去使用；<code>二</code>是命令需要能够解析命令行参数和配置文件；<code>三</code>是命令需要能够初始化业务代码，并最终启动业务进程。也就是说，我们的命令需要具备框架的能力，来纳管这 <code>3</code> 个部分。<p>这 <code>3</code> 个部分的功能，你可以自己开发，也可以借助业界已有的成熟实现。跟之前的想法一样，我不建议你自己开发，更建议你采用业界已有的成熟实现。命令行参数可以通过 <code>Flag</code> 来解析，配置文件可以通过 <code>Viper</code> 来解析，应用的命令行框架则可以通过<code>Cobra</code>来实现。这 <code>3</code> 个包目前也是最受欢迎的包，并且这 <code>3</code> 个包不是割裂的，而是有联系的，我们可以有机地组合这 <code>3</code> 个包，从而实现一个非常强大、优秀的应用命令行框架。<h2 id=命令行参数解析工具：Pflag-使用介绍><a title="命令行参数解析工具：Pflag 使用介绍" class=headerlink href=#命令行参数解析工具：Pflag-使用介绍></a>命令行参数解析工具：Pflag 使用介绍</h2><p>Go 服务开发中，经常需要给开发的组件加上各种启动参数来配置服务进程，影响服务的行为。像 <code>kube-apiserver</code> 就有多达 <code>200</code> 多个启动参数，而且这些参数的类型各不相同（例如：<code>string</code>、<code>int</code>、<code>ip</code> 类型等），使用方式也不相同（例如：需要支持–长选项，-短选项等），所以我们需要一个强大的命令行参数解析工具。<p>虽然 Go 源码中提供了一个标准库 <code>Flag</code> 包，用来对命令行参数进行解析，但在大型项目中应用更广泛的是另外一个包：<code>Pflag</code>。<code>Pflag</code> 提供了很多强大的特性，非常适合用来构建大型项目，一些耳熟能详的开源项目都是用 <code>Pflag</code> 来进行命令行参数解析的，例如：<code>Kubernetes</code>、<code>Istio</code>、<code>Helm</code>、<code>Docker</code>、<code>Etcd</code> 等。<p>接下来，我们就来介绍下如何使用 <code>Pflag</code>。<code>Pflag</code> 主要是通过创建 <code>Flag</code> 和 <code>FlagSet</code> 来使用的。我们先来看下 <code>Flag</code>。<h3 id=Pflag-包-Flag-定义><a title="Pflag 包 Flag 定义" class=headerlink href=#Pflag-包-Flag-定义></a>Pflag 包 Flag 定义</h3><p><code>Pflag</code> 可以对命令行参数进行处理，一个命令行参数在 <code>Pflag</code> 包中会解析为一个 <code>Flag</code> 类型的变量。<code>Flag</code> 是一个结构体，定义如下：<pre class="line-numbers language-go" data-language=go><code class=language-go><span class="token keyword">type</span> Flag <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Name <span class="token builtin">string</span> <span class="token comment">// flag长选项的名称</span>

	Shorthand <span class="token builtin">string</span> <span class="token comment">// flag短选项的名称，一个缩写的字符</span>

	Usage <span class="token builtin">string</span> <span class="token comment">// flag的使用文本</span>

	Value Value <span class="token comment">// flag的值</span>

	DefValue <span class="token builtin">string</span> <span class="token comment">// flag的默认值</span>

	Changed <span class="token builtin">bool</span> <span class="token comment">// 记录flag的值是否有被设置过</span>

	NoOptDefVal <span class="token builtin">string</span> <span class="token comment">// 当flag出现在命令行，但是没有指定选项值时的默认值</span>

	Deprecated <span class="token builtin">string</span> <span class="token comment">// 记录该flag是否被放弃</span>

	Hidden <span class="token builtin">bool</span> <span class="token comment">// 如果值为true，则从help/usage输出信息中隐藏该flag</span>

	ShorthandDeprecated <span class="token builtin">string</span> <span class="token comment">// 如果flag的短选项被废弃，当使用flag的短选项时打印该信息</span>

	Annotations <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token comment">// 给flag设置注解</span>

<span class="token punctuation">}</span><span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>Flag</code> 的值是一个 <code>Value</code> 类型的接口，<code>Value</code> 定义如下：<pre class="line-numbers language-go" data-language=go><code class=language-go><span class="token keyword">type</span> Value <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token comment">// 将flag类型的值转换为string类型的值，并返回string的内容</span>

	<span class="token function">Set</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token comment">// 将string类型的值转换为flag类型的值，转换失败报错</span>

	<span class="token function">Type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token comment">// 返回flag的类型，例如：string、int、ip等</span>

<span class="token punctuation">}</span>
<span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过将 <code>Flag</code> 的值抽象成一个 <code>interface</code> 接口，我们就可以自定义 <code>Flag</code> 的类型了。只要实现了 <code>Value</code> 接口的结构体，就是一个新类型。<h3 id=Pflag-包-FlagSet-定义><a title="Pflag 包 FlagSet 定义" class=headerlink href=#Pflag-包-FlagSet-定义></a>Pflag 包 FlagSet 定义</h3><p><code>Pflag</code> 除了支持单个的 <code>Flag</code> 之外，还支持 <code>FlagSet</code>。<code>FlagSet</code> 是一些预先定义好的 <code>Flag</code> 的集合，几乎所有的 <code>Pflag</code> 操作，都需要借助 <code>FlagSet</code> 提供的方法来完成。<p>在实际开发中，我们可以使用两种方法来获取并使用 <code>FlagSet</code>：<p><code>方法一</code>，调用 <code>NewFlagSet</code> 创建一个 <code>FlagSet</code>。<p><code>方法二</code>，使用 <code>Pflag</code> 包定义的全局 <code>FlagSet</code>：<code>CommandLine</code>。实际上 <code>CommandLine</code> 也是由 <code>NewFlagSet</code> 函数创建的。<p>先来看下<code>第一种方法</code>，<code>自定义 FlagSet</code>。下面是一个 <code>自定义 FlagSet</code> 的示例：<pre class="line-numbers language-go" data-language=go><code class=language-go><span class="token keyword">var</span> version <span class="token builtin">bool</span>

flagSet <span class="token operator">:=</span> pflag<span class="token punctuation">.</span><span class="token function">NewFlagSet</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">,</span> pflag<span class="token punctuation">.</span>ContinueOnError<span class="token punctuation">)</span>

flagSet<span class="token punctuation">.</span><span class="token function">BoolVar</span><span class="token punctuation">(</span><span class="token operator">&</span>version<span class="token punctuation">,</span> <span class="token string">"version"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">"Print version information and quit."</span><span class="token punctuation">)</span><span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我们可以通过定义一个新的 <code>FlagSet</code> 来定义<code>命令</code>及其<code>子命令</code>的 <code>Flag</code>。<p>再来看下<code>第二种方法</code>，使用<code>全局 FlagSet</code>。下面是一个使用<code>全局 FlagSet</code> 的示例：<pre class="line-numbers language-go" data-language=go><code class=language-go><span class="token keyword">import</span> <span class="token punctuation">(</span>
<span class="token string">"github.com/spf13/pflag"</span>
<span class="token punctuation">)</span>

pflag<span class="token punctuation">.</span><span class="token function">BoolVarP</span><span class="token punctuation">(</span><span class="token operator">&</span>version<span class="token punctuation">,</span> <span class="token string">"version"</span><span class="token punctuation">,</span> <span class="token string">"v"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">"Print version information and quit."</span><span class="token punctuation">)</span>

<span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这其中，<code>pflag.BoolVarP</code> 函数定义如下：<pre class="line-numbers language-go" data-language=go><code class=language-go><span class="token keyword">func</span> <span class="token function">BoolVarP</span><span class="token punctuation">(</span>p <span class="token operator">*</span><span class="token builtin">bool</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> shorthand <span class="token builtin">string</span><span class="token punctuation">,</span> value <span class="token builtin">bool</span><span class="token punctuation">,</span> usage <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	flag <span class="token operator">:=</span> CommandLine<span class="token punctuation">.</span><span class="token function">VarPF</span><span class="token punctuation">(</span><span class="token function">newBoolValue</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> shorthand<span class="token punctuation">,</span> usage<span class="token punctuation">)</span>
	flag<span class="token punctuation">.</span>NoOptDefVal <span class="token operator">=</span> <span class="token string">"true"</span>
<span class="token punctuation">}</span><span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span></span></code></pre><p>可以看到 <code>pflag.BoolVarP</code> 最终调用了 <code>CommandLine</code>，<code>CommandLine</code> 是一个<code>包级别</code>的变量，定义为：<pre class="line-numbers language-go" data-language=go><code class=language-go><span class="token comment">// CommandLine is the default set of command-line flags, parsed from os.Args.</span>
<span class="token keyword">var</span> CommandLine <span class="token operator">=</span> <span class="token function">NewFlagSet</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ExitOnError<span class="token punctuation">)</span>
<span aria-hidden=true class=line-numbers-rows><span></span><span></span></span></code></pre><p>在一些不需要定义<code>子命令</code>的<code>命令行工具</code>中，我们可以直接使用<code>全局的 FlagSet</code>，更加简单方便。<h3 id=Pflag-使用方法><a title="Pflag 使用方法" class=headerlink href=#Pflag-使用方法></a>Pflag 使用方法</h3><p>上面，我们介绍了使用 <code>Pflag</code> 包的两个核心结构体。<p>接下来，我来详细介绍下 <code>Pflag</code> 的常见使用方法。<p><code>Pflag</code> 有很多强大的功能，我这里介绍 <code>7</code> 个常见的使用方法。<p><em><strong>支持<code>多种命令行参数定义</code>方式。</strong></em><p><code>Pflag</code> 支持以下 <code>4</code> 种 <code>命令行参数定义</code> 方式：<p>支持<code>长选项</code>、<code>默认值</code>和<code>使用文本</code>，并将标志的值<code>存储</code>在<code>指针</code>中。<pre class="line-numbers language-go" data-language=go><code class=language-go><span class="token keyword">var</span> name <span class="token operator">=</span> pflag<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"colin"</span><span class="token punctuation">,</span> <span class="token string">"Input Your Name"</span><span class="token punctuation">)</span><span aria-hidden=true class=line-numbers-rows><span></span></span></code></pre><p>支持<code>长选项</code>、<code>短选项</code>、<code>默认值</code>和<code>使用文本</code>，并将标志的值<code>存储</code>在<code>指针</code>中。<pre class="line-numbers language-go" data-language=go><code class=language-go><span class="token keyword">var</span> name <span class="token operator">=</span> pflag<span class="token punctuation">.</span><span class="token function">StringP</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"n"</span><span class="token punctuation">,</span> <span class="token string">"colin"</span><span class="token punctuation">,</span> <span class="token string">"Input Your Name"</span><span class="token punctuation">)</span><span aria-hidden=true class=line-numbers-rows><span></span></span></code></pre><p>支持<code>长选项</code>、<code>默认值</code>和<code>使用文本</code>，并将标志的值<code>绑定</code>到<code>变量</code>。<pre class="line-numbers language-go" data-language=go><code class=language-go><span class="token keyword">var</span> name <span class="token builtin">string</span>

pflag<span class="token punctuation">.</span><span class="token function">StringVar</span><span class="token punctuation">(</span><span class="token operator">&</span>name<span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"colin"</span><span class="token punctuation">,</span> <span class="token string">"Input Your Name"</span><span class="token punctuation">)</span><span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span></span></code></pre><p>支持<code>长选项</code>、<code>短选项</code>、<code>默认值</code>和<code>使用文本</code>，并将标志的值<code>绑定</code>到<code>变量</code>。<pre class="line-numbers language-go" data-language=go><code class=language-go><span class="token keyword">var</span> name <span class="token builtin">string</span>

pflag<span class="token punctuation">.</span><span class="token function">StringVarP</span><span class="token punctuation">(</span><span class="token operator">&</span>name<span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"n"</span><span class="token punctuation">,</span><span class="token string">"colin"</span><span class="token punctuation">,</span> <span class="token string">"Input Your Name"</span><span class="token punctuation">)</span>
<span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span></span></code></pre><p>上面的函数命名是有规则的：<p>函数名带<code>Var</code>说明是将标志的值绑定到变量，否则是将标志的值存储在<code>指针</code>中。<p>函数名带<code>P</code>说明支持<code>短选项</code>，否则不支持<code>短选项</code>。<p><em><strong>使用<code>Get</code>获取参数的值。</strong></em><p>可以使用Get来获取标志的值，代表 <code>Pflag</code> 所支持的类型。例如：有一个 <code>pflag.FlagSet</code>，带有一个名为 <code>flagname</code> 的 <code>int</code> 类型的标志，可以使用 <code>GetInt()</code> 来获取 <code>int</code> 值。需要注意 <code>flagname</code> 必须存在且必须是 <code>int</code>，例如：<pre class="line-numbers language-go" data-language=go><code class=language-go>
i<span class="token punctuation">,</span> err <span class="token operator">:=</span> flagset<span class="token punctuation">.</span><span class="token function">GetInt</span><span class="token punctuation">(</span><span class="token string">"flagname"</span><span class="token punctuation">)</span>
<span aria-hidden=true class=line-numbers-rows><span></span><span></span></span></code></pre><p><em><strong>获取非选项参数。</strong></em><p>代码示例如下：<pre class="line-numbers language-go" data-language=go><code class=language-go>
<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>

	<span class="token string">"github.com/spf13/pflag"</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> <span class="token punctuation">(</span>
	flagvar <span class="token operator">=</span> pflag<span class="token punctuation">.</span><span class="token function">Int</span><span class="token punctuation">(</span><span class="token string">"flagname"</span><span class="token punctuation">,</span> <span class="token number">1234</span><span class="token punctuation">,</span> <span class="token string">"help message for flagname"</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

	pflag<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"argument number is: %v\n"</span><span class="token punctuation">,</span> pflag<span class="token punctuation">.</span><span class="token function">NArg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"argument list is: %v\n"</span><span class="token punctuation">,</span> pflag<span class="token punctuation">.</span><span class="token function">Args</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"the first argument is: %v\n"</span><span class="token punctuation">,</span> pflag<span class="token punctuation">.</span><span class="token function">Arg</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">}</span>
<span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行上述代码，输出如下：<pre class="line-numbers language-bash" data-language=bash><code class=language-bash>
$ go run example1.go arg1 arg2

argument number is: <span class="token number">2</span>

argument list is: <span class="token punctuation">[</span>arg1 arg2<span class="token punctuation">]</span>

the first argument is: arg1
<span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在定义完标志之后，可以调用<code>pflag.Parse()</code>来解析定义的标志。<p>解析后，可通过 <code>pflag.Args()</code> 返回所有的非选项参数，通过 <code>flag.Arg(i)</code> 返回第 <code>i</code> 个非选项参数。<p>参数下标 <code>0</code> 到 <code>pflag.NArg() – 1</code>。<p><em><strong>指定了选项但是没有指定选项值时的默认值。</strong></em><p>创建一个 <code>Flag</code> 后，可以为这个 <code>Flag</code> 设置 <code>pflag.NoOptDefVal</code> 。如果一个 <code>Flag</code> 具有 <code>NoOptDefVal</code>，并且该 <code>Flag</code> 在命令行上没有设置这个 <code>Flag</code> 的值，则该标志将设置为 <code>NoOptDefVal</code> 指定的值。<br>例如：<pre class="line-numbers language-go" data-language=go><code class=language-go>
<span class="token keyword">var</span> ip <span class="token operator">=</span> flag<span class="token punctuation">.</span><span class="token function">IntP</span><span class="token punctuation">(</span><span class="token string">"flagname"</span><span class="token punctuation">,</span> <span class="token string">"f"</span><span class="token punctuation">,</span> <span class="token number">1234</span><span class="token punctuation">,</span> <span class="token string">"help message"</span><span class="token punctuation">)</span>

flag<span class="token punctuation">.</span><span class="token function">Lookup</span><span class="token punctuation">(</span><span class="token string">"flagname"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>NoOptDefVal <span class="token operator">=</span> <span class="token string">"4321"</span>
<span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span></span></code></pre><p><em><strong>弃用标志或者标志的简写。</strong></em><p><code>Pflag</code> 可以弃用标志或者标志的简写。弃用的标志或标志简写在帮助文本中会被隐藏，并在使用不推荐的标志或简写时打印正确的用法提示。例如，弃用名为 logmode 的标志，并告知用户应该使用哪个标志代替：<pre class="line-numbers language-go" data-language=go><code class=language-go><span class="token comment">// deprecate a flag by specifying its name and a usage message</span>
pflag<span class="token punctuation">.</span>CommandLine<span class="token punctuation">.</span><span class="token function">MarkDeprecated</span><span class="token punctuation">(</span><span class="token string">"logmode"</span><span class="token punctuation">,</span> <span class="token string">"please use --log-mode instead"</span><span class="token punctuation">)</span><span aria-hidden=true class=line-numbers-rows><span></span><span></span></span></code></pre><p>这样隐藏了帮助文本中的 <code>logmode</code>，并且当使用 <code>logmode</code> 时，打印了 <code>Flag –logmode has been deprecated, please use –log-mode instead</code>。<p><em><strong>保留名为 <code>port</code> 的标志，但是弃用它的简写形式。</strong></em><pre class="line-numbers language-go" data-language=go><code class=language-go>pflag<span class="token punctuation">.</span><span class="token function">IntVarP</span><span class="token punctuation">(</span><span class="token operator">&</span>port<span class="token punctuation">,</span> <span class="token string">"port"</span><span class="token punctuation">,</span> <span class="token string">"P"</span><span class="token punctuation">,</span> <span class="token number">3306</span><span class="token punctuation">,</span> <span class="token string">"MySQL service host port."</span><span class="token punctuation">)</span>
<span class="token comment">// deprecate a flag shorthand by specifying its flag name and a usage message</span>
pflag<span class="token punctuation">.</span>CommandLine<span class="token punctuation">.</span><span class="token function">MarkShorthandDeprecated</span><span class="token punctuation">(</span><span class="token string">"port"</span><span class="token punctuation">,</span> <span class="token string">"please use --port only"</span><span class="token punctuation">)</span><span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span></span></code></pre><p>这样隐藏了帮助文本中的简写 <code>P</code>，并且当使用简写 <code>P</code> 时，打印了<code>Flag shorthand -P has been deprecated, please use –port only</code>。<code>usage message</code> 在此处必不可少，并且不应为空。<p><em><strong>隐藏标志。</strong></em><p>可以将 <code>Flag</code> 标记为隐藏的，这意味着它仍将正常运行，但不会显示在 <code>usage/help</code> 文本中。例如：隐藏名为 <code>secretFlag</code> 的标志，只在内部使用，并且不希望它显示在帮助文本或者使用文本中。代码如下：<pre class="line-numbers language-go" data-language=go><code class=language-go><span class="token comment">// hide a flag by specifying its name</span>
pflag<span class="token punctuation">.</span>CommandLine<span class="token punctuation">.</span><span class="token function">MarkHidden</span><span class="token punctuation">(</span><span class="token string">"secretFlag"</span><span class="token punctuation">)</span>
<span aria-hidden=true class=line-numbers-rows><span></span><span></span></span></code></pre><h2 id=配置解析神器：Viper-使用介绍><a title="配置解析神器：Viper 使用介绍" class=headerlink href=#配置解析神器：Viper-使用介绍></a>配置解析神器：Viper 使用介绍</h2><p>几乎所有的后端服务，都需要一些配置项来配置我们的服务，一些小型的项目，配置不是很多，可以选择只通过命令行参数来传递配置。但是大型项目配置很多，通过命令行参数传递就变得很麻烦，不好维护。标准的解决方案是将这些配置信息保存在配置文件中，由程序启动时加载和解析。<code>Go</code> 生态中有很多包可以加载并解析配置文件，目前最受欢迎的是 <code>Viper</code> 包。<p><code>Viper</code> 是 <code>Go</code> 应用程序现代化的、完整的解决方案，能够处理不同格式的配置文件，让我们在构建现代应用程序时，不必担心配置文件格式。<code>Viper</code> 也能够满足我们对应用配置的各种需求。<p><code>Viper</code> 可以从不同的位置读取配置，不同位置的配置具有不同的优先级，高优先级的配置会覆盖低优先级相同的配置，按优先级从高到低排列如下：<p>通过 <code>viper.Set</code> 函数显示设置的配置<p><code>命令行参数</code><p><code>环境变量</code><p><code>配置文件</code><p><code>Key/Value 存储</code><p><code>默认值</code><p>这里需要注意，<code>Viper</code> 配置键<code>不区分大小写</code>。<p><code>Viper</code> 有很多功能，最重要的两类功能是读入配置和读取配置，<code>Viper</code> 提供不同的方式来实现这两类功能。接下来，我们就来详细介绍下 <code>Viper</code> 如何读入配置和读取配置。<h3 id=读入配置><a class=headerlink href=#读入配置 title=读入配置></a>读入配置</h3><p>读入配置，就是将配置读入到 <code>Viper</code> 中，有如下读入方式：<br><code>设置默认的配置文件名</code>,<code>读取配置文件</code>,<code>监听和重新读取配置文件</code>,<code>从 io.Reader 读取配置</code>,<code>从环境变量读取</code>,<code>从命令行标志读取</code>,<code>从远程 Key/Value 存储读取</code><p>这几个方法的具体读入方式，你可以看下面的展示。<p><em><strong>1. 设置默认值</strong></em><p>一个好的配置系统应该支持<code>默认值</code>。<code>Viper</code> 支持对 <code>key</code> 设置默认值，当没有通过<code>配置文件</code>、<code>环境变量</code>、<code>远程配置</code>或<code>命令行标志</code>设置 <code>key</code> 时，设置默认值通常是很有用的，可以让程序在没有明确指定配置时也能够正常运行。例如：<pre class="line-numbers language-go" data-language=go><code class=language-go>
viper<span class="token punctuation">.</span><span class="token function">SetDefault</span><span class="token punctuation">(</span><span class="token string">"ContentDir"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">)</span>

viper<span class="token punctuation">.</span><span class="token function">SetDefault</span><span class="token punctuation">(</span><span class="token string">"LayoutDir"</span><span class="token punctuation">,</span> <span class="token string">"layouts"</span><span class="token punctuation">)</span>

viper<span class="token punctuation">.</span><span class="token function">SetDefault</span><span class="token punctuation">(</span><span class="token string">"Taxonomies"</span><span class="token punctuation">,</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"tag"</span><span class="token punctuation">:</span> <span class="token string">"tags"</span><span class="token punctuation">,</span> <span class="token string">"category"</span><span class="token punctuation">:</span> <span class="token string">"categories"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><em><strong>2. 读取配置文件</strong></em><p><code>Viper</code> 可以读取配置文件来解析配置，支持 <code>JSON</code>、<code>TOML</code>、<code>YAML</code>、<code>YML</code>、<code>Properties</code>、<code>Props</code>、<code>Prop</code>、<code>HCL</code>、<code>Dotenv</code>、<code>Env</code> 格式的配置文件。<p><code>Viper</code> 支持搜索多个路径，并且默认不配置任何搜索路径，将默认决策留给应用程序。<p>以下是如何使用 <code>Viper</code> 搜索和读取配置文件的示例：<pre class="line-numbers language-go" data-language=go><code class=language-go><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>

	<span class="token string">"github.com/spf13/pflag"</span>
	<span class="token string">"github.com/spf13/viper"</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> <span class="token punctuation">(</span>
	cfg <span class="token operator">=</span> pflag<span class="token punctuation">.</span><span class="token function">StringP</span><span class="token punctuation">(</span><span class="token string">"config"</span><span class="token punctuation">,</span> <span class="token string">"c"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">"Configuration file."</span><span class="token punctuation">)</span>

	help <span class="token operator">=</span> pflag<span class="token punctuation">.</span><span class="token function">BoolP</span><span class="token punctuation">(</span><span class="token string">"help"</span><span class="token punctuation">,</span> <span class="token string">"h"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">"Show this help message."</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

	pflag<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">if</span> <span class="token operator">*</span>help <span class="token punctuation">{</span>

		pflag<span class="token punctuation">.</span><span class="token function">Usage</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

		<span class="token keyword">return</span>

	<span class="token punctuation">}</span>

	<span class="token comment">// 从配置文件中读取配置</span>

	<span class="token keyword">if</span> <span class="token operator">*</span>cfg <span class="token operator">!=</span> <span class="token string">""</span> <span class="token punctuation">{</span>

		viper<span class="token punctuation">.</span><span class="token function">SetConfigFile</span><span class="token punctuation">(</span><span class="token operator">*</span>cfg<span class="token punctuation">)</span> <span class="token comment">// 指定配置文件名</span>

		viper<span class="token punctuation">.</span><span class="token function">SetConfigType</span><span class="token punctuation">(</span><span class="token string">"yaml"</span><span class="token punctuation">)</span> <span class="token comment">// 如果配置文件名中没有文件扩展名，则需要指定配置文件的格式，告诉viper以何种格式解析文件</span>

	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>

		viper<span class="token punctuation">.</span><span class="token function">AddConfigPath</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span> <span class="token comment">// 把当前目录加入到配置文件的搜索路径中</span>

		viper<span class="token punctuation">.</span><span class="token function">AddConfigPath</span><span class="token punctuation">(</span><span class="token string">"$HOME/.iam"</span><span class="token punctuation">)</span> <span class="token comment">// 配置文件搜索路径，可以设置多个配置文件搜索路径</span>

		viper<span class="token punctuation">.</span><span class="token function">SetConfigName</span><span class="token punctuation">(</span><span class="token string">"config"</span><span class="token punctuation">)</span> <span class="token comment">// 配置文件名称（没有文件扩展名）</span>

	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> err <span class="token operator">:=</span> viper<span class="token punctuation">.</span><span class="token function">ReadInConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span> <span class="token comment">// 读取配置文件。如果指定了配置文件名，则使用指定的配置文件，否则在注册的搜索路径中搜索</span>

		<span class="token function">panic</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"Fatal error config file: %s \n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span>

	<span class="token punctuation">}</span>

	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"Used configuration file is: %s\n"</span><span class="token punctuation">,</span> viper<span class="token punctuation">.</span><span class="token function">ConfigFileUsed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">}</span>
<span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>Viper</code> 支持设置多个配置文件搜索路径，需要注意添加搜索路径的顺序，<code>Viper</code> 会根据添加的路径顺序搜索配置文件，如果找到则停止搜索。如果调用 <code>SetConfigFile</code> 直接指定了配置文件名，并且配置文件名没有文件扩展名时，需要显式指定配置文件的格式，以使 <code>Viper</code> 能够正确解析配置文件。<p>如果通过搜索的方式查找配置文件，则需要注意，SetConfigName 设置的配置文件名是不带扩展名的，在搜索时 <code>Viper</code> 会在文件名之后追加文件扩展名，并尝试搜索所有支持的扩展类型。<p><em><strong>3. 监听和重新读取配置文件。</strong></em><p><code>Viper</code> 支持在运行时让应用程序实时读取配置文件，也就是热加载配置。可以通过 <code>WatchConfig</code> 函数热加载配置。在调用 <code>WatchConfig</code> 函数之前，需要确保已经添加了配置文件的搜索路径。<p>另外，还可以为 <code>Viper</code> 提供一个回调函数，以便在每次发生更改时运行。这里我也给你个示例：<pre class="line-numbers language-go" data-language=go><code class=language-go>
viper<span class="token punctuation">.</span><span class="token function">WatchConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

viper<span class="token punctuation">.</span><span class="token function">OnConfigChange</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>e fsnotify<span class="token punctuation">.</span>Event<span class="token punctuation">)</span> <span class="token punctuation">{</span>

	<span class="token comment">// 配置文件发生变更之后会调用的回调函数</span>

	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Config file changed:"</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>Name<span class="token punctuation">)</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我不建议在实际开发中使用热加载功能，因为即使配置热加载了，程序中的代码也不一定会热加载。例如：修改了服务监听端口，但是服务没有重启，这时候服务还是监听在老的端口上，会造成不一致。<p><em><strong>4. 设置配置值。</strong></em><p>我们可以通过 <code>viper.Set()</code> 函数来显式设置配置：<pre class="line-numbers language-go" data-language=go><code class=language-go>viper<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"user.username"</span><span class="token punctuation">,</span> <span class="token string">"colin"</span><span class="token punctuation">)</span><span aria-hidden=true class=line-numbers-rows><span></span></span></code></pre><p><em><strong>5. 使用环境变量。</strong></em><p><code>Viper</code> 还支持环境变量，通过如下 <code>5</code> 个函数来支持环境变量：<p><code>AutomaticEnv()</code><p><code>BindEnv(input …string) error</code><p><code>SetEnvPrefix(in string)</code><p><code>SetEnvKeyReplacer(r *strings.Replacer)</code><p><code>AllowEmptyEnv(allowEmptyEnv bool)</code><p>这里要注意：<code>Viper</code> 读取环境变量是区分大小写的。<code>Viper</code> 提供了一种机制来确保 <code>Env</code> 变量是唯一的。<p>通过使用 <code>SetEnvPrefix</code> ，可以告诉 <code>Viper</code> 在读取环境变量时使用前缀。<p><code>BindEnv</code> 和 <code>AutomaticEnv</code> 都将使用此前缀。<p>比如，我们设置了 <code>viper.SetEnvPrefix("VIPER")</code>，当使用 <code>viper.Get("apiversion")</code> 时，实际读取的环境变量是 <code>VIPER_APIVERSION</code> 。<p><code>BindEnv</code> 需要<code>一个</code>或<code>两个</code>参数。第一个参数是<code>键名</code>，第二个是<code>环境变量的名称</code>，环境变量的名称区分大小写。如果未提供 <code>Env</code> 变量名，则 <code>Viper</code> 将假定 <code>Env</code> 变量名为：环境变量<code>前缀_键名</code>全大写。例如：前缀为 <code>VIPER</code>，<code>key</code> 为 <code>username</code>，则 <code>Env</code> <code>变量名为VIPER_USERNAME</code> 。<p>当显示提供 <code>Env</code> 变量名（第二个参数）时，它不会自动添加前缀。例如，如果第二个参数是 <code>ID</code>，<code>Viper</code> 将查找环境变量 <code>ID</code>。<p>在使用 <code>Env</code> 变量时，需要注意的一件重要事情是：每次访问该值时都将读取它。<code>Viper</code> 在调用 <code>BindEnv</code> 时不固定该值。<p>还有一个魔法函数 <code>SetEnvKeyReplacer</code>，<code>SetEnvKeyReplacer</code> 允许你使用 <code>strings.Replacer</code> 对象来重写 <code>Env</code> 键。<p>如果你想在 <code>Get()</code> 调用中使用 <code>-</code> 或者 <code>.</code> ，但希望你的环境变量使用 <code>_</code> 分隔符，可以通过 <code>SetEnvKeyReplacer</code> 来实现。<p>比如，我们设置了环境变量 <code>USER_SECRET_KEY = bVix2WBv0VPfrDrvlLWrhEdzjLpPCNYb</code> ，但我们想用<code>viper.Get(“user.secret-key”)</code>，那我们就调用函数：<pre class="line-numbers language-go" data-language=go><code class=language-go>viper<span class="token punctuation">.</span><span class="token function">SetEnvKeyReplacer</span><span class="token punctuation">(</span>strings<span class="token punctuation">.</span><span class="token function">NewReplacer</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">,</span> <span class="token string">"_"</span><span class="token punctuation">,</span> <span class="token string">"-"</span><span class="token punctuation">,</span> <span class="token string">"_"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden=true class=line-numbers-rows><span></span></span></code></pre><p>上面的代码，在调用 <code>viper.Get()</code> 函数时，会用 <code>_</code> 替换 <code>.</code> 和 <code>-</code> 。<p>默认情况下，空环境变量被认为是未设置的，并将返回到下一个配置源。若要将空环境变量视为已设置，可以使用 <code>AllowEmptyEnv</code> 方法。<p>使用环境变量示例如下：<pre class="line-numbers language-go" data-language=go><code class=language-go><span class="token comment">// 使用环境变量</span>
os<span class="token punctuation">.</span><span class="token function">Setenv</span><span class="token punctuation">(</span><span class="token string">"VIPER_USER_SECRET_ID"</span><span class="token punctuation">,</span> <span class="token string">"QLdywI2MrmDVjSSv6e95weNRvmteRjfKAuNV"</span><span class="token punctuation">)</span>
os<span class="token punctuation">.</span><span class="token function">Setenv</span><span class="token punctuation">(</span><span class="token string">"VIPER_USER_SECRET_KEY"</span><span class="token punctuation">,</span> <span class="token string">"bVix2WBv0VPfrDrvlLWrhEdzjLpPCNYb"</span><span class="token punctuation">)</span>

viper<span class="token punctuation">.</span><span class="token function">AutomaticEnv</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 读取环境变量</span>
viper<span class="token punctuation">.</span><span class="token function">SetEnvPrefix</span><span class="token punctuation">(</span><span class="token string">"VIPER"</span><span class="token punctuation">)</span> <span class="token comment">// 设置环境变量前缀：VIPER_，如果是viper，将自动转变为大写。</span>
viper<span class="token punctuation">.</span><span class="token function">SetEnvKeyReplacer</span><span class="token punctuation">(</span>strings<span class="token punctuation">.</span><span class="token function">NewReplacer</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">,</span> <span class="token string">"_"</span><span class="token punctuation">,</span> <span class="token string">"-"</span><span class="token punctuation">,</span> <span class="token string">"_"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 将viper.Get(key) key字符串中'.'和'-'替换为'_'</span>
viper<span class="token punctuation">.</span><span class="token function">BindEnv</span><span class="token punctuation">(</span><span class="token string">"user.secret-key"</span><span class="token punctuation">)</span>
viper<span class="token punctuation">.</span><span class="token function">BindEnv</span><span class="token punctuation">(</span><span class="token string">"user.secret-id"</span><span class="token punctuation">,</span> <span class="token string">"USER_SECRET_ID"</span><span class="token punctuation">)</span> <span class="token comment">// 绑定环境变量名到key</span><span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><em><strong>6. 使用标志。</strong></em><p><code>Viper</code> 支持 <code>Pflag</code> 包，能够绑定 <code>key</code> 到 <code>Flag</code>。与 <code>BindEnv</code> 类似，在调用绑定方法时，不会设置该值，但在访问它时会设置。对于单个标志，可以调用 <code>BindPFlag()</code> 进行绑定：<pre class="line-numbers language-go" data-language=go><code class=language-go>
viper<span class="token punctuation">.</span><span class="token function">BindPFlag</span><span class="token punctuation">(</span><span class="token string">"token"</span><span class="token punctuation">,</span> pflag<span class="token punctuation">.</span><span class="token function">Lookup</span><span class="token punctuation">(</span><span class="token string">"token"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 绑定单个标志</span>
<span aria-hidden=true class=line-numbers-rows><span></span><span></span></span></code></pre><p>还可以绑定一组现有的 <code>pflags（pflag.FlagSet）</code>：<pre class="line-numbers language-go" data-language=go><code class=language-go>viper<span class="token punctuation">.</span><span class="token function">BindPFlags</span><span class="token punctuation">(</span>pflag<span class="token punctuation">.</span>CommandLine<span class="token punctuation">)</span> <span class="token comment">//绑定标志集</span><span aria-hidden=true class=line-numbers-rows><span></span></span></code></pre><h3 id=读取配置><a class=headerlink href=#读取配置 title=读取配置></a>读取配置</h3><p><code>Viper</code> 提供了如下方法来读取配置：<p><code>Get(key string) interface{}</code><p><code>Get(key string)</code><p><code>AllSettings() map[string]interface{}</code><p><code>IsSet(key string) : bool</code><p>每一个 <code>Get</code> 方法在找不到值的时候都会返回<code>零</code>值。<p>为了检查给定的键<code>是否存在</code>，可以使用 <code>IsSet()</code> 方法。<p>可以是 <code>Viper</code> 支持的类型，首字母大写：<code>Bool</code>、<code>Float64</code>、<code>Int</code>、<code>IntSlice</code>、<code>String</code>、<code>StringMap</code>、<code>StringMapString</code>、<code>StringSlice</code>、<code>Time</code>、<code>Duration</code>。例如：<code>GetInt()</code>。<p>常见的读取配置方法有以下几种。<p><em><strong>1. 访问嵌套的键。</strong></em><p>例如，加载下面的 JSON 文件：<pre class="line-numbers language-json" data-language=json><code class=language-json>
<span class="token punctuation">{</span>

	<span class="token property">"host"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
	<span class="token property">"address"</span><span class="token operator">:</span> <span class="token string">"localhost"</span><span class="token punctuation">,</span>
	<span class="token property">"port"</span><span class="token operator">:</span> <span class="token number">5799</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token property">"datastore"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
		<span class="token property">"metric"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
			<span class="token property">"host"</span><span class="token operator">:</span> <span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span>
			<span class="token property">"port"</span><span class="token operator">:</span> <span class="token number">3099</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token property">"warehouse"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
			<span class="token property">"host"</span><span class="token operator">:</span> <span class="token string">"198.0.0.1"</span><span class="token punctuation">,</span>
			<span class="token property">"port"</span><span class="token operator">:</span> <span class="token number">2112</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>Viper</code> 可以通过传入<code>.</code>分隔的路径来访问嵌套字段：<pre class="line-numbers language-go" data-language=go><code class=language-go>
viper<span class="token punctuation">.</span><span class="token function">GetString</span><span class="token punctuation">(</span><span class="token string">"datastore.metric.host"</span><span class="token punctuation">)</span> <span class="token comment">// (返回 "127.0.0.1")</span>
<span aria-hidden=true class=line-numbers-rows><span></span><span></span></span></code></pre><p>如果<code>datastore.metric</code>被直接赋值覆盖（被 <code>Flag</code>、<code>环境变量</code>、<code>set()</code> 方法等等），那么<code>datastore.metric</code>的所有子键都将变为<code>未定义状态</code>，它们被<code>高优先级配置级别</code>覆盖了。<p>如果存在与<code>分隔的键路径</code>匹配的键，则直接返回其值。例如：<pre class="line-numbers language-json" data-language=json><code class=language-json>
<span class="token punctuation">{</span>
	<span class="token property">"datastore.metric.host"</span><span class="token operator">:</span> <span class="token string">"0.0.0.0"</span><span class="token punctuation">,</span>
	<span class="token property">"host"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
		<span class="token property">"address"</span><span class="token operator">:</span> <span class="token string">"localhost"</span><span class="token punctuation">,</span>
		<span class="token property">"port"</span><span class="token operator">:</span> <span class="token number">5799</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token property">"datastore"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
		<span class="token property">"metric"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
			<span class="token property">"host"</span><span class="token operator">:</span> <span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span>
			<span class="token property">"port"</span><span class="token operator">:</span> <span class="token number">3099</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token property">"warehouse"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
			<span class="token property">"host"</span><span class="token operator">:</span> <span class="token string">"198.0.0.1"</span><span class="token punctuation">,</span>
			<span class="token property">"port"</span><span class="token operator">:</span> <span class="token number">2112</span>

		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过 <code>viper.GetString</code> 获取值：<pre class="line-numbers language-go" data-language=go><code class=language-go>viper<span class="token punctuation">.</span><span class="token function">GetString</span><span class="token punctuation">(</span><span class="token string">"datastore.metric.host"</span><span class="token punctuation">)</span> <span class="token comment">// 返回 "0.0.0.0"</span><span aria-hidden=true class=line-numbers-rows><span></span></span></code></pre><p><em><strong>2. 反序列化。</strong></em><p><code>Viper</code> 可以支持将所有或特定的值解析到<code>结构体</code>、<code>map</code> 等。<p>可以通过两个函数来实现：<br><code>Unmarshal(rawVal interface{}) error</code><br><code>UnmarshalKey(key string, rawVal interface{}) error</code><p>一个示例：<pre class="line-numbers language-go" data-language=go><code class=language-go>
<span class="token keyword">type</span> config <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Port <span class="token builtin">int</span>
	Name <span class="token builtin">string</span>
	PathMap <span class="token builtin">string</span> <span class="token string">`mapstructure:"path_map"`</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> C config

err <span class="token operator">:=</span> viper<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span><span class="token operator">&</span>C<span class="token punctuation">)</span>

<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
	t<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"unable to decode into struct, %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果想要解析那些键本身就包含<code>.</code>(默认的键分隔符）的配置，则需要修改分隔符：<pre class="line-numbers language-go" data-language=go><code class=language-go>v <span class="token operator">:=</span> viper<span class="token punctuation">.</span><span class="token function">NewWithOptions</span><span class="token punctuation">(</span>viper<span class="token punctuation">.</span><span class="token function">KeyDelimiter</span><span class="token punctuation">(</span><span class="token string">"::"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
v<span class="token punctuation">.</span><span class="token function">SetDefault</span><span class="token punctuation">(</span><span class="token string">"chart::values"</span><span class="token punctuation">,</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span>
		<span class="token string">"ingress"</span><span class="token punctuation">:</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span>
			<span class="token string">"annotations"</span><span class="token punctuation">:</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span>
				<span class="token string">"traefik.frontend.rule.type"</span><span class="token punctuation">:</span> <span class="token string">"PathPrefix"</span><span class="token punctuation">,</span>
				<span class="token string">"traefik.ingress.kubernetes.io/ssl-redirect"</span><span class="token punctuation">:</span> <span class="token string">"true"</span><span class="token punctuation">,</span>

			<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

 

<span class="token keyword">type</span> config <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Chart <span class="token keyword">struct</span><span class="token punctuation">{</span>
		Values <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

 

<span class="token keyword">var</span> C config
 

v<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span><span class="token operator">&</span>C<span class="token punctuation">)</span>
<span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>Viper</code> 在后台使用 <code>github.com/mitchellh/mapstructure</code> 来解析值，其默认情况下使用 <code>mapstructure</code> <code>tags</code>。<p>当我们需要将 <code>Viper</code> 读取的配置反序列到我们定义的结构体变量中时，一定要使用 <code>mapstructure</code> <code>tags</code>。<p><em><strong>3. 序列化成字符串。</strong></em><p>有时候我们需要将 <code>Viper</code> 中保存的所有设置序列化到一个字符串中，而不是将它们写入到一个文件中，示例如下：<pre class="line-numbers language-go" data-language=go><code class=language-go>
<span class="token keyword">import</span> <span class="token punctuation">(</span>

	yaml <span class="token string">"gopkg.in/yaml.v2"</span>
<span class="token comment">// ...</span>
<span class="token punctuation">)</span>

 

<span class="token keyword">func</span> <span class="token function">yamlStringSettings</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>

	c <span class="token operator">:=</span> viper<span class="token punctuation">.</span><span class="token function">AllSettings</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	bs<span class="token punctuation">,</span> err <span class="token operator">:=</span> yaml<span class="token punctuation">.</span><span class="token function">Marshal</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>

	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"unable to marshal config to YAML: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> <span class="token function">string</span><span class="token punctuation">(</span>bs<span class="token punctuation">)</span>

<span class="token punctuation">}</span>
<span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id=现代化的命令行框架：Cobra-全解><a title="现代化的命令行框架：Cobra 全解" class=headerlink href=#现代化的命令行框架：Cobra-全解></a>现代化的命令行框架：Cobra 全解</h2><p><code>Cobra</code> 既是一个可以创建强大的现代 <code>CLI</code> 应用程序的库，也是一个可以生成<code>应用</code>和<code>命令文件</code>的程序。<p>有许多大型项目都是用 <code>Cobra</code> 来构建应用程序的，例如 <code>Kubernetes</code>、<code>Docker</code>、<code>etcd</code>、<code>Rkt</code>、<code>Hugo</code>等。<p><code>Cobra</code> 建立在 <code>commands</code>、<code>arguments</code> 和 <code>flags</code> 结构之上。<p><code>commands</code> 代表命令，<code>arguments</code> 代表非选项参数，<code>flags</code> 代表选项参数（也叫标志）。<p>一个好的应用程序应该是易懂的，用户可以清晰地知道如何去使用这个应用程序。<p>应用程序通常遵循如下模式：<code>APPNAME VERB NOUN –ADJECTIVE</code> 或者 <code>APPNAME COMMAND ARG –FLAG</code>，例如：<pre class="line-numbers language-bash" data-language=bash><code class=language-bash><span class="token function">git</span> clone URL <span class="token parameter variable">--bare</span> <span class="token comment"># clone 是一个命令，URL是一个非选项参数，bare是一个选项参数</span><span aria-hidden=true class=line-numbers-rows><span></span></span></code></pre><p>这里，<code>VERB</code> 代表<code>动词</code>，<code>NOUN</code> 代码<code>名词</code>，<code>ADJECTIVE</code> 代表<code>形容词</code>。<p><code>Cobra</code> 提供了两种方式来创建命令：<code>Cobra 命令</code> 和 <code>Cobra 库</code>。<p><code>Cobra 命令</code> 可以生成一个 <code>Cobra 命令模板</code>，而 <code>命令模板</code> 也是通过引用 <code>Cobra 库</code>来构建命令的。<p>所以，这里我直接介绍如何使用 <code>Cobra 库</code>来创建命令。<h3 id=使用-Cobra-库创建命令><a title="使用 Cobra 库创建命令" class=headerlink href=#使用-Cobra-库创建命令></a>使用 Cobra 库创建命令</h3><p>如果要用 <code>Cobra</code> 库编码实现一个应用程序，需要首先创建一个空的 <code>main.go</code> 文件和一个 <code>rootCmd</code> 文件，之后可以根据需要添加其他命令。具体步骤如下：<p><em><strong>1. 创建 rootCmd。</strong></em><pre class="line-numbers language-bash" data-language=bash><code class=language-bash>
$ <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> newApp2 <span class="token operator">&&</span> <span class="token builtin class-name">cd</span> newApp2
<span aria-hidden=true class=line-numbers-rows><span></span><span></span></span></code></pre><p>通常情况下，我们会将 <code>rootCmd</code> 放在文件 <code>cmd/root.go</code> 中。<pre class="line-numbers language-go" data-language=go><code class=language-go>
<span class="token keyword">var</span> rootCmd <span class="token operator">=</span> <span class="token operator">&</span>cobra<span class="token punctuation">.</span>Command<span class="token punctuation">{</span>
	Use<span class="token punctuation">:</span> <span class="token string">"hugo"</span><span class="token punctuation">,</span>

	Short<span class="token punctuation">:</span> <span class="token string">"Hugo is a very fast static site generator"</span><span class="token punctuation">,</span>

	Long<span class="token punctuation">:</span> <span class="token string">`A Fast and Flexible Static Site Generator built with

	love by spf13 and friends in Go.

	Complete documentation is available at http://hugo.spf13.com`</span><span class="token punctuation">,</span>

	Run<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>cmd <span class="token operator">*</span>cobra<span class="token punctuation">.</span>Command<span class="token punctuation">,</span> args <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

	<span class="token comment">// Do Stuff Here</span>

	<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

 

<span class="token keyword">func</span> <span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

	<span class="token keyword">if</span> err <span class="token operator">:=</span> rootCmd<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>

		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>

		os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>
<span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>还可以在 <code>init()</code> 函数中定义<code>标志</code>和<code>处理配置</code>，例如 <code>cmd/root.go</code>。<pre class="line-numbers language-go" data-language=go><code class=language-go>
<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"os"</span>

	homedir <span class="token string">"github.com/mitchellh/go-homedir"</span>
	<span class="token string">"github.com/spf13/cobra"</span>
	<span class="token string">"github.com/spf13/viper"</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> <span class="token punctuation">(</span>
	cfgFile <span class="token builtin">string</span>

	projectBase <span class="token builtin">string</span>

	userLicense <span class="token builtin">string</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

	cobra<span class="token punctuation">.</span><span class="token function">OnInitialize</span><span class="token punctuation">(</span>initConfig<span class="token punctuation">)</span>

	rootCmd<span class="token punctuation">.</span><span class="token function">PersistentFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">StringVar</span><span class="token punctuation">(</span><span class="token operator">&</span>cfgFile<span class="token punctuation">,</span> <span class="token string">"config"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">"config file (default is $HOME/.cobra.yaml)"</span><span class="token punctuation">)</span>

	rootCmd<span class="token punctuation">.</span><span class="token function">PersistentFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">StringVarP</span><span class="token punctuation">(</span><span class="token operator">&</span>projectBase<span class="token punctuation">,</span> <span class="token string">"projectbase"</span><span class="token punctuation">,</span> <span class="token string">"b"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">"base project directory eg. github.com/spf13/"</span><span class="token punctuation">)</span>

	rootCmd<span class="token punctuation">.</span><span class="token function">PersistentFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">StringP</span><span class="token punctuation">(</span><span class="token string">"author"</span><span class="token punctuation">,</span> <span class="token string">"a"</span><span class="token punctuation">,</span> <span class="token string">"YOUR NAME"</span><span class="token punctuation">,</span> <span class="token string">"Author name for copyright attribution"</span><span class="token punctuation">)</span>

	rootCmd<span class="token punctuation">.</span><span class="token function">PersistentFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">StringVarP</span><span class="token punctuation">(</span><span class="token operator">&</span>userLicense<span class="token punctuation">,</span> <span class="token string">"license"</span><span class="token punctuation">,</span> <span class="token string">"l"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">"Name of license for the project (can provide `licensetext` in config)"</span><span class="token punctuation">)</span>

	rootCmd<span class="token punctuation">.</span><span class="token function">PersistentFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Bool</span><span class="token punctuation">(</span><span class="token string">"viper"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">"Use Viper for configuration"</span><span class="token punctuation">)</span>

	viper<span class="token punctuation">.</span><span class="token function">BindPFlag</span><span class="token punctuation">(</span><span class="token string">"author"</span><span class="token punctuation">,</span> rootCmd<span class="token punctuation">.</span><span class="token function">PersistentFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Lookup</span><span class="token punctuation">(</span><span class="token string">"author"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

	viper<span class="token punctuation">.</span><span class="token function">BindPFlag</span><span class="token punctuation">(</span><span class="token string">"projectbase"</span><span class="token punctuation">,</span> rootCmd<span class="token punctuation">.</span><span class="token function">PersistentFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Lookup</span><span class="token punctuation">(</span><span class="token string">"projectbase"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

	viper<span class="token punctuation">.</span><span class="token function">BindPFlag</span><span class="token punctuation">(</span><span class="token string">"useViper"</span><span class="token punctuation">,</span> rootCmd<span class="token punctuation">.</span><span class="token function">PersistentFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Lookup</span><span class="token punctuation">(</span><span class="token string">"viper"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

	viper<span class="token punctuation">.</span><span class="token function">SetDefault</span><span class="token punctuation">(</span><span class="token string">"author"</span><span class="token punctuation">,</span> <span class="token string">"NAME HERE &LTEMAIL ADDRESS>"</span><span class="token punctuation">)</span>

	viper<span class="token punctuation">.</span><span class="token function">SetDefault</span><span class="token punctuation">(</span><span class="token string">"license"</span><span class="token punctuation">,</span> <span class="token string">"apache"</span><span class="token punctuation">)</span>

<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">initConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

	<span class="token comment">// Don't forget to read config either from cfgFile or from home directory!</span>

	<span class="token keyword">if</span> cfgFile <span class="token operator">!=</span> <span class="token string">""</span> <span class="token punctuation">{</span>

		<span class="token comment">// Use config file from the flag.</span>

		viper<span class="token punctuation">.</span><span class="token function">SetConfigFile</span><span class="token punctuation">(</span>cfgFile<span class="token punctuation">)</span>

	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>

		<span class="token comment">// Find home directory.</span>

		home<span class="token punctuation">,</span> err <span class="token operator">:=</span> homedir<span class="token punctuation">.</span><span class="token function">Dir</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>

			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>

			os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

		<span class="token punctuation">}</span>

		<span class="token comment">// Search config in home directory with name ".cobra" (without extension).</span>

		viper<span class="token punctuation">.</span><span class="token function">AddConfigPath</span><span class="token punctuation">(</span>home<span class="token punctuation">)</span>

		viper<span class="token punctuation">.</span><span class="token function">SetConfigName</span><span class="token punctuation">(</span><span class="token string">".cobra"</span><span class="token punctuation">)</span>

	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> err <span class="token operator">:=</span> viper<span class="token punctuation">.</span><span class="token function">ReadInConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>

		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Can't read config:"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>

		os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>
<span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><em><strong>2. 创建 main.go。</strong></em><p>我们还需要一个 <code>main</code> 函数来调用 <code>rootCmd</code>，通常我们会创建一个 <code>main.go</code> 文件，在 <code>main.go</code> 中调用 <code>rootCmd.Execute()</code> 来执行命令：<pre class="line-numbers language-go" data-language=go><code class=language-go>
<span class="token keyword">package</span> main
<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"{pathToYourApp}/cmd"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	cmd<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>需要注意，<code>main.go</code> 中不建议放很多代码，通常只需要调用 <code>cmd.Execute()</code> 即可。<p><em><strong>3. 添加命令。</strong></em><p>除了 <code>rootCmd</code>，我们还可以调用 <code>AddCommand</code> 添加其他命令，通常情况下，我们会把其他命令的源码文件放在 <code>cmd/</code> 目录下，例如，我们添加一个 <code>version</code> 命令，可以创建 <code>cmd/version.go</code> 文件，内容为：<pre class="line-numbers language-go" data-language=go><code class=language-go><span class="token keyword">package</span> cmd

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>

	<span class="token string">"github.com/spf13/cobra"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

	rootCmd<span class="token punctuation">.</span><span class="token function">AddCommand</span><span class="token punctuation">(</span>versionCmd<span class="token punctuation">)</span>

<span class="token punctuation">}</span>

<span class="token keyword">var</span> versionCmd <span class="token operator">=</span> <span class="token operator">&</span>cobra<span class="token punctuation">.</span>Command<span class="token punctuation">{</span>

	Use<span class="token punctuation">:</span> <span class="token string">"version"</span><span class="token punctuation">,</span>

	Short<span class="token punctuation">:</span> <span class="token string">"Print the version number of Hugo"</span><span class="token punctuation">,</span>

	Long<span class="token punctuation">:</span> <span class="token string">`All software has versions. This is Hugo's`</span><span class="token punctuation">,</span>

	Run<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>cmd <span class="token operator">*</span>cobra<span class="token punctuation">.</span>Command<span class="token punctuation">,</span> args <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Hugo Static Site Generator v0.9 -- HEAD"</span><span class="token punctuation">)</span>

	<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>本示例中，我们通过调用<code>rootCmd.AddCommand(versionCmd)</code>给 <code>rootCmd</code> 命令添加了一个 <code>versionCmd</code> 命令。<p>编译并运行。<p>将 <code>main.go</code> 中 <code>{pathToYourApp}</code> 替换为对应的路径，例如本示例中 <code>pathToYourApp</code> 为<code>github.com/marmotedu/gopractise-demo/cobra/newApp2</code>。<pre class="line-numbers language-bash" data-language=bash><code class=language-bash>
$ go mod init github.com/marmotedu/gopractise-demo/cobra/newApp2

$ go build <span class="token parameter variable">-v</span> <span class="token builtin class-name">.</span>

$ ./newApp2 <span class="token parameter variable">-h</span>

A Fast and Flexible Static Site Generator built with

love by spf13 and friends <span class="token keyword">in</span> Go.

Complete documentation is available at http://hugo.spf13.com

 

Usage:

hugo <span class="token punctuation">[</span>flags<span class="token punctuation">]</span>

hugo <span class="token punctuation">[</span>command<span class="token punctuation">]</span>

 

Available Commands:

<span class="token builtin class-name">help</span> Help about any <span class="token builtin class-name">command</span>

version Print the version number of Hugo

 

Flags:

-a, <span class="token parameter variable">--author</span> string Author name <span class="token keyword">for</span> copyright attribution <span class="token punctuation">(</span>default <span class="token string">"YOUR NAME"</span><span class="token punctuation">)</span>

<span class="token parameter variable">--config</span> string config <span class="token function">file</span> <span class="token punctuation">(</span>default is <span class="token environment constant">$HOME</span>/.cobra.yaml<span class="token punctuation">)</span>

-h, <span class="token parameter variable">--help</span> <span class="token builtin class-name">help</span> <span class="token keyword">for</span> hugo

-l, <span class="token parameter variable">--license</span> licensetext Name of license <span class="token keyword">for</span> the project <span class="token punctuation">(</span>can provide licensetext <span class="token keyword">in</span> config<span class="token punctuation">)</span>

-b, <span class="token parameter variable">--projectbase</span> string base project directory eg. github.com/spf13/

<span class="token parameter variable">--viper</span> Use Viper <span class="token keyword">for</span> configuration <span class="token punctuation">(</span>default <span class="token boolean">true</span><span class="token punctuation">)</span>

 

Use <span class="token string">"hugo [command] --help"</span> <span class="token keyword">for</span> <span class="token function">more</span> information about a command.
<span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过<code>步骤一</code>、<code>步骤二</code>、<code>步骤三</code>，我们就成<code>功创建</code>和<code>添加</code>了 <code>Cobra 应用程序</code> 及其 <code>命令</code>。<p>接下来，我再来详细介绍下 <code>Cobra</code> 的核心特性。<h3 id=使用标志><a class=headerlink href=#使用标志 title=使用标志></a>使用标志</h3><p><code>Cobra</code> 可以跟 <code>Pflag</code> 结合使用，实现强大的标志功能。使用步骤如下：<p><em><strong>使用持久化的标志。</strong></em><p>标志可以是“持久的”，这意味着该标志可用于它所分配的命令以及该命令下的每个子命令。可以在 <code>rootCmd</code> 上定义持久标志：<pre class="line-numbers language-go" data-language=go><code class=language-go>rootCmd<span class="token punctuation">.</span><span class="token function">PersistentFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">BoolVarP</span><span class="token punctuation">(</span><span class="token operator">&</span>Verbose<span class="token punctuation">,</span> <span class="token string">"verbose"</span><span class="token punctuation">,</span> <span class="token string">"v"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">"verbose output"</span><span class="token punctuation">)</span><span aria-hidden=true class=line-numbers-rows><span></span></span></code></pre><p><em><strong>使用本地标志。</strong></em><p>也可以分配一个本地标志，本地标志只能在它所绑定的命令上使用：<pre class="line-numbers language-go" data-language=go><code class=language-go>rootCmd<span class="token punctuation">.</span><span class="token function">Flags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">StringVarP</span><span class="token punctuation">(</span><span class="token operator">&</span>Source<span class="token punctuation">,</span> <span class="token string">"source"</span><span class="token punctuation">,</span> <span class="token string">"s"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">"Source directory to read from"</span><span class="token punctuation">)</span><span aria-hidden=true class=line-numbers-rows><span></span></span></code></pre><p><code>–source</code>标志只能在 <code>rootCmd</code> 上引用，而不能在 <code>rootCmd</code> 的<code>子命令</code>上引用。<p><em><strong>将标志绑定到 Viper。</strong></em><p>我们可以将标志绑定到 <code>Viper</code> ，这样就可以使用 <code>viper.Get()</code> 获取标志的值。<pre class="line-numbers language-go" data-language=go><code class=language-go>
<span class="token keyword">var</span> author <span class="token builtin">string</span>

<span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

	rootCmd<span class="token punctuation">.</span><span class="token function">PersistentFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">StringVar</span><span class="token punctuation">(</span><span class="token operator">&</span>author<span class="token punctuation">,</span> <span class="token string">"author"</span><span class="token punctuation">,</span> <span class="token string">"YOUR NAME"</span><span class="token punctuation">,</span> <span class="token string">"Author name for copyright attribution"</span><span class="token punctuation">)</span>

	viper<span class="token punctuation">.</span><span class="token function">BindPFlag</span><span class="token punctuation">(</span><span class="token string">"author"</span><span class="token punctuation">,</span> rootCmd<span class="token punctuation">.</span><span class="token function">PersistentFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Lookup</span><span class="token punctuation">(</span><span class="token string">"author"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">}</span>
<span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><em><strong>设置标志为必选。</strong></em><p>默认情况下，标志是<code>可选</code>的，我们也可以设置标志为<code>必选</code>，当设置标志为<code>必选</code>，但是没有提供标志时，<code>Cobra</code> 会报错。<pre class="line-numbers language-go" data-language=go><code class=language-go>rootCmd<span class="token punctuation">.</span><span class="token function">Flags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">StringVarP</span><span class="token punctuation">(</span><span class="token operator">&</span>Region<span class="token punctuation">,</span> <span class="token string">"region"</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">"AWS region (required)"</span><span class="token punctuation">)</span>
rootCmd<span class="token punctuation">.</span><span class="token function">MarkFlagRequired</span><span class="token punctuation">(</span><span class="token string">"region"</span><span class="token punctuation">)</span><span aria-hidden=true class=line-numbers-rows><span></span><span></span></span></code></pre><h3 id=非选项参数验证><a class=headerlink href=#非选项参数验证 title=非选项参数验证></a>非选项参数验证</h3><p>在命令的过程中，经常会传入非选项参数，并且需要对这些非选项参数进行验证，<code>Cobra</code> 提供了机制来对非选项参数进行验证。可以使用 <code>Command</code> 的 <code>Args</code> 字段来验证非选项参数。<p><code>Cobra</code> 也内置了一些验证函数：<p><code>NoArgs</code>：如果存在任何非选项参数，该命令将报错。<p><code>ArbitraryArgs</code>：该命令将接受任何非选项参数。<p><code>OnlyValidArgs</code>：如果有任何非选项参数不在 <code>Command</code> 的 <code>ValidArgs</code> 字段中，该命令将报错。<p><code>MinimumNArgs(int)</code>：如果没有至少 <code>N</code> 个非选项参数，该命令将报错。<p><code>MaximumNArgs(int)</code>：如果有多于 <code>N</code> 个非选项参数，该命令将报错。<p><code>ExactArgs(int)</code>：如果非选项参数个数不为 N，该命令将报错。<p><code>ExactValidArgs(int)</code>：如果非选项参数的个数不为 <code>N</code>，或者非选项参数不在 <code>Command</code> 的 <code>ValidArgs</code> 字段中，该命令将报错。<p><code>RangeArgs(min, max)</code>：如果非选项参数的个数不在 <code>min</code> 和 <code>max</code> 之间，该命令将报错。<p>使用<code>预定义验证函数</code>，示例如下：<pre class="line-numbers language-go" data-language=go><code class=language-go>
<span class="token keyword">var</span> cmd <span class="token operator">=</span> <span class="token operator">&</span>cobra<span class="token punctuation">.</span>Command<span class="token punctuation">{</span>

	Short<span class="token punctuation">:</span> <span class="token string">"hello"</span><span class="token punctuation">,</span>

	Args<span class="token punctuation">:</span> cobra<span class="token punctuation">.</span><span class="token function">MinimumNArgs</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 使用内置的验证函数</span>

	Run<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>cmd <span class="token operator">*</span>cobra<span class="token punctuation">.</span>Command<span class="token punctuation">,</span> args <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Hello, World!"</span><span class="token punctuation">)</span>

	<span class="token punctuation">}</span><span class="token punctuation">,</span>

<span class="token punctuation">}</span>
<span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>当然你也可以<code>自定义验证函数</code>，示例如下：<pre class="line-numbers language-go" data-language=go><code class=language-go>
<span class="token keyword">var</span> cmd <span class="token operator">=</span> <span class="token operator">&</span>cobra<span class="token punctuation">.</span>Command<span class="token punctuation">{</span>

	Short<span class="token punctuation">:</span> <span class="token string">"hello"</span><span class="token punctuation">,</span>
	<span class="token comment">// Args: cobra.MinimumNArgs(10), // 使用内置的验证函数</span>
	Args<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>cmd <span class="token operator">*</span>cobra<span class="token punctuation">.</span>Command<span class="token punctuation">,</span> args <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span> <span class="token comment">// 自定义验证函数</span>
		<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token operator"><</span> <span class="token number">1</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"requires at least one arg"</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> myapp<span class="token punctuation">.</span><span class="token function">IsValidColor</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"invalid color specified: %s"</span><span class="token punctuation">,</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	Run<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>cmd <span class="token operator">*</span>cobra<span class="token punctuation">.</span>Command<span class="token punctuation">,</span> args <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Hello, World!"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id=PreRun-and-PostRun-Hooks><a title="PreRun and PostRun Hooks" class=headerlink href=#PreRun-and-PostRun-Hooks></a>PreRun and PostRun Hooks</h3><p>在运行 <code>Run</code> 函数时，我们可以运行一些钩子函数，比如 <code>PersistentPreRun</code> 和 <code>PreRun</code> 函数在 <code>Run</code> 函数之前执行，<code>PersistentPostRun</code> 和 <code>PostRun</code> 在 <code>Run</code> 函数之后执行。<p>如果<code>子命令</code>没有指定 <code>Persistent_Run</code> 函数，则 <code>子命令</code> 将会继承 <code>父命令</code> 的 <code>Persistent_Run</code> 函数。这些函数的运行顺序如下：<p><code>PersistentPreRun</code><p><code>PreRun</code><p><code>Run</code><p><code>PostRun</code><p><code>PersistentPostRun</code><p>注意，父级的 <code>PreRun</code> 只会在<code>父级命令</code>运行时调用，<code>子命令</code>是不会调用的。<p><code>Cobra</code> 还支持很多其他有用的特性，<p>比如：<br>自定义 <code>Help</code> 命令；<br>可以自动添加<code>–version</code>标志，输出程序版本信息；<br>当用户提供无效标志或无效命令时，<code>Cobra</code> 可以打印出 usage 信息；<br>当我们输入的命令有误时，<code>Cobra</code> 会根据注册的命令，推算出可能的命令，等等。<h2 id=总结><a class=headerlink href=#总结 title=总结></a>总结</h2><p>在开发 <code>Go</code> 项目时，我们可以通过 <code>Pflag</code> 来解析命令行参数，通过 <code>Viper</code> 来解析配置文件，用 <code>Cobra</code> 来实现命令行框架。<p>你可以通过 <code>pflag.String()</code>、 <code>pflag.StringP()</code>、<code>pflag.StringVar()</code>、<code>pflag.StringVarP()</code> 方法来设置命令行参数，并使用 <code>Get</code> 来获取参数的值。<p>同时，你也可以使用 <code>Viper</code> 从 <code>命令行参数</code>、<code>环境变量</code>、<code>配置文件</code>等位置<code>读取配置项</code>。<p>最常用的是从 <code>配置文件</code> 中读取，可以通过 <code>viper.AddConfigPath</code> 来设置<code>配置文件</code>搜索路径，通过 <code>viper.SetConfigFile</code> 和 <code>viper.SetConfigType</code> 来设置配置文件名，通过 <code>viper.ReadInConfig</code> 来读取配置文件。<p>读取完配置文件，然后在程序中使用 <code>Get/Get</code> 来读取配置项的值。<p>最后，你可以使用 <code>Cobra</code> 来构建一个命令行框架，<code>Cobra</code> 可以很好地集成 <code>Pflag</code> 和 <code>Viper</code>。</div><footer class=post-footer><div class=post-tags><a href=/tags/Golang/ rel=tag># Golang</a><a href=/tags/IAM/ rel=tag># IAM</a><a href=/tags/Pflag/ rel=tag># Pflag</a><a href=/tags/Viper/ rel=tag># Viper</a><a href=/tags/Cobra/ rel=tag># Cobra</a></div><div class=post-nav><div class=post-nav-item><a title="Go 之 更正源文件中经常拼写错误的英文单词" href=/post/2023-golang-tips-go-misspell.html rel=prev> <i class="fa fa-chevron-left"></i> Go 之 更正源文件中经常拼写错误的英文单词 </a></div><div class=post-nav-item><a title="16 | 应用构建：构建一个优秀的企业应用框架" href=/post/2023-golang-practice-%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-16-build-app-cobra.html rel=next> 16 | 应用构建：构建一个优秀的企业应用框架 <i class="fa fa-chevron-right"></i> </a></div></div></footer></article></div></div></main><footer class=footer><div class=footer-inner><div class=copyright>© <span itemprop=copyrightYear>2024</span><span class=with-love> <i class="fa fa-heart"></i> </span><span class=author itemprop=copyrightHolder>gzwillyy</span></div></div></footer><div aria-label=返回顶部 class=back-to-top role=button><i class="fa fa-arrow-up fa-lg"></i><span>0%</span></div><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><script crossorigin=anonymous integrity=sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY= src=https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js></script><script src=/js/comments.js></script><script src=/js/utils.js></script><script src=/js/motion.js></script><script src=/js/next-boot.js></script><script crossorigin=anonymous integrity=sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc= src=https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js></script><script src=/js/third-party/search/local-search.js></script>