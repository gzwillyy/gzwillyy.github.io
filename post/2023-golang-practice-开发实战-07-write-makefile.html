<!doctypehtml><html lang=zh-CN><meta charset=UTF-8><meta content=width=device-width name=viewport><meta content=#222 name=theme-color><meta content="Hexo 6.3.0" name=generator><link href=/images/apple-touch-icon-next.png rel=apple-touch-icon sizes=180x180><link href=/images/favicon-32x32-next.png rel=icon sizes=32x32 type=image/png><link href=/images/favicon-16x16-next.png rel=icon sizes=16x16 type=image/png><link color=#222 href=/images/logo.svg rel=mask-icon><style>:root{--body-bg-color:#f5f7f9;--content-bg-color:#fff;--card-bg-color:#f5f5f5;--text-color:#555;--blockquote-color:#666;--link-color:#555;--link-hover-color:#222;--brand-color:#fff;--brand-hover-color:#fff;--table-row-odd-bg-color:#f9f9f9;--table-row-hover-bg-color:#f5f5f5;--menu-item-bg-color:#f5f5f5;--theme-color:#222;--btn-default-bg:#fff;--btn-default-color:#555;--btn-default-border-color:#555;--btn-default-hover-bg:#222;--btn-default-hover-color:#fff;--btn-default-hover-border-color:#222;--highlight-background:#f3f3f3;--highlight-foreground:#444;--highlight-gutter-background:#e1e1e1;--highlight-gutter-foreground:#555;color-scheme:light}html{line-height:1.15;-webkit-text-size-adjust:100%}details,main{display:block}pre{font-size:1em;overflow:auto;padding:10px;position:relative}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,samp{font-family:monospace,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,input{overflow:visible}button,select{text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:ButtonText dotted 1px}fieldset{padding:.35em .75em .625em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}progress{vertical-align:baseline}.table-container,textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}summary{display:list-item}[hidden],template{display:none}::selection{background:#262a30;color:#eee}body,html{height:100%}body{margin:0;background:var(--body-bg-color);box-sizing:border-box;color:var(--text-color);font-family:EB Garamond,'Noto Serif SC','PingFang SC','Microsoft YaHei',sans-serif;font-size:1em;line-height:2;min-height:100%;position:relative;transition:padding .2s ease-in-out}h1,h2,h3,h4,h5,h6{font-family:EB Garamond,'Noto Serif SC','PingFang SC','Microsoft YaHei',sans-serif;font-weight:700;line-height:1.5;margin:30px 0 15px}h1{font-size:1.5em}h2{font-size:1.375em}h3{font-size:1.25em}h4{font-size:1.125em}h5{font-size:1em}h6{font-size:.875em}p{margin:0 0 20px}a{background:0 0;border-bottom:1px solid #999;color:var(--link-color);cursor:pointer;outline:0;text-decoration:none;overflow-wrap:break-word}a:hover{border-bottom-color:var(--link-hover-color);color:var(--link-hover-color)}embed,iframe,img,video{display:block;margin-left:auto;margin-right:auto;max-width:100%}hr{box-sizing:content-box;overflow:visible;background-image:repeating-linear-gradient(-45deg,#ddd,#ddd 4px,transparent 4px,transparent 8px);border:0;height:3px;margin:40px 0}blockquote{border-left:4px solid #ddd;color:var(--blockquote-color);margin:0;padding:0 15px}blockquote cite::before{content:'-';padding:0 5px}dt{font-weight:700}dd{margin:0;padding:0}table{border-collapse:collapse;border-spacing:0;font-size:.875em;margin:0 0 20px;width:100%}tbody tr:nth-of-type(odd){background:var(--table-row-odd-bg-color)}tbody tr:hover{background:var(--table-row-hover-bg-color)}caption,td,th{padding:8px}td,th{border:1px solid #ddd;border-bottom:3px solid #ddd}th{font-weight:700;padding-bottom:10px}td{border-bottom-width:1px}.btn{background:var(--btn-default-bg);border:2px solid var(--btn-default-border-color);border-radius:2px;color:var(--btn-default-color);display:inline-block;font-size:.875em;line-height:2;padding:0 20px;transition:background-color .2s ease-in-out}.btn:hover{background:var(--btn-default-hover-bg);border-color:var(--btn-default-hover-border-color);color:var(--btn-default-hover-color)}.btn+.btn{margin:0 0 8px 8px}.btn .fa-fw{text-align:left;width:1.285714285714286em}.toggle{line-height:0}.toggle .toggle-line{background:#fff;display:block;height:2px;left:0;position:relative;top:0;transition:.4s;width:100%}.toggle .toggle-line:first-child{margin-top:1px}.toggle .toggle-line:not(:first-child){margin-top:4px}.toggle.toggle-arrow :first-child{left:50%;top:2px;transform:rotate(45deg);width:50%}.toggle.toggle-arrow :last-child{left:50%;top:-2px;transform:rotate(-45deg);width:50%}.toggle.toggle-close :nth-child(2){opacity:0}.toggle.toggle-close :first-child{top:6px;transform:rotate(45deg)}.toggle.toggle-close :last-child{top:-6px;transform:rotate(-45deg)}code[class*=language-],pre[class*=language-]{color:#000;background:0 0;text-shadow:0 1px #fff;font-family:Consolas,Monaco,'Andale Mono','Ubuntu Mono',monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-] ::-moz-selection,code[class*=language-]::-moz-selection,pre[class*=language-] ::-moz-selection,pre[class*=language-]::-moz-selection{text-shadow:none;background:#b3d4fc}code[class*=language-] ::selection,code[class*=language-]::selection,pre[class*=language-] ::selection,pre[class*=language-]::selection{text-shadow:none;background:#b3d4fc}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#f5f2f0}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#999}.token.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#905}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#690}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{color:#9a6e3a;background:hsla(0,0%,100%,.5)}.token.atrule,.token.attr-value,.token.keyword{color:#07a}.token.class-name,.token.function{color:#dd4a68}.token.important,.token.regex,.token.variable{color:#e90}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}pre[class*=language-].line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}pre[class*=language-].line-numbers>code{position:relative;white-space:inherit}.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:0;font-size:100%;left:-3.8em;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.line-numbers-rows>span{display:block;counter-increment:linenumber}.line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.highlight:hover .copy-btn,pre:hover .copy-btn{opacity:1}figure.highlight .table-container{position:relative}.copy-btn{color:#333;cursor:pointer;line-height:1.6;opacity:0;padding:2px 6px;position:absolute;transition:opacity .2s ease-in-out;background-color:#eee;background-image:linear-gradient(#fcfcfc,#eee);border:1px solid #d5d5d5;border-radius:3px;font-size:.8125em;right:4px;top:8px}code,figure.highlight,kbd,pre{background:var(--highlight-background);color:var(--highlight-foreground)}figure.highlight,pre{line-height:1.6;margin:0 auto 20px}figure.highlight figcaption,pre .caption,pre figcaption{background:var(--highlight-gutter-background);color:var(--highlight-foreground);display:flow-root;font-size:.875em;line-height:1.2;padding:.5em}figure.highlight figcaption a,pre .caption a,pre figcaption a{color:var(--highlight-foreground);float:right}figure.highlight figcaption a:hover,pre .caption a:hover,pre figcaption a:hover{border-bottom-color:var(--highlight-foreground)}code,pre{font-family:JetBrains Mono,consolas,Menlo,monospace,'PingFang SC','Microsoft YaHei'}code{border-radius:3px;font-size:.875em;padding:2px 4px;overflow-wrap:break-word}kbd{border:2px solid #ccc;border-radius:.2em;box-shadow:.1em .1em .2em rgba(0,0,0,.1);font-family:inherit;padding:.1em .3em;white-space:nowrap}figure.highlight{overflow:auto;position:relative}figure.highlight pre{border:0;margin:0;padding:10px 0}figure.highlight table{border:0;margin:0;width:auto}figure.highlight td{border:0;padding:0}figure.highlight .gutter{-moz-user-select:none;-ms-user-select:none;-webkit-user-select:none;user-select:none}figure.highlight .gutter pre{background:var(--highlight-gutter-background);color:var(--highlight-gutter-foreground);padding-left:10px;padding-right:10px;text-align:right}figure.highlight .code pre{padding-left:10px;width:100%}figure.highlight .marked{background:rgba(0,0,0,.3)}pre .caption,pre figcaption{margin-bottom:10px}.gist table{width:auto}.gist table td{border:0}pre code{background:0 0;padding:0;text-shadow:none}.blockquote-center{border-left:0;margin:40px 0;padding:0;position:relative;text-align:center}.blockquote-center::after,.blockquote-center::before{left:0;line-height:1;opacity:.6;position:absolute;width:100%}.blockquote-center::before{border-top:1px solid #ccc;text-align:left;top:-20px;content:'\f10d';font-family:'Font Awesome 6 Free';font-weight:900}.blockquote-center::after{border-bottom:1px solid #ccc;bottom:-20px;text-align:right;content:'\f10e';font-family:'Font Awesome 6 Free';font-weight:900}.blockquote-center div,.blockquote-center p{text-align:center}.group-picture{margin-bottom:20px}.group-picture .group-picture-row{display:flex;gap:3px;margin-bottom:3px}.group-picture .group-picture-column{flex:1}.group-picture .group-picture-column img{height:100%;margin:0;object-fit:cover;width:100%}.post-body .label{color:#555;padding:0 2px}.post-body .label.default{background:#f0f0f0}.post-body .label.primary{background:#efe6f7}.post-body .label.info{background:#e5f2f8}.post-body .label.success{background:#e7f4e9}.post-body .label.warning{background:#fcf6e1}.post-body .label.danger{background:#fae8eb}.post-body .link-grid{display:grid;grid-gap:1.5rem;gap:1.5rem;grid-template-columns:1fr 1fr;margin-bottom:20px;padding:1rem}.post-body .link-grid .link-grid-container{border:solid #ddd;box-shadow:1rem 1rem .5rem rgba(0,0,0,.5);min-height:5rem;min-width:0;padding:.5rem;position:relative;transition:background .3s}.post-body .link-grid .link-grid-container:hover{animation:.5s next-shake;background:var(--card-bg-color)}.post-body .link-grid .link-grid-container:active{box-shadow:.5rem .5rem .25rem rgba(0,0,0,.5);transform:translate(.2rem,.2rem)}.post-body .link-grid .link-grid-container .link-grid-image{border:1px solid #ddd;border-radius:50%;box-sizing:border-box;height:5rem;padding:3px;position:absolute;width:5rem}.post-body .link-grid .link-grid-container p{margin:0 1rem 0 6rem}.post-body .link-grid .link-grid-container p:first-of-type{font-size:1.2em}.post-body .link-grid .link-grid-container p:last-of-type{font-size:.8em;line-height:1.3rem;opacity:.7}.post-body .link-grid .link-grid-container a{border:0;height:100%;left:0;position:absolute;top:0;width:100%}@keyframes next-shake{0%{transform:translate(1pt,1pt) rotate(0)}10%{transform:translate(-1pt,-2pt) rotate(-1deg)}20%{transform:translate(-3pt,0) rotate(1deg)}30%{transform:translate(3pt,2pt) rotate(0)}40%{transform:translate(1pt,-1pt) rotate(1deg)}50%{transform:translate(-1pt,2pt) rotate(-1deg)}60%{transform:translate(-3pt,1pt) rotate(0)}70%{transform:translate(3pt,1pt) rotate(-1deg)}80%{transform:translate(-1pt,-1pt) rotate(1deg)}90%{transform:translate(1pt,2pt) rotate(0)}100%{transform:translate(1pt,-2pt) rotate(-1deg)}}.post-body .note{border-radius:3px;margin-bottom:20px;padding:1em;position:relative;border:1px solid #eee;border-left-width:5px}.post-body .note summary{cursor:pointer;outline:0}.post-body .note summary p{display:inline}.post-body .note h2,.post-body .note h3,.post-body .note h4,.post-body .note h5,.post-body .note h6{border-bottom:initial;margin:0;padding-top:0}.post-body .note :first-child{margin-top:0}.post-body .note :last-child{margin-bottom:0}.post-body .note.default{border-left-color:#777}.post-body .note.default h2,.post-body .note.default h3,.post-body .note.default h4,.post-body .note.default h5,.post-body .note.default h6{color:#777}.post-body .note.primary{border-left-color:#6f42c1}.post-body .note.primary h2,.post-body .note.primary h3,.post-body .note.primary h4,.post-body .note.primary h5,.post-body .note.primary h6{color:#6f42c1}.post-body .note.info{border-left-color:#428bca}.post-body .note.info h2,.post-body .note.info h3,.post-body .note.info h4,.post-body .note.info h5,.post-body .note.info h6{color:#428bca}.post-body .note.success{border-left-color:#5cb85c}.post-body .note.success h2,.post-body .note.success h3,.post-body .note.success h4,.post-body .note.success h5,.post-body .note.success h6{color:#5cb85c}.post-body .note.warning{border-left-color:#f0ad4e}.post-body .note.warning h2,.post-body .note.warning h3,.post-body .note.warning h4,.post-body .note.warning h5,.post-body .note.warning h6{color:#f0ad4e}.post-body .note.danger{border-left-color:#d9534f}.post-body .note.danger h2,.post-body .note.danger h3,.post-body .note.danger h4,.post-body .note.danger h5,.post-body .note.danger h6{color:#d9534f}.post-body .tabs{margin-bottom:20px}.post-body .tabs,.tabs-comment{padding-top:10px}.post-body .tabs ul.nav-tabs,.tabs-comment ul.nav-tabs{background:var(--content-bg-color);display:flex;display:flex;flex-wrap:wrap;justify-content:center;margin:0;padding:0;position:-webkit-sticky;position:sticky;top:0;z-index:5}.post-body .tabs ul.nav-tabs li.tab,.tabs-comment ul.nav-tabs li.tab{border-bottom:1px solid #ddd;border-left:1px solid transparent;border-right:1px solid transparent;border-radius:0;border-top:3px solid transparent;flex-grow:1;list-style-type:none}@media (max-width:413px){.post-body .tabs ul.nav-tabs,.tabs-comment ul.nav-tabs{display:block;margin-bottom:5px}.post-body .tabs ul.nav-tabs li.tab,.tabs-comment ul.nav-tabs li.tab{border-bottom:1px solid transparent;border-left:3px solid transparent;border-right:1px solid transparent;border-top:1px solid transparent;border-radius:0}}.post-body .tabs ul.nav-tabs li.tab a,.tabs-comment ul.nav-tabs li.tab a{border-bottom:initial;display:block;line-height:1.8;padding:.25em .75em;text-align:center;transition:.2s ease-out}.post-body .tabs ul.nav-tabs li.tab a i,.tabs-comment ul.nav-tabs li.tab a i{width:1.285714285714286em}.post-body .tabs ul.nav-tabs li.tab.active,.tabs-comment ul.nav-tabs li.tab.active{border-color:#fc6423 #ddd transparent}@media (max-width:413px){.post-body .tabs ul.nav-tabs li.tab.active,.tabs-comment ul.nav-tabs li.tab.active{border-color:#ddd #ddd #ddd #fc6423}}.post-body .tabs ul.nav-tabs li.tab.active a,.tabs-comment ul.nav-tabs li.tab.active a{cursor:default}.post-body .tabs .tab-content,.tabs-comment .tab-content{border:1px solid #ddd;border-radius:0;border-top-color:transparent}@media (max-width:413px){.post-body .tabs .tab-content,.tabs-comment .tab-content{border-radius:0;border-top-color:#ddd}}.post-body .tabs .tab-content .tab-pane,.tabs-comment .tab-content .tab-pane{padding:20px 20px 0}.post-body .tabs .tab-content .tab-pane:not(.active),.tabs-comment .tab-content .tab-pane:not(.active){display:none}.pagination .next,.pagination .page-number,.pagination .prev,.pagination .space{display:inline-block;margin:-1px 10px 0;padding:0 10px}.pagination .page-number.current{background:#ccc;border-color:#ccc;color:var(--content-bg-color)}.pagination{border-top:1px solid #eee;margin:120px 0 0;text-align:center}.pagination .next,.pagination .page-number,.pagination .prev{border-bottom:0;border-top:1px solid #eee;transition:border-color .2s ease-in-out}.pagination .next:hover,.pagination .page-number:hover,.pagination .prev:hover{border-top-color:var(--link-hover-color)}@media (max-width:767px){.post-body .link-grid{grid-template-columns:1fr}.pagination .next,.pagination .page-number,.pagination .prev,.pagination .space{margin:0 5px}.pagination{border-top:0}.pagination .next,.pagination .page-number,.pagination .prev{border-bottom:1px solid #eee;border-top:0}.pagination .next:hover,.pagination .page-number:hover,.pagination .prev:hover{border-bottom-color:var(--link-hover-color)}.site-meta{text-align:center}}.pagination .space{margin:0;padding:0}.comments{margin-top:60px;overflow:hidden}.comment-button-group{display:flex;display:flex;flex-wrap:wrap;justify-content:center;justify-content:center;margin:1em 0}.comment-button-group .comment-button{margin:.1em .2em}.comment-button-group .comment-button.active{background:var(--btn-default-hover-bg);border-color:var(--btn-default-hover-border-color);color:var(--btn-default-hover-color)}.comment-position{display:none}.comment-position.active{display:block}.tabs-comment{margin-top:4em;padding-top:0}.tabs-comment .comments{margin-top:0;padding-top:0}.headband{background:var(--theme-color);height:3px}@media (max-width:991px){.headband{display:none}}.site-brand-container{display:flex;flex-shrink:0;padding:0 10px}.use-motion .column,.use-motion .site-brand-container .toggle{opacity:0}.site-meta{flex-grow:1;text-align:center}.custom-logo-image{margin-top:20px}@media (max-width:991px){.custom-logo-image{display:none}}.brand{border-bottom:0;color:var(--brand-color);display:inline-block;padding:0}.brand:hover{color:var(--brand-hover-color)}.site-title{font-family:Cinzel Decorative,EB Garamond,'Noto Serif SC','PingFang SC','Microsoft YaHei',sans-serif;font-size:1.375em;font-weight:400;line-height:1.5;margin:0}.site-subtitle{color:#ddd;font-size:.8125em;margin:10px 10px 0}.use-motion .custom-logo-image,.use-motion .site-subtitle,.use-motion .site-title{opacity:0;position:relative;top:-10px}.site-nav-right,.site-nav-toggle{display:none}.site-nav-right .toggle,.site-nav-toggle .toggle{color:var(--text-color);padding:10px;width:22px}.site-nav-right .toggle .toggle-line,.site-nav-toggle .toggle .toggle-line{background:var(--text-color);border-radius:1px}@media (max-width:767px){.site-nav-right,.site-nav-toggle{display:flex;flex-direction:column;justify-content:center}.site-nav{--scroll-height:0;height:0;overflow:hidden;transition:height .2s ease-in-out}body:not(.site-nav-on) .site-nav .animated{animation:none}body.site-nav-on .site-nav{height:var(--scroll-height)}}.menu{margin:0;padding:1em 0;text-align:center}.menu-item{display:inline-block;list-style:none;margin:0 10px}@media (max-width:767px){.menu-item{display:block;margin-top:10px}.menu-item.menu-item-search{display:none}}.menu-item a{border-bottom:0;display:block;font-size:.8125em;transition:border-color .2s ease-in-out}.menu-item a.menu-item-active,.menu-item a:hover{background:var(--menu-item-bg-color)}.menu-item .fa,.menu-item .fab,.menu-item .far,.menu-item .fas{margin-right:8px}.menu-item .badge{display:inline-block;font-weight:700;line-height:1;margin-left:.35em;margin-top:.35em;text-align:center;white-space:nowrap}.use-motion .menu-item{visibility:hidden}.sidebar-inner{color:#999;padding:18px 10px;text-align:center;display:flex;flex-direction:column;justify-content:center}.cc-license .cc-opacity{border-bottom:0;opacity:.7}.cc-license .cc-opacity:hover{opacity:.9}.cc-license img{display:inline-block}.site-author-image{border:1px solid #eee;max-width:120px;padding:2px}.site-author-name{color:var(--text-color);font-weight:600;margin:0}.site-description{color:#999;font-size:.8125em;margin-top:0}.links-of-author a{font-size:.8125em}.links-of-author .fa,.links-of-author .fab,.links-of-author .far,.links-of-author .fas{margin-right:2px}.sidebar .sidebar-button:not(:first-child){margin-top:15px}.sidebar .sidebar-button button{background:0 0;cursor:pointer;line-height:2;padding:0 15px;border-radius:4px}.sidebar .sidebar-button button .fa,.sidebar .sidebar-button button .fab,.sidebar .sidebar-button button .far,.sidebar .sidebar-button button .fas{margin-right:5px}.links-of-blogroll{font-size:.8125em}.links-of-blogroll-title{font-size:.875em;font-weight:600}.links-of-blogroll-list{list-style:none;margin:0;padding:0}.sidebar-nav{display:none;margin:0;padding-bottom:20px;padding-left:0}.sidebar-nav-active .sidebar-nav{display:block}.sidebar-nav li{border-bottom:1px solid transparent;color:var(--text-color);cursor:pointer;display:inline-block;font-size:.875em}.sidebar-nav li.sidebar-nav-overview{margin-left:10px}.sidebar-nav li:hover{color:#fc6423}.sidebar-overview-active .sidebar-nav-overview,.sidebar-toc-active .sidebar-nav-toc{border-bottom-color:#fc6423;color:#fc6423}.sidebar-overview-active .sidebar-nav-overview:hover,.sidebar-toc-active .sidebar-nav-toc:hover{color:#fc6423}.sidebar-panel-container{flex:1;overflow-x:hidden;overflow-y:auto}.sidebar-panel{display:none}.sidebar-overview-active .site-overview-wrap{display:flex;flex-direction:column;justify-content:center;gap:10px}.sidebar-toc-active .post-toc-wrap{display:block}.sidebar-toggle{bottom:61px;height:16px;padding:5px;width:16px;background:#222;cursor:pointer;opacity:.6;position:fixed;z-index:30;right:30px}.sidebar-toggle:hover{opacity:.8}@media (max-width:991px){.sidebar-toggle{right:20px;opacity:.8}}.sidebar-toggle:hover .toggle-line{background:#fc6423}@media (any-hover:hover){body:not(.sidebar-active) .sidebar-toggle:hover :first-child{left:50%;top:2px;transform:rotate(45deg);width:50%}body:not(.sidebar-active) .sidebar-toggle:hover :last-child{left:50%;top:-2px;transform:rotate(-45deg);width:50%}}.sidebar-active .sidebar-toggle :nth-child(2){opacity:0}.sidebar-active .sidebar-toggle :first-child{top:6px;transform:rotate(45deg)}.sidebar-active .sidebar-toggle :last-child{top:-6px;transform:rotate(-45deg)}.post-toc{font-size:.875em}.post-toc ol{list-style:none;margin:0;padding:0 2px 5px 10px;text-align:left}.post-toc ol>ol{padding-left:0}.post-toc ol a{transition:.2s ease-in-out}.post-toc .nav-item{line-height:1.8;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.post-toc .nav .nav-child{display:none}.post-toc .nav .active-current>.nav-child,.post-toc .nav .active-current>.nav-child>.nav-item,.post-toc .nav .active>.nav-child{display:block}.post-toc .nav .active>a{border-bottom-color:#fc6423;color:#fc6423}.post-toc .nav .active-current>a,.post-toc .nav .active-current>a:hover{color:#fc6423}.site-state{display:flex;flex-wrap:wrap;justify-content:center;line-height:1.4}.site-state-item a{border-bottom:0;display:block}.site-state-item-count{display:block;font-size:1em;font-weight:600}.site-state-item-name{color:#999;font-size:.8125em}.footer{color:#999;font-size:.875em;padding:20px 0}.footer.footer-fixed{bottom:0;left:0;position:absolute;right:0}.footer-inner{box-sizing:border-box;text-align:center;display:flex;flex-direction:column;justify-content:center;margin:0 auto;width:calc(100% - 20px)}@media (max-width:767px){.menu-item .badge{float:right;margin-left:0}.footer-inner{width:auto}}@media (min-width:1200px){.footer-inner{width:1160px}}@media (min-width:1600px){.footer-inner{width:73%}}.use-motion .footer{opacity:0}.languages{display:inline-block;font-size:1.125em;position:relative}.languages .lang-select-label span{margin:0 .5em}.languages .lang-select{height:100%;left:0;opacity:0;position:absolute;top:0;width:100%}.with-love{color:red;display:inline-block;margin:0 5px}@keyframes icon-animate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,50%,60%,70%,80%{transform:scale(1.1)}}.back-to-top{font-size:12px;align-items:center;bottom:-100px;color:#fff;display:flex;height:26px;transition:bottom .2s ease-in-out;background:#222;cursor:pointer;opacity:.6;position:fixed;z-index:30;right:30px}.back-to-top span{margin-right:8px;display:none}.back-to-top .fa{text-align:center;width:26px}.back-to-top:hover{opacity:.8;color:#fc6423}.back-to-top.back-to-top-on{bottom:30px}.rtl.post-body a,.rtl.post-body h1,.rtl.post-body h2,.rtl.post-body h3,.rtl.post-body h4,.rtl.post-body h5,.rtl.post-body h6,.rtl.post-body li,.rtl.post-body ol,.rtl.post-body p,.rtl.post-body ul{direction:rtl;font-family:UKIJ Ekran}.rtl.post-title{font-family:UKIJ Ekran}.post-button{margin-top:40px;text-align:center}.use-motion .collection-header,.use-motion .comments,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{visibility:hidden}.posts-collapse .post-content{margin-bottom:35px;margin-left:35px;position:relative}@media (max-width:767px){.posts-collapse .post-content{margin-left:0;margin-right:0}}.posts-collapse .post-content .collection-title{font-size:1.125em;position:relative}.posts-collapse .post-content .collection-title::before{background:#999;border:1px solid #fff;margin-left:-6px;margin-top:-4px;position:absolute;top:50%;border-radius:50%;content:' ';height:10px;width:10px}.posts-collapse .post-content .collection-year{font-size:1.5em;font-weight:700;margin:60px 0;position:relative}.posts-collapse .post-content .collection-year::before{background:#bbb;margin-left:-4px;margin-top:-4px;position:absolute;top:50%;border-radius:50%;content:' ';height:8px;width:8px}.posts-collapse .post-content .collection-header{display:block;margin-left:20px}.posts-collapse .post-content .collection-header small{color:#bbb;margin-left:5px}.posts-collapse .post-content .post-header{border-bottom:1px dashed #ccc;margin:30px 2px 0;padding-left:15px;position:relative;transition:border .2s ease-in-out}.posts-collapse .post-content .post-header::before{background:#bbb;border:1px solid #fff;left:-6px;position:absolute;top:.75em;transition:background .2s ease-in-out;border-radius:50%;content:' ';height:6px;width:6px}.posts-collapse .post-content .post-header:hover{border-bottom-color:#666}.posts-collapse .post-content .post-header:hover::before{background:#222}.posts-collapse .post-content .post-meta-container{display:inline;font-size:.75em;margin-right:10px}.posts-collapse .post-content .post-title{display:inline}.posts-collapse .post-content .post-title a{border-bottom:0;color:var(--link-color)}.posts-collapse .post-content .post-title .fa-external-link-alt{font-size:.875em;margin-left:5px}.posts-collapse .post-content::before{background:#f5f5f5;content:' ';height:100%;margin-left:-2px;position:absolute;top:1.25em;width:4px}.post-body{font-family:EB Garamond,'Noto Serif SC','PingFang SC','Microsoft YaHei',sans-serif;overflow-wrap:break-word}@media (min-width:1200px){.post-body{font-size:1.125em}}@media (min-width:992px){.post-body{text-align:justify}}.post-body h1 .header-anchor,.post-body h1 .headerlink,.post-body h2 .header-anchor,.post-body h2 .headerlink,.post-body h3 .header-anchor,.post-body h3 .headerlink,.post-body h4 .header-anchor,.post-body h4 .headerlink,.post-body h5 .header-anchor,.post-body h5 .headerlink,.post-body h6 .header-anchor,.post-body h6 .headerlink{border-bottom-style:none;color:inherit;float:right;font-size:.875em;margin-left:10px;opacity:0}.post-body h1 .header-anchor::before,.post-body h1 .headerlink::before,.post-body h2 .header-anchor::before,.post-body h2 .headerlink::before,.post-body h3 .header-anchor::before,.post-body h3 .headerlink::before,.post-body h4 .header-anchor::before,.post-body h4 .headerlink::before,.post-body h5 .header-anchor::before,.post-body h5 .headerlink::before,.post-body h6 .header-anchor::before,.post-body h6 .headerlink::before{content:'\f0c1';font-family:'Font Awesome 6 Free';font-weight:900}.post-body h1:hover .header-anchor,.post-body h1:hover .headerlink,.post-body h2:hover .header-anchor,.post-body h2:hover .headerlink,.post-body h3:hover .header-anchor,.post-body h3:hover .headerlink,.post-body h4:hover .header-anchor,.post-body h4:hover .headerlink,.post-body h5:hover .header-anchor,.post-body h5:hover .headerlink,.post-body h6:hover .header-anchor,.post-body h6:hover .headerlink{opacity:.5}.post-body h1:hover .header-anchor:hover,.post-body h1:hover .headerlink:hover,.post-body h2:hover .header-anchor:hover,.post-body h2:hover .headerlink:hover,.post-body h3:hover .header-anchor:hover,.post-body h3:hover .headerlink:hover,.post-body h4:hover .header-anchor:hover,.post-body h4:hover .headerlink:hover,.post-body h5:hover .header-anchor:hover,.post-body h5:hover .headerlink:hover,.post-body h6:hover .header-anchor:hover,.post-body h6:hover .headerlink:hover{opacity:1}.post-body .exturl .fa{font-size:.875em;margin-left:4px}.post-body .fancybox+figcaption,.post-body .image-caption,.post-body img+figcaption{color:#999;font-size:.875em;font-weight:700;line-height:1;margin:-15px auto 15px;text-align:center}.post-body embed,.post-body iframe,.post-body img,.post-body video{margin-bottom:20px}.post-body .video-container{height:0;margin-bottom:20px;overflow:hidden;padding-top:75%;position:relative;width:100%}.post-body .video-container embed,.post-body .video-container iframe,.post-body .video-container object{height:100%;left:0;margin:0;position:absolute;top:0;width:100%}.post-gallery{display:flex;min-height:200px}.post-gallery .post-gallery-image{flex:1}.post-gallery .post-gallery-image:not(:first-child){clip-path:polygon(40px 0,100% 0,100% 100%,0 100%);margin-left:-20px}.post-gallery .post-gallery-image:not(:last-child){margin-right:-20px}.post-gallery .post-gallery-image img{height:100%;object-fit:cover;opacity:1;width:100%}.posts-expand .post-gallery{margin-bottom:60px}.posts-collapse .post-gallery{margin:15px 0}.posts-expand .post-header{font-size:1.125em;margin-bottom:60px;text-align:center}.posts-expand .post-title{font-size:1.5em;font-weight:400;margin:initial;overflow-wrap:break-word}.posts-expand .post-title-link{border-bottom:0;color:var(--link-color);display:inline-block;position:relative}.posts-expand .post-title-link::before{background:var(--link-color);bottom:0;content:'';height:2px;left:0;position:absolute;transform:scaleX(0);transition:transform .2s ease-in-out;width:100%}.posts-expand .post-title-link:hover::before{transform:scaleX(1)}.posts-expand .post-title-link .fa-external-link-alt{font-size:.875em;margin-left:5px}.post-sticky-flag{display:inline-block;margin-right:8px;transform:rotate(30deg)}.posts-expand .post-meta-container{color:#999;font-family:EB Garamond,'Noto Serif SC','PingFang SC','Microsoft YaHei',sans-serif;font-size:.75em;margin-top:3px}.posts-expand .post-meta-container .post-description{font-size:.875em;margin-top:2px}.posts-expand .post-meta-container time{border-bottom:1px dashed #999}.post-meta{display:flex;flex-wrap:wrap;justify-content:center}:not(.post-meta-break)+.post-meta-item::before{content:'|';margin:0 .5em}.post-meta-item-icon{margin-right:3px}@media (max-width:991px){.back-to-top{right:20px;opacity:.8}.post-body{text-align:justify}.post-meta-item-text{display:none}}.post-meta-break{flex-basis:100%;height:0}.post-nav{border-top:1px solid #eee;display:flex;gap:30px;justify-content:space-between;margin-top:1em;padding:10px 5px 0}.post-nav-item{flex:1}.post-nav-item a{border-bottom:0;display:block;font-size:.875em;line-height:1.6}.post-nav-item a:active{top:2px}.post-nav-item .fa{font-size:.75em}.post-nav-item:first-child .fa{margin-right:5px}.post-nav-item:last-child{text-align:right}.post-nav-item:last-child .fa{margin-left:5px}.post-footer{display:flex;flex-direction:column;justify-content:center}.post-eof{background:#ccc;height:1px;margin:80px auto 60px;width:8%}.post-block:last-of-type .post-eof{display:none}.post-tags{margin-top:40px;text-align:center}.post-tags a{display:inline-block;font-size:.8125em}.post-tags a:not(:last-child){margin-right:10px}.social-like{border-top:1px solid #eee;font-size:.875em;margin-top:1em;padding-top:1em;text-align:center}.reward-container{margin:1em 0 0;padding:1em 0;text-align:center}.reward-container button{background:0 0;color:#fc6423;cursor:pointer;line-height:2;padding:0 15px;border:2px solid #fc6423;border-radius:2px;outline:0;transition:.2s ease-in-out;vertical-align:text-top}.reward-container button:hover{background:#fc6423;color:#fff}.post-reward{display:none;padding-top:20px}.post-reward.active{display:block}.post-reward div{display:inline-block}.post-reward div span{display:block}.post-reward img{display:inline-block;margin:.8em 2em 0;max-width:100%;width:180px}@keyframes next-roll{from{transform:rotateZ(30deg)}to{transform:rotateZ(-30deg)}}.category-all-page .category-all-title{text-align:center}.category-all-page .category-all{margin-top:20px}.category-all-page .category-list{list-style:none;margin:0;padding:0}.category-all-page .category-list-item{margin:5px 10px}.category-all-page .category-list-count{color:#bbb}.category-all-page .category-list-count::before{content:' ('}.category-all-page .category-list-count::after{content:') '}.category-all-page .category-list-child{padding-left:10px}.event-list hr{background:#222;margin:20px 0 45px}.event-list hr::after{background:#222;color:#fff;content:'NOW';display:inline-block;font-weight:700;padding:0 5px}.event-list .event{--event-background:#222;--event-foreground:#bbb;--event-title:#fff;background:var(--event-background);padding:15px}.event-list .event .event-summary{border-bottom:0;color:var(--event-title);margin:0;padding:0 0 0 35px;position:relative}.event-list .event .event-summary::before{animation:1s ease-in-out infinite alternate dot-flash;background:var(--event-title);left:0;margin-top:-6px;position:absolute;top:50%;border-radius:50%;content:' ';height:12px;width:12px}.event-list .event:nth-of-type(odd) .event-summary::before{animation-delay:.5s}.event-list .event:not(:last-child){margin-bottom:20px}.event-list .event .event-relative-time{color:var(--event-foreground);display:inline-block;font-size:12px;font-weight:400;padding-left:12px}.event-list .event .event-details{color:var(--event-foreground);display:block;line-height:18px;padding:6px 0 6px 35px}.event-list .event .event-details::before{color:var(--event-foreground);display:inline-block;margin-right:9px;width:14px;font-family:'Font Awesome 6 Free';font-weight:900}.event-list .event .event-details.event-location::before{content:'\f041'}.event-list .event .event-details.event-duration::before{content:'\f017'}.event-list .event .event-details.event-description::before{content:'\f024'}.event-list .event-past{--event-background:#f5f5f5;--event-foreground:#999;--event-title:#222}@keyframes dot-flash{from{opacity:1;transform:scale(1)}to{opacity:0;transform:scale(.8)}}ul.breadcrumb{font-size:.75em;list-style:none;margin:1em 0;padding:0 2em;text-align:center}ul.breadcrumb li{display:inline}ul.breadcrumb li:not(:first-child)::before{content:'/\00a0';font-weight:400;padding:.5em}ul.breadcrumb li:last-child{font-weight:700}.tag-cloud{text-align:center}.tag-cloud a{display:inline-block;margin:10px}.tag-cloud-0{border-bottom-color:#aaa;color:#aaa}.tag-cloud-1{border-bottom-color:#9a9a9a;color:#9a9a9a}.tag-cloud-2{border-bottom-color:#8b8b8b;color:#8b8b8b}.tag-cloud-3{border-bottom-color:#7c7c7c;color:#7c7c7c}.tag-cloud-4{border-bottom-color:#6c6c6c;color:#6c6c6c}.tag-cloud-5{border-bottom-color:#5d5d5d;color:#5d5d5d}.tag-cloud-6{border-bottom-color:#4e4e4e;color:#4e4e4e}.tag-cloud-7{border-bottom-color:#3e3e3e;color:#3e3e3e}.tag-cloud-8{border-bottom-color:#2f2f2f;color:#2f2f2f}.tag-cloud-9{border-bottom-color:#202020;color:#202020}.tag-cloud-10{border-bottom-color:#111;color:#111}.search-active{overflow:hidden}.search-pop-overlay{background:rgba(0,0,0,0);display:flex;height:100%;left:0;position:fixed;top:0;transition:visibility .4s,background .4s;visibility:hidden;width:100%;z-index:40}.search-active .search-pop-overlay{background:rgba(0,0,0,.3);visibility:visible}.search-popup{background:var(--card-bg-color);border-radius:5px;height:80%;margin:auto;transform:scale(0);transition:transform .4s;width:700px}.search-active .search-popup{transform:scale(1)}@media (max-width:767px){.search-popup{border-radius:0;height:100%;width:100%}}.search-popup .popup-btn-close,.search-popup .search-icon{color:#999;font-size:18px;padding:0 10px}.search-popup .popup-btn-close{cursor:pointer}.search-popup .popup-btn-close:hover .fa{color:#222}.search-popup .search-header{background:#eee;border-top-left-radius:5px;border-top-right-radius:5px;display:flex;padding:5px}.search-popup input.search-input{background:0 0;border:0;outline:0;width:100%}.search-popup input.search-input::-webkit-search-cancel-button{display:none}.search-popup .search-result-container{height:calc(100% - 55px);overflow:auto;padding:5px 25px}.search-popup .search-result-container hr{margin:5px 0 10px}.search-popup .search-result-container hr:first-child{display:none}.search-popup .search-result-list{margin:0 5px;padding:0;width:100%}.search-popup a.search-result-title{font-weight:700}.search-popup p.search-result{border-bottom:1px dashed #ccc;padding:5px 0}.search-popup .search-input-container{flex-grow:1;padding:2px}.search-popup .no-result{display:flex}.search-popup .search-result-icon{color:#ccc;margin:auto}mark.search-keyword{background:0 0;border-bottom:1px dashed #ff2a2a;color:#ff2a2a;font-weight:700}.use-motion .animated{animation-fill-mode:none;visibility:inherit}.use-motion .sidebar .animated{animation-fill-mode:both}.header{background:var(--content-bg-color);border-radius:initial;box-shadow:initial}.main{align-items:stretch;display:flex;justify-content:space-between;margin:0 auto;width:calc(100% - 20px)}@media (max-width:767px){.main{width:auto}}@media (min-width:1200px){.main{width:1160px}}@media (min-width:1600px){.main{width:73%}}@media (max-width:991px){.header{border-radius:initial}.main{display:block;width:auto}}.main-inner{border-radius:initial;box-sizing:border-box;width:calc(100% - 252px)}.footer-inner{padding-left:252px}@media (max-width:991px){.main-inner{border-radius:initial;width:100%}.footer-inner{padding-left:0;padding-right:0;width:auto}}.column{width:240px}.site-brand-container{background:var(--theme-color)}.site-meta{padding:20px 0}.site-nav-right .toggle,.site-nav-toggle .toggle{color:#fff}.site-nav-right .toggle .toggle-line,.site-nav-toggle .toggle .toggle-line{background:#fff}@media (min-width:768px) and (max-width:991px){.site-nav-right,.site-nav-toggle{display:flex;flex-direction:column;justify-content:center}.site-nav{--scroll-height:0;height:0;overflow:hidden;transition:height .2s ease-in-out}body:not(.site-nav-on) .site-nav .animated{animation:none}body.site-nav-on .site-nav{height:var(--scroll-height)}}.menu .menu-item{display:block;margin:0}.menu .menu-item a{padding:5px 20px;position:relative;text-align:left;transition-property:background-color}.menu .menu-item .badge{background:#ccc;border-radius:10px;color:var(--content-bg-color);float:right;padding:2px 5px;text-shadow:1px 1px 0 rgba(0,0,0,.1)}.main-menu .menu-item-active::after{background:#bbb;border-radius:50%;content:' ';height:6px;margin-top:-3px;position:absolute;right:15px;top:50%;width:6px}.sub-menu{margin:0;padding:6px 0}.sub-menu .menu-item{display:inline-block}.sub-menu .menu-item a{background:0 0;margin:5px 10px;padding:initial}.sub-menu .menu-item a:hover{background:0 0;color:#fc6423}.sub-menu .menu-item-active{border-bottom-color:#fc6423;color:#fc6423}.sub-menu .menu-item-active:hover{border-bottom-color:#fc6423}.sidebar{position:-webkit-sticky;position:sticky;top:12px}@media (max-width:991px){.column{width:auto}.site-nav-on .site-brand-container{box-shadow:0 0 16px rgba(0,0,0,.5)}.menu .menu-item.menu-item-search,.sidebar{display:none}}.sidebar-inner{background:var(--content-bg-color);border-radius:initial;box-shadow:initial;box-sizing:border-box;color:var(--text-color);margin-top:12px;max-height:calc(100vh - 24px);visibility:hidden}.site-state-item{padding:0 10px}.sidebar .sidebar-button{border-bottom:1px dotted #ccc;border-top:1px dotted #ccc}.sidebar .sidebar-button button{border:0;color:#fc6423;display:block;width:100%}.sidebar .sidebar-button button:hover{background:0 0;border:0;color:#e34603}.links-of-author{display:flex;flex-wrap:wrap;justify-content:center}.links-of-author-item{margin:5px 0 0;width:50%}.links-of-author-item a{box-sizing:border-box;max-width:100%;overflow:hidden;padding:0 5px;text-overflow:ellipsis;white-space:nowrap;border-bottom:0;border-radius:4px;display:block}.links-of-author-item a:hover{background:var(--body-bg-color)}.main-inner{background:var(--content-bg-color);box-shadow:initial;padding:40px}@media (max-width:991px){.main-inner{padding:20px}}.sub-menu{border-bottom:1px solid #ddd}.post-block:first-of-type{padding-top:40px}@media (max-width:767px){.pagination{margin-bottom:10px}}</style><link crossorigin=anonymous href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css integrity=sha256-Z1K5uhUaJXA7Ll0XrZ/0JhX4lAtZFpT6jkKrEDT0drU= rel=stylesheet><link crossorigin=anonymous href=https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css integrity=sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE= rel=stylesheet><script class=next-config data-name=main type=application/json>{"hostname":"gzwilly.blog","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.14.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src=/js/config.js></script><meta content="摘自《企业级 Go 项目开发实战》图书 在和其他开发同学交流时，我发现大家都认可 Makefile 强大的项目管理能力，也会自己编写 Makefile 。但是其中的一些人项目管理做得并不好，我和他们进一步交流后发现，这些同学在用 Makefile 简单的语法重复编写一些低质量 Makefile 文件，根本没有把 Makefile 的功能充分发挥出来。 下面给你举个例子，你就会理解低质量的 Make" name=description><meta content=article property=og:type><meta content="07 | 项目管理：如何编写 Makefile" property=og:title><meta content=http://gzwilly.blog/post/2023-golang-practice-%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-07-write-makefile.html property=og:url><meta content=gzwilly'blog property=og:site_name><meta content="摘自《企业级 Go 项目开发实战》图书 在和其他开发同学交流时，我发现大家都认可 Makefile 强大的项目管理能力，也会自己编写 Makefile 。但是其中的一些人项目管理做得并不好，我和他们进一步交流后发现，这些同学在用 Makefile 简单的语法重复编写一些低质量 Makefile 文件，根本没有把 Makefile 的功能充分发挥出来。 下面给你举个例子，你就会理解低质量的 Make" property=og:description><meta content=zh_CN property=og:locale><meta content=https://static001.geekbang.org/resource/image/5c/f7/5c524e0297b6d6e4e151643d2e1bbbf7.png property=og:image><meta content=2023-04-01T06:13:56.000Z property=article:published_time><meta content=2023-04-01T07:12:11.000Z property=article:modified_time><meta content=gzwillyy property=article:author><meta content=Golang property=article:tag><meta content=IAM property=article:tag><meta content=Makefile property=article:tag><meta content=summary name=twitter:card><meta content=https://static001.geekbang.org/resource/image/5c/f7/5c524e0297b6d6e4e151643d2e1bbbf7.png name=twitter:image><link href=http://gzwilly.blog/post/2023-golang-practice-%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-07-write-makefile.html rel=canonical><script class=next-config data-name=page type=application/json>{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://gzwilly.blog/post/2023-golang-practice-%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-07-write-makefile.html","path":"/post/2023-golang-practice-开发实战-07-write-makefile.html","title":"07 | 项目管理：如何编写 Makefile"}</script><script class=next-config data-name=calendar type=application/json>""</script><title>07 | 项目管理：如何编写 Makefile | gzwilly'blog</title><noscript><link href=/css/noscript.css rel=stylesheet></noscript><body class=use-motion itemscope itemtype=http://schema.org/WebPage><div class=headband></div><main class=main><div class=column><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=site-brand-container><div class=site-nav-toggle><div aria-label=切换导航栏 class=toggle role=button><span class=toggle-line></span><span class=toggle-line></span><span class=toggle-line></span></div></div><div class=site-meta><a class=brand href=/ rel=start> <i class=logo-line></i> <p class=site-title>gzwilly'blog</p> <i class=logo-line></i> </a></div><div class=site-nav-right><div class="toggle popup-trigger" aria-label=搜索 role=button><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ rel=section><i class="fa fa-home fa-fw"></i>首页</a><li class="menu-item menu-item-tags"><a href=/tags/ rel=section><i class="fa fa-tags fa-fw"></i>标签</a><li class="menu-item menu-item-categories"><a href=/categories/ rel=section><i class="fa fa-th fa-fw"></i>分类</a><li class="menu-item menu-item-archives"><a href=/archives/ rel=section><i class="fa fa-archive fa-fw"></i>归档</a><li class="menu-item menu-item-sitemap"><a href=/sitemap.xml rel=section><i class="fa fa-sitemap fa-fw"></i>站点地图</a><li class="menu-item menu-item-search"><a class=popup-trigger role=button><i class="fa fa-search fa-fw"></i>搜索 </a></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon> <i class="fa fa-search"></i> </span><div class=search-input-container><input autocapitalize=off autocomplete=off class=search-input maxlength=80 placeholder=搜索... spellcheck=false type=search></div><span class=popup-btn-close role=button> <i class="fa fa-times-circle"></i> </span></div><div class="search-result-container no-result"><div class=search-result-icon><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></header><aside class=sidebar><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>文章目录<li class=sidebar-nav-overview>站点概览</ul><div class=sidebar-panel-container><!--noindex--><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class=nav><li class="nav-item nav-level-2"><a class=nav-link href=#%E7%86%9F%E7%BB%83%E6%8E%8C%E6%8F%A1-Makefile-%E8%AF%AD%E6%B3%95><span class=nav-number>1.</span> <span class=nav-text>熟练掌握 Makefile 语法</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#%E8%A7%84%E5%88%92-Makefile-%E8%A6%81%E5%AE%9E%E7%8E%B0%E7%9A%84%E5%8A%9F%E8%83%BD><span class=nav-number>2.</span> <span class=nav-text>规划 Makefile 要实现的功能</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#%E8%AE%BE%E8%AE%A1%E5%90%88%E7%90%86%E7%9A%84-Makefile-%E7%BB%93%E6%9E%84><span class=nav-number>3.</span> <span class=nav-text>设计合理的 Makefile 结构</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#%E6%8E%8C%E6%8F%A1-Makefile-%E7%BC%96%E5%86%99%E6%8A%80%E5%B7%A7><span class=nav-number>4.</span> <span class=nav-text>掌握 Makefile 编写技巧</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#%E6%8A%80%E5%B7%A71%EF%BC%9A%E5%96%84%E7%94%A8%E9%80%9A%E9%85%8D%E7%AC%A6%E5%92%8C%E8%87%AA%E5%8A%A8%E5%8F%98%E9%87%8F><span class=nav-number>4.1.</span> <span class=nav-text>技巧1：善用通配符和自动变量</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#%E6%8A%80%E5%B7%A72%EF%BC%9A%E5%96%84%E7%94%A8%E5%87%BD%E6%95%B0><span class=nav-number>4.2.</span> <span class=nav-text>技巧2：善用函数</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#%E6%8A%80%E5%B7%A73%EF%BC%9A%E4%BE%9D%E8%B5%96%E9%9C%80%E8%A6%81%E7%94%A8%E5%88%B0%E7%9A%84%E5%B7%A5%E5%85%B7><span class=nav-number>4.3.</span> <span class=nav-text>技巧3：依赖需要用到的工具</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#%E6%8A%80%E5%B7%A74%EF%BC%9A%E6%8A%8A%E5%B8%B8%E7%94%A8%E5%8A%9F%E8%83%BD%E6%94%BE%E5%9C%A8-x2F-Makefile-%E4%B8%AD%EF%BC%8C%E4%B8%8D%E5%B8%B8%E7%94%A8%E7%9A%84%E6%94%BE%E5%9C%A8%E5%88%86%E7%B1%BB-Makefile-%E4%B8%AD><span class=nav-number>4.4.</span> <span class=nav-text>技巧4：把常用功能放在/ Makefile 中，不常用的放在分类 Makefile 中</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#%E6%8A%80%E5%B7%A75%EF%BC%9A%E7%BC%96%E5%86%99%E5%8F%AF%E6%89%A9%E5%B1%95%E7%9A%84-Makefile><span class=nav-number>4.5.</span> <span class=nav-text>技巧5：编写可扩展的 Makefile</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#%E6%8A%80%E5%B7%A76%EF%BC%9A%E5%B0%86%E6%89%80%E6%9C%89%E8%BE%93%E5%87%BA%E5%AD%98%E6%94%BE%E5%9C%A8%E4%B8%80%E4%B8%AA%E7%9B%AE%E5%BD%95%E4%B8%8B%EF%BC%8C%E6%96%B9%E4%BE%BF%E6%B8%85%E7%90%86%E5%92%8C%E6%9F%A5%E6%89%BE><span class=nav-number>4.6.</span> <span class=nav-text>技巧6：将所有输出存放在一个目录下，方便清理和查找</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#%E6%8A%80%E5%B7%A77%EF%BC%9A%E4%BD%BF%E7%94%A8%E5%B8%A6%E5%B1%82%E7%BA%A7%E7%9A%84%E5%91%BD%E5%90%8D%E6%96%B9%E5%BC%8F><span class=nav-number>4.7.</span> <span class=nav-text>技巧7：使用带层级的命名方式</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#%E6%8A%80%E5%B7%A78%EF%BC%9A%E5%81%9A%E5%A5%BD%E7%9B%AE%E6%A0%87%E6%8B%86%E5%88%86><span class=nav-number>4.8.</span> <span class=nav-text>技巧8：做好目标拆分</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#%E6%8A%80%E5%B7%A79%EF%BC%9A%E8%AE%BE%E7%BD%AEOPTIONS><span class=nav-number>4.9.</span> <span class=nav-text>技巧9：设置OPTIONS</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#%E6%8A%80%E5%B7%A710%EF%BC%9A%E5%AE%9A%E4%B9%89%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F><span class=nav-number>4.10.</span> <span class=nav-text>技巧10：定义环境变量</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#%E6%8A%80%E5%B7%A711%EF%BC%9A%E8%87%AA%E5%B7%B1%E8%B0%83%E7%94%A8%E8%87%AA%E5%B7%B1><span class=nav-number>4.11.</span> <span class=nav-text>技巧11：自己调用自己</span></a></ol><li class="nav-item nav-level-2"><a class=nav-link href=#%E6%80%BB%E7%BB%93><span class=nav-number>5.</span> <span class=nav-text>总结</span></a></ol></div></div><!--/noindex--><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop=author itemscope itemtype=http://schema.org/Person><p class=site-author-name itemprop=name>gzwillyy<div class=site-description itemprop=description></div></div><div class="site-state-wrap animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/> <span class=site-state-item-count>68</span> <span class=site-state-item-name>日志</span> </a></div><div class="site-state-item site-state-categories"><a href=/categories/> <span class=site-state-item-count>7</span> <span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/> <span class=site-state-item-count>90</span> <span class=site-state-item-name>标签</span></a></div></nav></div><div class="links-of-author animated"><span class=links-of-author-item> <a rel="noopener me" title="GitHub → https://github.com/gzwillyy" href=https://github.com/gzwillyy target=_blank><i class="fab fa-github fa-fw"></i>GitHub</a> </span></div></div></div></div></aside></div><div class="main-inner post posts-expand"><div class=post-block><article class=post-content itemscope itemtype=http://schema.org/Article lang=zh-CN><link href=http://gzwilly.blog/post/2023-golang-practice-%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-07-write-makefile.html itemprop=mainEntityOfPage><span hidden itemprop=author itemscope itemtype=http://schema.org/Person> <meta content=/images/avatar.gif itemprop=image> <meta content=gzwillyy itemprop=name> </span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization> <meta content=gzwilly'blog itemprop=name> <meta itemprop=description> </span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork> <meta content="07 | 项目管理：如何编写 Makefile | gzwilly'blog" itemprop=name> <meta itemprop=description> </span><header class=post-header><h1 itemprop="name headline" class=post-title>07 | 项目管理：如何编写 Makefile</h1><div class=post-meta-container><div class=post-meta><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar"></i> </span> <span class=post-meta-item-text>发表于</span> <time itemprop="dateCreated datePublished" title="创建时间：2023-04-01 14:13:56 / 修改时间：15:12:11" datetime=2023-04-01T14:13:56+08:00>2023-04-01</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-folder"></i> </span> <span class=post-meta-item-text>分类于</span> <span itemprop=about itemscope itemtype=http://schema.org/Thing> <a href=/categories/Golang-%E5%AE%9E%E6%88%98/ itemprop=url rel=index><span itemprop=name>Golang 实战</span></a> </span> </span></div></div></header><div class=post-body itemprop=articleBody><p><strong>摘自《企业级 Go 项目开发实战》图书</strong><p>在和其他开发同学交流时，我发现大家都认可 <code>Makefile</code> 强大的项目管理能力，也会自己编写 <code>Makefile</code> 。但是其中的一些人项目管理做得并不好，我和他们进一步交流后发现，这些同学在用 <code>Makefile</code> 简单的语法重复编写一些低质量 <code>Makefile</code> 文件，根本没有把 <code>Makefile</code> 的功能充分发挥出来。<p>下面给你举个例子，你就会理解低质量的 <code>Makefile</code> 文件是什么样的了。</p><span id=more></span><pre class="line-numbers language-makefile" data-language=makefile><code class=language-makefile><span class="token target symbol">build</span><span class="token punctuation">:</span> clean vet
	<span class="token operator">@</span>mkdir -p ./Role
	<span class="token operator">@</span><span class="token keyword">export</span> GOOS<span class="token operator">=</span>linux && go build -v .

<span class="token target symbol">vet</span><span class="token punctuation">:</span>
	go vet ./...

<span class="token target symbol">fmt</span><span class="token punctuation">:</span>
	go fmt ./...

<span class="token target symbol">clean</span><span class="token punctuation">:</span>
	rm -rf dashboard<span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面这个 <code>Makefile</code> 存在不少问题。例如：功能简单，只能完成最基本的编译、格式化等操作，像构建镜像、自动生成代码等一些高阶的功能都没有；扩展性差，没法编译出可在Mac下运行的二进制文件；没有Help功能，使用难度高；单 <code>Makefile</code> 文件，结构单一，不适合添加一些复杂的管理功能。<p>所以，我们不光要编写 <code>Makefile</code> ，还要编写高质量的 <code>Makefile</code> 。那么如何编写一个高质量的 <code>Makefile</code> 呢？我觉得，可以通过以下4个方法来实现：<ol><li>打好基础，也就是熟练掌握 <code>Makefile</code> 的语法。<li>做好准备工作，也就是提前规划 <code>Makefile</code> 要实现的功能。<li>进行规划，设计一个合理的 <code>Makefile</code> 结构。<li>掌握方法，用好 <code>Makefile</code> 的编写技巧。</ol><p>那么接下来，我们就详细看看这些方法。<h2 id=熟练掌握-Makefile-语法><a title="熟练掌握 Makefile 语法" class=headerlink href=#熟练掌握-Makefile-语法></a>熟练掌握 <code>Makefile</code> 语法</h2><p>工欲善其事，必先利其器。编写高质量 <code>Makefile</code> 的第一步，便是熟练掌握 <code>Makefile</code> 的核心语法。<p>因为 <code>Makefile</code> 的语法比较多，我把一些建议你重点掌握的语法放在了近期会更新的特别放送中，包括 <code>Makefile</code> 规则语法、伪目标、变量赋值、条件语句和 <code>Makefile</code> 常用函数等等。<p>如果你想更深入、全面地学习 <code>Makefile</code> 的语法，我推荐你学习陈皓老师编写的<a href=https://github.com/seisman/how-to-write-makefile rel=noopener target=_blank>《跟我一起写 <code>Makefile</code> 》 (PDF 重制版)</a>。<h2 id=规划-Makefile-要实现的功能><a title="规划 Makefile 要实现的功能" class=headerlink href=#规划-Makefile-要实现的功能></a>规划 <code>Makefile</code> 要实现的功能</h2><p>接着，我们需要规划 <code>Makefile</code> 要实现的功能。提前规划好功能，有利于你设计 <code>Makefile</code> 的整体结构和实现方法。<p>不同项目拥有不同的 <code>Makefile</code> 功能，这些功能中一小部分是通过目标文件来实现的，但更多的功能是通过伪目标来实现的。对于Go项目来说，虽然不同项目集成的功能不一样，但绝大部分项目都需要实现一些通用的功能。接下来，我们就来看看，在一个大型Go项目中 <code>Makefile</code> 通常可以实现的功能。<p>下面是IAM项目的 <code>Makefile</code> 所集成的功能，希望会对你日后设计 <code>Makefile</code> 有一些帮助。<pre class="line-numbers language-makefile" data-language=makefile><code class=language-makefile>$ make help


<span class="token target symbol">Usage</span><span class="token punctuation">:</span> make &LTTARGETS> &LTOPTIONS> ...

<span class="token target symbol">Targets</span><span class="token punctuation">:</span>
		<span class="token comment"># 构建类命令</span>
		build              Build source code for host platform.
		build.multiarch    Build source code for multiple platforms. See option PLATFORMS.

		<span class="token comment"># Docker镜像打包类命令</span>
		image              Build docker images for host arch.
		image.multiarch    Build docker images for multiple platforms. See option PLATFORMS.
		push               Build docker images for host arch and push images to registry.
		push.multiarch     Build docker images for multiple platforms and push images to registry.

		<span class="token comment"># 部署类命令</span>
		deploy             Deploy updated components to development env.
		install						 Install iam system with all its components.

		<span class="token comment"># 清理类命令</span>
		clean              Remove all files that are created by building.

		<span class="token comment"># 静态代码检查</span>
		lint               Check syntax and styling of go sources.

		<span class="token comment"># 测试类命令</span>
		test               Run unit test.
		cover              Run unit test and get test coverage.

		<span class="token comment"># 格式化类命令</span>
		format             Gofmt <span class="token punctuation">(</span>reformat<span class="token punctuation">)</span> package sources <span class="token punctuation">(</span>exclude vendor dir if existed<span class="token punctuation">)</span>.
		verify-copyright   Verify the boilerplate headers for all files.
		add-copyright			 Ensures source code files have copyright license headers.

		<span class="token comment"># 代码生成类命令</span>
		gen                Generate all necessary files, such as error code files.
		ca                 Generate CA files for all iam components.

		<span class="token comment"># 其他命令，不同项目会有区别</span>
		release            Release iam
		swagger            Generate swagger document.
		serve-swagger			 Serve swagger spec and docs.
		dependencies       install dependent tools.
		tools              install dependent tools.
		check-updates      Check outdated dependencies of the go projects

		<span class="token comment"># 帮助命令</span>
		help               Show this help info.
<span class="token comment"># 选项</span>
<span class="token target symbol">Options</span><span class="token punctuation">:</span>
		DEBUG       Whether to generate debug symbols. Default is 0.
		BINS        The binaries to build. Default is all of cmd.
<span class="token target symbol">								This option is available when using</span><span class="token punctuation">:</span> make build/build.multiarch
<span class="token target symbol">								Example</span><span class="token punctuation">:</span> make build BINS<span class="token operator">=</span><span class="token string">"iam-apiserver iam-authz-server"</span>
		...<span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>更详细的命令，你可以在IAM项目仓库根目录下执行<code>make help</code>查看。<p>通常而言，Go项目的 <code>Makefile</code> 应该实现以下功能：<code>格式化代码</code>、<code>静态代码检查</code>、<code>单元测试</code>、<code>代码构建</code>、<code>文件清理</code>、<code>帮助</code>等等。如果通过 <code>docker</code> 部署，还需要有 <code>docker</code> 镜像打包功能。因为<code>Go</code>是跨平台的语言，所以<code>构建</code>和 <code>docker 打包</code>命令，还要能够支持不同的<code>CPU架构</code>和<code>平台</code>。为了能够更好地控制 <code>Makefile</code> 命令的行为，还需要支持<code>Options</code>。<p>为了方便查看 <code>Makefile</code> 集成了哪些功能，我们需要支持 <code>help</code> 命令。 <code>help</code> 命令最好通过解析 <code>Makefile</code> 文件来输出集成的功能，例如：<pre class="line-numbers language-makefile" data-language=makefile><code class=language-makefile><span class="token comment">## help: Show this help info.</span>
<span class="token builtin-target builtin">.PHONY</span><span class="token punctuation">:</span> help
<span class="token target symbol">help</span><span class="token punctuation">:</span>Makefile
	<span class="token operator">@</span>echo -e <span class="token string">"nUsage: make &LTTARGETS> &LTOPTIONS> ...nnTargets:"</span>
	<span class="token operator">@</span>sed -n <span class="token string">'s/##//p'</span> <span class="token variable">$<</span> <span class="token operator">|</span> column -t -s <span class="token string">':'</span> <span class="token operator">|</span> sed -e <span class="token string">'s// /'</span>
	<span class="token operator">@</span>echo <span class="token string">"$$USAGE_OPTIONS"</span><span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面的<code>help</code>命令，通过解析 <code>Makefile</code> 文件中的<code>##</code>注释，获取支持的命令。通过这种方式，我们以后新加命令时，就不用再对 <code>help</code> 命令进行修改了。<p>你可以参考上面的 <code>Makefile</code> 管理功能，结合自己项目的需求，整理出一个 <code>Makefile</code> 要实现的功能列表，并初步确定实现思路和方法。做完这些，你的编写前准备工作就基本完成了。<h2 id=设计合理的-Makefile-结构><a title="设计合理的 Makefile 结构" class=headerlink href=#设计合理的-Makefile-结构></a>设计合理的 <code>Makefile</code> 结构</h2><p>设计完 <code>Makefile</code> 需要实现的功能，接下来我们就进入 <code>Makefile</code> 编写阶段。编写阶段的第一步，就是设计一个合理的 <code>Makefile</code> 结构。<p>对于大型项目来说，需要管理的内容很多，所有管理功能都集成在一个 <code>Makefile</code> 中，可能会导致 <code>Makefile</code> 很大，难以阅读和维护，所以<strong>建议采用分层的设计方法，根目录下的 <code>Makefile</code> 聚合所有的 <code>Makefile</code> 命令，具体实现则按功能分类，放在另外的 <code>Makefile</code> 中</strong>。<p>我们经常会在 <code>Makefile</code> 命令中集成 <code>shell</code> 脚本，但如果 <code>shell</code> 脚本过于复杂，也会导致 <code>Makefile</code> 内容过多，难以阅读和维护。并且在 <code>Makefile</code> 中集成复杂的 <code>shell</code> 脚本，编写体验也很差。对于这种情况，<strong>可以将复杂的 <code>shell</code> 命令封装在 <code>shell</code> 脚本中，供 <code>Makefile</code> 直接调用，而一些简单的命令则可以直接集成在 <code>Makefile</code> 中</strong>。<p>所以，最终我推荐的 <code>Makefile</code> 结构如下：<p><a href=https://static001.geekbang.org/resource/image/5c/f7/5c524e0297b6d6e4e151643d2e1bbbf7.png rel=noopener target=_blank><img src=https://static001.geekbang.org/resource/image/5c/f7/5c524e0297b6d6e4e151643d2e1bbbf7.png></a><p>在上面的 <code>Makefile</code> 组织方式中，根目录下的 <code>Makefile</code> 聚合了项目所有的管理功能，这些管理功能通过 <code>Makefile</code> 伪目标的方式实现。同时，还将这些伪目标进行分类，把相同类别的伪目标放在同一个 <code>Makefile</code> 中，这样可以使得 <code>Makefile</code> 更容易维护。对于复杂的命令，则编写成独立的 <code>shell</code> 脚本，并在 <code>Makefile</code> 命令中调用这些 <code>shell</code> 脚本。<p>举个例子，下面是IAM项目的 <code>Makefile</code> 组织结构：<pre class="line-numbers language-bash" data-language=bash><code class=language-bash>├──  <span class="token variable"><span class="token variable">`</span>Makefile<span class="token variable">`</span></span>
├── scripts
│   ├── gendoc.sh
│   ├── make-rules
│   │   ├── gen.mk
│   │   ├── golang.mk
│   │   ├── image.mk
│   │   └── <span class="token punctuation">..</span>.
		└── <span class="token punctuation">..</span>.<span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我们将相同类别的操作统一放在<code>scripts/make-rules</code>目录下的 <code>Makefile</code> 文件中。 <code>Makefile</code> 的文件名参考分类命名，例如 <code>golang.mk</code>。最后，在/ <code>Makefile</code> 中 <code>include</code> 这些 <code>Makefile</code> 。<p>为了跟 <code>Makefile</code> 的层级相匹配，<code>golang.mk</code>中的所有目标都按<code>go.xxx</code>这种方式命名。通过这种命名方式，我们可以很容易分辨出某个目标完成什么功能，放在什么文件里，这在复杂的 <code>Makefile</code> 中尤其有用。以下是IAM项目根目录下， <code>Makefile</code> 的内容摘录，你可以看一看，作为参考：<pre class="line-numbers language-makefile" data-language=makefile><code class=language-makefile><span class="token keyword">include</span> scripts/make-rules/golang.mk
<span class="token keyword">include</span> scripts/make-rules/image.mk
<span class="token keyword">include</span> scripts/make-rules/gen.mk
<span class="token keyword">include</span> scripts/make-rules/...

<span class="token comment">## build: Build source code for host platform.</span>
<span class="token builtin-target builtin">.PHONY</span><span class="token punctuation">:</span> build
<span class="token target symbol">build</span><span class="token punctuation">:</span>
	<span class="token operator">@</span><span class="token variable">$</span><span class="token punctuation">(</span>MAKE<span class="token punctuation">)</span> go.build
<span class="token comment">## build.multiarch: Build source code for multiple platforms. See option PLATFORMS.</span>
<span class="token builtin-target builtin">.PHONY</span><span class="token punctuation">:</span> build.multiarch
<span class="token target symbol">build.multiarch</span><span class="token punctuation">:</span>
	<span class="token operator">@</span><span class="token variable">$</span><span class="token punctuation">(</span>MAKE<span class="token punctuation">)</span> go.build.multiarch

<span class="token comment">## image: Build docker images for host arch.</span>
<span class="token builtin-target builtin">.PHONY</span><span class="token punctuation">:</span> image
<span class="token target symbol">image</span><span class="token punctuation">:</span>
	<span class="token operator">@</span><span class="token variable">$</span><span class="token punctuation">(</span>MAKE<span class="token punctuation">)</span> image.build

<span class="token comment">## image.multiarch: Build docker images for multiple platforms. See option PLATFORMS.</span>
<span class="token builtin-target builtin">.PHONY</span><span class="token punctuation">:</span> image.multiarch
<span class="token target symbol">image.multiarch</span><span class="token punctuation">:</span>
	<span class="token operator">@</span><span class="token variable">$</span><span class="token punctuation">(</span>MAKE<span class="token punctuation">)</span> image.build.multiarch


<span class="token comment">## push: Build docker images for host arch and push images to registry.</span>
<span class="token builtin-target builtin">.PHONY</span><span class="token punctuation">:</span> push
<span class="token target symbol">push</span><span class="token punctuation">:</span>
	<span class="token operator">@</span><span class="token variable">$</span><span class="token punctuation">(</span>MAKE<span class="token punctuation">)</span> image.push

<span class="token comment">## ca: Generate CA files for all iam components.</span>
<span class="token builtin-target builtin">.PHONY</span><span class="token punctuation">:</span> ca
<span class="token target symbol">ca</span><span class="token punctuation">:</span>
	<span class="token operator">@</span><span class="token variable">$</span><span class="token punctuation">(</span>MAKE<span class="token punctuation">)</span> gen.ca<span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>另外，一个合理的 <code>Makefile</code> 结构应该具有前瞻性。也就是说，要在不改变现有结构的情况下，接纳后面的新功能。这就需要你整理好 <code>Makefile</code> 当前要实现的功能、即将要实现的功能和未来可能会实现的功能，然后基于这些功能，利用 <code>Makefile</code> 编程技巧，编写可扩展的 <code>Makefile</code> 。<p>这里需要你注意：上面的 <code>Makefile</code> 通过 <code>.PHONY</code> 标识定义了大量的伪目标，定义伪目标一定要加 <code>.PHONY</code> 标识，否则当有同名的文件时，伪目标可能不会被执行。<h2 id=掌握-Makefile-编写技巧><a title="掌握 Makefile 编写技巧" class=headerlink href=#掌握-Makefile-编写技巧></a>掌握 <code>Makefile</code> 编写技巧</h2><p>最后，在编写过程中，你还需要掌握一些 <code>Makefile</code> 的编写技巧，这些技巧可以使你编写的 <code>Makefile</code> 扩展性更强，功能更强大。<p>接下来，我会把自己长期开发过程中积累的一些 <code>Makefile</code> 编写经验分享给你。这些技巧，你需要在实际编写中多加练习，并形成编写习惯。<h3 id=技巧1：善用通配符和自动变量><a class=headerlink href=#技巧1：善用通配符和自动变量 title=技巧1：善用通配符和自动变量></a>技巧1：善用通配符和自动变量</h3><p><code>Makefile</code> 允许对目标进行类似正则运算的匹配，主要用到的通配符是<code>%</code>。通过使用通配符，可以使不同的目标使用相同的规则，从而使 <code>Makefile</code> 扩展性更强，也更简洁。<p>我们的IAM实战项目中，就大量使用了通配符<code>%</code>，例如：<code>go.build.%</code>、<code>ca.gen.%</code>、<code>deploy.run.%</code>、<code>tools.verify.%</code>、<code>tools.install.%</code>等。<p>这里，我们来看一个具体的例子，<code>tools.verify.%</code>（位于<a href=https://github.com/marmotedu/iam/blob/master/scripts/make-rules/tools.mk#L17 rel=noopener target=_blank>scripts/make-rules/tools.mk</a>文件中）定义如下：<pre class="line-numbers language-makefile" data-language=makefile><code class=language-makefile><span class="token target symbol">tools.verify.%</span><span class="token punctuation">:</span>
	<span class="token operator">@</span>if ! which <span class="token variable">$*</span> &>/dev/null<span class="token punctuation">;</span> then <span class="token variable">$</span><span class="token punctuation">(</span>MAKE<span class="token punctuation">)</span> tools.install.<span class="token variable">$;</span> fi<span aria-hidden=true class=line-numbers-rows><span></span><span></span></span></code></pre><p><code>make tools.verify.swagger</code>, <code>make tools.verify.mockgen</code>等均可以使用上面定义的规则，<code>%</code>分别代表了<code>swagger</code>和<code>mockgen</code>。<p>如果不使用<code>%</code>，则我们需要分别为<code>tools.verify.swagger</code>和<code>tools.verify.mockgen</code>定义规则，很麻烦，后面修改也困难。<p>另外，这里也能看出<code>tools.verify.%</code>这种命名方式的好处：<code>tools</code>说明依赖的定义位于<code>scripts/make-rules/tools.mk</code> <code>Makefile</code> 中；<code>verify</code>说明<code>tools.verify.%</code>伪目标属于<code>verify</code>分类，主要用来验证工具是否安装。通过这种命名方式，你可以很容易地知道目标位于哪个 <code>Makefile</code> 文件中，以及想要完成的功能。<p>另外，上面的定义中还用到了自动变量<code>$*</code>，用来指代被匹配的值<code>swagger</code>、<code>mockgen</code>。<h3 id=技巧2：善用函数><a class=headerlink href=#技巧2：善用函数 title=技巧2：善用函数></a>技巧2：善用函数</h3><p><code>Makefile</code> 自带的函数能够帮助我们实现很多强大的功能。所以，在我们编写 <code>Makefile</code> 的过程中，如果有功能需求，可以优先使用这些函数。我把常用的函数以及它们实现的功能整理在了 <a href=https://github.com/marmotedu/geekbang-go/blob/master/makefile/Makefile%E5%B8%B8%E7%94%A8%E5%87%BD%E6%95%B0%E5%88%97%E8%A1%A8.md rel=noopener target=_blank> <code>Makefile</code> 常用函数列表</a> 中，你可以参考下。<p>IAM的 <code>Makefile</code> 文件中大量使用了上述函数，如果你想查看这些函数的具体使用方法和场景，可以参考IAM项目的 <code>Makefile</code> 文件 <a href=https://github.com/marmotedu/iam/tree/master/scripts/make-rules rel=noopener target=_blank>make-rules</a>。<h3 id=技巧3：依赖需要用到的工具><a class=headerlink href=#技巧3：依赖需要用到的工具 title=技巧3：依赖需要用到的工具></a>技巧3：依赖需要用到的工具</h3><p>如果 <code>Makefile</code> 某个目标的命令中用到了某个工具，可以将该工具放在目标的依赖中。这样，当执行该目标时，就可以指定检查系统是否安装该工具，如果没有安装则自动安装，从而实现更高程度的自动化。例如，<code>/</code> <code>Makefile</code> 文件中，<code>format</code>伪目标，定义如下：<pre class="line-numbers language-makefile" data-language=makefile><code class=language-makefile><span class="token builtin-target builtin">.PHONY</span><span class="token punctuation">:</span> format
<span class="token target symbol">format</span><span class="token punctuation">:</span> tools.verify.golines tools.verify.goimports
	<span class="token operator">@</span>echo <span class="token string">"===========> Formating codes"</span>
	<span class="token operator">@</span><span class="token variable">$</span><span class="token punctuation">(</span>FIND<span class="token punctuation">)</span> -type f -name <span class="token string">'.go'</span> <span class="token operator">|</span> <span class="token variable">$</span><span class="token punctuation">(</span>XARGS<span class="token punctuation">)</span> gofmt -s -w
	<span class="token operator">@</span><span class="token variable">$</span><span class="token punctuation">(</span>FIND<span class="token punctuation">)</span> -type f -name <span class="token string">'.go'</span> <span class="token operator">|</span> <span class="token variable">$</span><span class="token punctuation">(</span>XARGS<span class="token punctuation">)</span> goimports -w -local <span class="token variable">$</span><span class="token punctuation">(</span>ROOTPACKAGE<span class="token punctuation">)</span>
	<span class="token operator">@</span><span class="token variable">$</span><span class="token punctuation">(</span>FIND<span class="token punctuation">)</span> -type f -name <span class="token string">'.go'</span> <span class="token operator">|</span> <span class="token variable">$</span><span class="token punctuation">(</span>XARGS<span class="token punctuation">)</span> golines -w --max-len<span class="token operator">=</span>120 --reformat-tags --shorten-comments --ignore-generated .
	<span class="token operator">@</span><span class="token variable">$</span><span class="token punctuation">(</span>GO<span class="token punctuation">)</span> mod edit -fmt<span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>你可以看到，<code>format</code>依赖<code>tools.verify.golines tools.verify.goimports</code>。我们再来看下<code>tools.verify.golines</code>的定义：<pre class="line-numbers language-makefile" data-language=makefile><code class=language-makefile><span class="token target symbol">tools.verify.%</span><span class="token punctuation">:</span>
	<span class="token operator">@</span>if ! which $ &>/dev/null<span class="token punctuation">;</span> then <span class="token variable">$</span><span class="token punctuation">(</span>MAKE<span class="token punctuation">)</span> tools.install.<span class="token variable">$;</span> fi<span aria-hidden=true class=line-numbers-rows><span></span><span></span></span></code></pre><p>再来看下<code>tools.install.$</code>规则：<pre class="line-numbers language-makefile" data-language=makefile><code class=language-makefile><span class="token builtin-target builtin">.PHONY</span><span class="token punctuation">:</span> install.golinesinstall.golines<span class="token punctuation">:</span>
	<span class="token operator">@</span><span class="token variable">$</span><span class="token punctuation">(</span>GO<span class="token punctuation">)</span> get -u github.com/segmentio/golines<span aria-hidden=true class=line-numbers-rows><span></span><span></span></span></code></pre><p>通过<code>tools.verify.%</code>规则定义，我们可以知道，<code>tools.verify.%</code>会先检查工具是否安装，如果没有安装，就会执行<code>tools.install.$*</code>来安装。如此一来，当我们执行<code>tools.verify.%</code>目标时，如果系统没有安装golines命令，就会自动调用<code>go get</code>安装，提高了 <code>Makefile</code> 的自动化程度。<h3 id=技巧4：把常用功能放在-x2F-Makefile-中，不常用的放在分类-Makefile-中><a title="技巧4：把常用功能放在/ Makefile 中，不常用的放在分类 Makefile 中" class=headerlink href=#技巧4：把常用功能放在-x2F-Makefile-中，不常用的放在分类-Makefile-中></a>技巧4：把常用功能放在/ <code>Makefile</code> 中，不常用的放在分类 <code>Makefile</code> 中</h3><p>一个项目，尤其是大型项目，有很多需要管理的地方，其中大部分都可以通过 <code>Makefile</code> 实现自动化操作。不过，为了保持/ <code>Makefile</code> 文件的整洁性，我们不能把所有的命令都添加在/ <code>Makefile</code> 文件中。<p>一个比较好的建议是，将常用功能放在/ <code>Makefile</code> 中，不常用的放在分类 <code>Makefile</code> 中，并在/ <code>Makefile</code> 中include这些分类 <code>Makefile</code> 。<p>例如，IAM项目的/ <code>Makefile</code> 集成了<code>format</code>、<code>lint</code>、<code>test</code>、<code>build</code>等常用命令，而将<code>gen.errcode.code</code>、<code>gen.errcode.doc</code>这类不常用的功能放在<code>scripts/make-rules/gen.mk</code>文件中。当然，我们也可以直接执行 <code>make gen.errcode.code</code>来执行<code>gen.errcode.code</code>伪目标。通过这种方式，既可以保证/ <code>Makefile</code> 的简洁、易维护，又可以通过<code>make</code>命令来运行伪目标，更加灵活。<h3 id=技巧5：编写可扩展的-Makefile><a title="技巧5：编写可扩展的 Makefile" class=headerlink href=#技巧5：编写可扩展的-Makefile></a>技巧5：编写可扩展的 <code>Makefile</code></h3><p>什么叫可扩展的 <code>Makefile</code> 呢？在我看来，可扩展的 <code>Makefile</code> 包含两层含义：<ol><li>可以在不改变 <code>Makefile</code> 结构的情况下添加新功能。<li>扩展项目时，新功能可以自动纳入到 <code>Makefile</code> 现有逻辑中。</ol><p>其中的第一点，我们可以通过设计合理的 <code>Makefile</code> 结构来实现。要实现第二点，就需要我们在编写 <code>Makefile</code> 时采用一定的技巧，例如多用通配符、自动变量、函数等。这里我们来看一个例子，可以让你更好地理解。<p>在我们IAM实战项目的<a href=https://github.com/marmotedu/iam/blob/v1.0.0/scripts/make-rules/golang.mk#L34 rel=noopener target=_blank>golang.mk</a>中，执行 <code>make go.build</code> 时能够构建cmd/目录下的所有组件，也就是说，当有新组件添加时， <code>make go.build</code> 仍然能够构建新增的组件，这就实现了上面说的第二点。<p>具体实现方法如下：<pre class="line-numbers language-makefile" data-language=makefile><code class=language-makefile>COMMANDS <span class="token operator">?=</span> <span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">filter-out</span> %.md, <span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">wildcard</span> <span class="token variable">$/cmd/</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
BINS <span class="token operator">?=</span> <span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">foreach</span> cmd,<span class="token variable">$,$</span><span class="token punctuation">(</span><span class="token function">notdir</span> $<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token builtin-target builtin">.PHONY</span><span class="token punctuation">:</span> go.build
<span class="token target symbol">go.build</span><span class="token punctuation">:</span> go.build.verify <span class="token variable">$</span><span class="token punctuation">(</span>addprefix go.build., <span class="token variable">$</span><span class="token punctuation">(</span>addprefix <span class="token variable">$</span><span class="token punctuation">(</span>PLATFORM<span class="token punctuation">)</span>., <span class="token variable">$</span><span class="token punctuation">(</span>BINS<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token builtin-target builtin">.PHONY</span><span class="token punctuation">:</span> go.build.%


<span class="token target symbol">go.build.%</span><span class="token punctuation">:</span>
		<span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">eval</span> COMMAND <span class="token operator">:=</span> <span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">word</span> 2,<span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">subst</span> ., ,$<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">eval</span> PLATFORM <span class="token operator">:=</span> <span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">word</span> 1,<span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">subst</span> ., ,$<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">eval</span> OS <span class="token operator">:=</span> <span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">word</span> 1,<span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">subst</span> _, ,<span class="token variable">$</span><span class="token punctuation">(</span>PLATFORM<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">eval</span> ARCH <span class="token operator">:=</span> <span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">word</span> 2,<span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">subst</span> _, ,<span class="token variable">$</span><span class="token punctuation">(</span>PLATFORM<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token operator">@</span>echo <span class="token string">"===========> Building binary $(COMMAND) $(VERSION) for $(OS) $(ARCH)"</span>
		<span class="token operator">@</span>mkdir -p <span class="token variable">$</span><span class="token punctuation">(</span>OUTPUT_DIR<span class="token punctuation">)</span>/platforms/<span class="token variable">$</span><span class="token punctuation">(</span>OS<span class="token punctuation">)</span>/<span class="token variable">$</span><span class="token punctuation">(</span>ARCH<span class="token punctuation">)</span>
		<span class="token operator">@</span>CGO_ENABLED<span class="token operator">=</span>0 GOOS<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span>OS<span class="token punctuation">)</span> GOARCH<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span>ARCH<span class="token punctuation">)</span> <span class="token variable">$</span><span class="token punctuation">(</span>GO<span class="token punctuation">)</span> build <span class="token variable">$</span><span class="token punctuation">(</span>GO_BUILD_FLAGS<span class="token punctuation">)</span> -o <span class="token variable">$</span><span class="token punctuation">(</span>OUTPUT_DIR<span class="token punctuation">)</span>/platforms/<span class="token variable">$</span><span class="token punctuation">(</span>OS<span class="token punctuation">)</span>/<span class="token variable">$</span><span class="token punctuation">(</span>ARCH<span class="token punctuation">)</span>/<span class="token variable">$</span><span class="token punctuation">(</span>COMMAND<span class="token punctuation">)</span><span class="token variable">$</span><span class="token punctuation">(</span>GO_OUT_EXT<span class="token punctuation">)</span> <span class="token variable">$</span><span class="token punctuation">(</span>ROOT_PACKAGE<span class="token punctuation">)</span>/cmd/<span class="token variable">$</span><span class="token punctuation">(</span>COMMAND<span class="token punctuation">)</span>
<span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>当执行<code>make go.build</code> 时，会执行go.build的依赖 <code>$(addprefix go.build., $(addprefix $(PLATFORM)., $(BINS)))</code> ,<code>addprefix</code>函数最终返回字符串 <code>go.build.linux_amd64.iamctl go.build.linux_amd64.iam-authz-server go.build.linux_amd64.iam-apiserver ...</code> ，这时候就会执行 <code>go.build.%</code> 伪目标。<p>在 <code>go.build.%</code> 伪目标中，通过<code>eval</code>、<code>word</code>、<code>subst</code>函数组合，算出了<code>COMMAND</code>的值 <code>iamctl/iam-apiserver/iam-authz-server/...</code>，最终通过 <code>$(ROOT_PACKAGE)/cmd/$(COMMAND)</code> 定位到需要构建的组件的<code>main</code>函数所在目录。<p>上述实现中有两个技巧，你可以注意下。首先，通过<pre class="line-numbers language-makefile" data-language=makefile><code class=language-makefile>COMMANDS <span class="token operator">?=</span> <span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">filter-out</span> %.md, <span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">wildcard</span> <span class="token variable">$/cmd/*</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
BINS <span class="token operator">?=</span> <span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">foreach</span> cmd,<span class="token variable">$,$</span><span class="token punctuation">(</span><span class="token function">notdir</span> $<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden=true class=line-numbers-rows><span></span><span></span></span></code></pre><p>获取到了<code>cmd/</code>目录下的所有组件名。<p>接着，通过使用通配符和自动变量，自动匹配到<code>go.build.linux_amd64.iam-authz-server</code> 这类伪目标并构建。<p>可以看到，想要编写一个可扩展的 <code>Makefile</code> ，熟练掌握 <code>Makefile</code> 的用法是基础，更多的是需要我们动脑思考如何去编写 <code>Makefile</code> 。<h3 id=技巧6：将所有输出存放在一个目录下，方便清理和查找><a class=headerlink href=#技巧6：将所有输出存放在一个目录下，方便清理和查找 title=技巧6：将所有输出存放在一个目录下，方便清理和查找></a>技巧6：将所有输出存放在一个目录下，方便清理和查找</h3><p>在执行 <code>Makefile</code> 的过程中，会输出各种各样的文件，例如 <code>Go</code> 编译后的<code>二进制文件</code>、<code>测试覆盖率数据</code>等，我建议你把这些文件统一放在一个目录下，方便后期的清理和查找。通常我们可以把它们放在<code>_output</code>这类目录下，这样清理时就很方便，只需要清理<code>_output</code>文件夹就可以，例如：<pre class="line-numbers language-makefile" data-language=makefile><code class=language-makefile><span class="token builtin-target builtin">.PHONY</span><span class="token punctuation">:</span> go.cleango.clean<span class="token punctuation">:</span>
	<span class="token operator">@</span>echo <span class="token string">"===========> Cleaning all build output"</span>
	<span class="token operator">@</span>-rm -vrf <span class="token variable">$</span><span class="token punctuation">(</span>OUTPUT_DIR<span class="token punctuation">)</span><span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span></span></code></pre><p>这里要注意，要用<code>-rm</code>，而不是<code>rm</code>，防止在没有<code>_output</code>目录时，执行<code>make go.clean</code>报错。<h3 id=技巧7：使用带层级的命名方式><a class=headerlink href=#技巧7：使用带层级的命名方式 title=技巧7：使用带层级的命名方式></a>技巧7：使用带层级的命名方式</h3><p>通过使用带层级的命名方式，例如<code>tools.verify.swagger</code> ，我们可以实现<strong>目标分组管理</strong>。这样做的好处有很多。首先，当 <code>Makefile</code> 有大量目标时，通过分组，我们可以更好地管理这些目标。其次，分组也能方便理解，可以通过组名一眼识别出该目标的功能类别。最后，这样做还可以大大减小目标重名的概率。<p>例如，IAM项目的 <code>Makefile</code> 就大量采用了下面这种命名方式。<pre class="line-numbers language-makefile" data-language=makefile><code class=language-makefile><span class="token builtin-target builtin">.PHONY</span><span class="token punctuation">:</span> gen.run
<span class="token target symbol">gen.run</span><span class="token punctuation">:</span> gen.clean gen.errcode gen.docgo

<span class="token builtin-target builtin">.PHONY</span><span class="token punctuation">:</span> gen.errcode
<span class="token target symbol">gen.errcode</span><span class="token punctuation">:</span> gen.errcode.code gen.errcode.doc

<span class="token builtin-target builtin">.PHONY</span><span class="token punctuation">:</span> gen.errcode.code
<span class="token target symbol">gen.errcode.code</span><span class="token punctuation">:</span> tools.verify.codegen
		...

<span class="token builtin-target builtin">.PHONY</span><span class="token punctuation">:</span> gen.errcode.doc
<span class="token target symbol">gen.errcode.doc</span><span class="token punctuation">:</span> tools.verify.codegen
		...<span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id=技巧8：做好目标拆分><a class=headerlink href=#技巧8：做好目标拆分 title=技巧8：做好目标拆分></a>技巧8：做好目标拆分</h3><p>还有一个比较实用的技巧：我们要合理地拆分目标。比如，我们可以将安装工具拆分成两个目标：验证工具是否已安装和安装工具。通过这种方式，可以给我们的 <code>Makefile</code> 带来更大的灵活性。例如：我们可以根据需要选择性地执行其中一个操作，也可以两个操作一起执行。<p>这里来看一个例子：<pre class="line-numbers language-makefile" data-language=makefile><code class=language-makefile><span class="token target symbol">gen.errcode.code</span><span class="token punctuation">:</span> tools.verify.codegen

<span class="token target symbol">tools.verify.%</span><span class="token punctuation">:</span>
	<span class="token operator">@</span>if ! which <span class="token variable">$*</span> &>/dev/null<span class="token punctuation">;</span> then <span class="token variable">$</span><span class="token punctuation">(</span>MAKE<span class="token punctuation">)</span> tools.install.<span class="token variable">$;</span> fi

<span class="token builtin-target builtin">.PHONY</span><span class="token punctuation">:</span> install.codegeninstall.codegen<span class="token punctuation">:</span>
	<span class="token operator">@</span><span class="token variable">$</span><span class="token punctuation">(</span>GO<span class="token punctuation">)</span> install <span class="token variable">$/tools/codegen/codegen.go</span><span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面的 <code>Makefile</code> 中，<code>gen.errcode.code</code>依赖了<code>tools.verify.codegen</code>，<code>tools.verify.codegen</code>会先检查<code>codegen</code>命令是否存在，如果不存在，再调用<code>install.codegen</code>来安装<code>codegen</code>工具。<p>如果我们的 <code>Makefile</code> 设计是：<pre class="line-numbers language-makefile" data-language=makefile><code class=language-makefile><span class="token target symbol">gen.errcode.code</span><span class="token punctuation">:</span> install.codegen<span aria-hidden=true class=line-numbers-rows><span></span></span></code></pre><p>那每次执行<code>gen.errcode.code</code>都要重新安装<code>codegen</code>命令，这种操作是不必要的，还会导致 <code>make gen.errcode.code</code> 执行很慢。<h3 id=技巧9：设置OPTIONS><a class=headerlink href=#技巧9：设置OPTIONS title=技巧9：设置OPTIONS></a>技巧9：设置OPTIONS</h3><p>编写 <code>Makefile</code> 时，我们还需要把一些可变的功能通过<code>OPTIONS</code>来控制。为了帮助你理解，这里还是拿<code>IAM项目</code>的 <code>Makefile</code> 来举例。<p>假设我们需要通过一个选项 <code>V</code> ，来控制是否需要在执行 <code>Makefile</code> 时打印详细的信息。这可以通过下面的步骤来实现。<ol><li>在 <code>/Makefile</code> 中定义 <code>USAGE_OPTIONS</code><br><strong>首先，</strong>在/ <code>Makefile</code> 中定义 <code>USAGE_OPTIONS</code> 。定义 <code>USAGE_OPTIONS</code> 可以使开发者在执行 <code>make help</code> 后感知到此<code>OPTION</code>，并根据需要进行设置。</ol><pre class="line-numbers language-makefile" data-language=makefile><code class=language-makefile><span class="token keyword">define</span> USAGE_OPTIONS

<span class="token target symbol">Options</span><span class="token punctuation">:</span>
	...
	BINS         The binaries to build. Default is all of cmd.
							 ...
	...
	V            Set to 1 enable verbose build. Default is 0.
	<span class="token keyword">endef</span>
	<span class="token keyword">export</span> USAGE_OPTIONS<span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start=2><li>根据 <code>V</code> 选项适配不同的行为<br><strong>接着，</strong>在<a href=https://github.com/marmotedu/iam/blob/master/scripts/make-rules/common.mk#L70 rel=noopener target=_blank>scripts/make-rules/common.mk</a>文件中，我们通过判断有没有设置V选项，来选择不同的行为：</ol><pre class="line-numbers language-makefile" data-language=makefile><code class=language-makefile><span class="token keyword">ifndef</span> V
MAKEFLAGS <span class="token operator">+=</span> --no-print-directory
<span class="token keyword">endif</span><span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span></span></code></pre><p>当然，我们还可以通过下面的方法来使用 <code>V</code> ：<pre class="line-numbers language-makefile" data-language=makefile><code class=language-makefile><span class="token keyword">ifeq</span> <span class="token punctuation">(</span><span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">origin</span> V<span class="token punctuation">)</span>, undefined<span class="token punctuation">)</span>
MAKEFLAGS <span class="token operator">+=</span> --no-print-directory
<span class="token keyword">endif</span><span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span></span></code></pre><p>上面，我介绍了 <code>V</code> <code>OPTION</code>，我们在 <code>Makefile</code> 中通过判断有没有定义 <code>V</code> ，来执行不同的操作。其实还有一种<code>OPTION</code>，这种<code>OPTION</code>的值我们在 <code>Makefile</code> 中是直接使用的，例如<code>BINS</code>。针对这种<code>OPTION</code>，我们可以通过以下方式来使用：<pre class="line-numbers language-makefile" data-language=makefile><code class=language-makefile>BINS <span class="token operator">?=</span> <span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">foreach</span> cmd,<span class="token variable">$,$</span><span class="token punctuation">(</span><span class="token function">notdir</span> $<span class="token punctuation">)</span><span class="token punctuation">)</span>
...
<span class="token target symbol">go.build</span><span class="token punctuation">:</span> go.build.verify <span class="token variable">$</span><span class="token punctuation">(</span>addprefix go.build., <span class="token variable">$</span><span class="token punctuation">(</span>addprefix <span class="token variable">$</span><span class="token punctuation">(</span>PLATFORM<span class="token punctuation">)</span>., <span class="token variable">$</span><span class="token punctuation">(</span>BINS<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span></span></code></pre><p>也就是说，通过 <strong><code>?=</code></strong> 来判断 <code>BINS</code> 变量有没有被赋值，如果没有，则赋予等号后的值。接下来，就可以在 <code>Makefile</code> 规则中使用它。<h3 id=技巧10：定义环境变量><a class=headerlink href=#技巧10：定义环境变量 title=技巧10：定义环境变量></a>技巧10：定义环境变量</h3><p>我们可以在 <code>Makefile</code> 中定义一些环境变量，例如：<pre class="line-numbers language-makefile" data-language=makefile><code class=language-makefile>GO <span class="token operator">:=</span> go
GO_SUPPORTED_VERSIONS <span class="token operator">?=</span> 1.13<span class="token operator">|</span>1.14<span class="token operator">|</span>1.15<span class="token operator">|</span>1.16<span class="token operator">|</span>1.17
GO_LDFLAGS <span class="token operator">+=</span> -X <span class="token variable">$</span><span class="token punctuation">(</span>VERSION_PACKAGE<span class="token punctuation">)</span>.GitVersion<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span>VERSION<span class="token punctuation">)</span> \
		-X <span class="token variable">$</span><span class="token punctuation">(</span>VERSION_PACKAGE<span class="token punctuation">)</span>.GitCommit<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span>GIT_COMMIT<span class="token punctuation">)</span>	\
		-X <span class="token variable">$</span><span class="token punctuation">(</span>VERSION_PACKAGE<span class="token punctuation">)</span>.GitTreeState<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span>GIT_TREE_STATE<span class="token punctuation">)</span> \
		-X <span class="token variable">$</span><span class="token punctuation">(</span>VERSION_PACKAGE<span class="token punctuation">)</span>.BuildDate<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">shell</span> date -u +<span class="token string">'%Y-%m-%dT%H:%M:%SZ'</span><span class="token punctuation">)</span>

<span class="token keyword">ifneq</span> <span class="token punctuation">(</span><span class="token variable">$</span><span class="token punctuation">(</span>DLV<span class="token punctuation">)</span>,<span class="token punctuation">)</span>                                                                                                                          					GO_BUILD_FLAGS <span class="token operator">+=</span> -gcflags <span class="token string">"all=-N -l"</span>
LDFLAGS <span class="token operator">=</span> <span class="token string">""</span>
<span class="token keyword">endif</span>

GO_BUILD_FLAGS <span class="token operator">+=</span> -tags<span class="token operator">=</span>jsoniter -ldflags <span class="token string">"$(GO_LDFLAGS)"</span>
...
FIND <span class="token operator">:=</span> find . ! -path <span class="token string">'./third_party/'</span> ! -path <span class="token string">'./vendor/'</span>
XARGS <span class="token operator">:=</span> xargs --no-run-if-empty<span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这些环境变量和编程中使用宏定义的作用是一样的：只要修改一处，就可以使很多地方同时生效，避免了重复的工作。<p>通常，我们可以将<code>GO</code>、<code>GO_BUILD_FLAGS</code>、<code>FIND</code>这类变量定义为环境变量。<h3 id=技巧11：自己调用自己><a class=headerlink href=#技巧11：自己调用自己 title=技巧11：自己调用自己></a>技巧11：自己调用自己</h3><p>在编写 <code>Makefile</code> 的过程中，你可能会遇到这样一种情况：<code>A-Target</code>目标命令中，需要完成操作<code>B-Action</code>，而操作<code>B-Action</code>我们已经通过伪目标<code>B-Target</code>实现过。为了达到最大的代码复用度，这时候最好的方式是在<code>A-Target</code>的命令中执行<code>B-Target</code>。方法如下：<pre class="line-numbers language-makefile" data-language=makefile><code class=language-makefile><span class="token target symbol">tools.verify.%</span><span class="token punctuation">:</span>
	<span class="token operator">@</span>if ! which $ &>/dev/null<span class="token punctuation">;</span> then <span class="token variable">$</span><span class="token punctuation">(</span>MAKE<span class="token punctuation">)</span> tools.install.<span class="token variable">$;</span> fi<span aria-hidden=true class=line-numbers-rows><span></span><span></span></span></code></pre><p>这里，我们通过 <code>$(MAKE)</code> 调用了伪目标 <code>tools.install.$</code> 。要注意的是，默认情况下， <code>Makefile</code> 在切换目录时会输出以下信息：<pre class="line-numbers language-makefile" data-language=makefile><code class=language-makefile>$ make tools.install.codegen
<span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span>> Installing codegen
<span class="token target symbol">make[1]</span><span class="token punctuation">:</span> Entering directory /home/colin/workspace/golang/src/github.com/marmotedu/iam'
<span class="token target symbol">make[1]</span><span class="token punctuation">:</span> Leaving directory/home/colin/workspace/golang/src/github.com/marmotedu/iam'<span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span></span></code></pre><p>如果觉得<strong>Entering directory</strong>这类信息很烦人，可以通过设置 <code>MAKEFLAGS += --no-print-directory</code> 来禁止 <code>Makefile</code> 打印这些信息。<h2 id=总结><a class=headerlink href=#总结 title=总结></a>总结</h2><p>如果你想要高效管理项目，使用 <code>Makefile</code> 来管理是目前的最佳实践。我们可以通过下面的几个方法，来编写一个高质量的 <code>Makefile</code> 。<ol><li><p>需要熟练掌握 <code>Makefile</code> 的语法。我建议你重点掌握以下语法： <code>Makefile</code> 规则语法、伪目标、变量赋值、特殊变量、自动化变量。</p><li><p>需要提前规划 <code>Makefile</code> 要实现的功能。一个大型Go项目通常需要实现以下功能：<code>代码生成类命令</code>、<code>格式化类命令</code>、<code>静态代码检查</code>、 <code>测试类命令</code>、<code>构建类命令</code>、<code>Docker镜像打包类命令</code>、<code>部署类命令</code>、<code>清理类命令</code>，等等。</p><li><p>通过 <code>Makefile</code> 功能分类、<code>文件分层</code>、<code>复杂命令脚本化</code>等方式，来设计一个合理的 <code>Makefile</code> 结构。</p><li><p>需要掌握一些 <code>Makefile</code> 编写技巧，例如：<code>善用通配符</code>、<code>自动变量</code>和<code>函数</code>；编写可扩展的 <code>Makefile</code> ；使用带层级的命名方式，等等。通过这些技巧，可以进一步保证我们编写出一个高质量的 <code>Makefile</code> 。</p></ol></div><footer class=post-footer><div class=post-tags><a href=/tags/Golang/ rel=tag># Golang</a><a href=/tags/IAM/ rel=tag># IAM</a><a href=/tags/Makefile/ rel=tag># Makefile</a></div><div class=post-nav><div class=post-nav-item><a title="06 | 设计模式：Go设计模式" href=/post/2023-golang-practice-%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-06-go-design-model-copy.html rel=prev> <i class="fa fa-chevron-left"></i> 06 | 设计模式：Go设计模式 </a></div><div class=post-nav-item><a title="08 | 研发流程实战：IAM项目是如何进行研发流程管理" href=/post/2023-golang-practice-%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-08-develop-process.html rel=next> 08 | 研发流程实战：IAM项目是如何进行研发流程管理 <i class="fa fa-chevron-right"></i> </a></div></div></footer></article></div></div></main><footer class=footer><div class=footer-inner><div class=copyright>© <span itemprop=copyrightYear>2024</span><span class=with-love> <i class="fa fa-heart"></i> </span><span class=author itemprop=copyrightHolder>gzwillyy</span></div></div></footer><div aria-label=返回顶部 class=back-to-top role=button><i class="fa fa-arrow-up fa-lg"></i><span>0%</span></div><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><script crossorigin=anonymous integrity=sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY= src=https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js></script><script src=/js/comments.js></script><script src=/js/utils.js></script><script src=/js/motion.js></script><script src=/js/next-boot.js></script><script crossorigin=anonymous integrity=sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc= src=https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js></script><script src=/js/third-party/search/local-search.js></script>